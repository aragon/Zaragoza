import{y as K,u as re,Y as Ve,G as ge,q as e,as as ce,ea as As,I as ne,bY as Be,aD as Ts,at as ke,bZ as Ds,eb as xs,S as oe,t as X,W as ze,V as Ns,w as Oe,_ as Re,e as je,ec as we,ed as Es,aV as as,bo as os,aW as He,bp as Ls,ee as ks,j as Ae,az as ns,ef as Os,a0 as P,eg as de,eh as Is,ae as rs,a8 as is,aa as ls,ei as qe,Q as Vs,f as cs,aM as Rs,ar as Ee,L as ds,bc as js,ej as F,ek as Us,z as ve,el as _s,dB as Ms,em as Gs,a9 as Fs,en as $s,eo as Ws,dC as Ce,ep as Bs,eq as zs,h as Hs,bh as qs,ac as Ks,am as Qs,bw as Ys,bJ as Xs,er as Js,bK as Zs,e8 as et,es as st,et as tt,eu as at,cb as ot,ev as nt,di as rt,ew as it,ex as lt,dr as ct,ey as Ke,ez as Qe,eA as Ye,cw as ue,eB as dt,eC as ut,eD as pt,eE as gt,R as mt,b9 as ft,bu as bt,cj as Xe,cx as Je,cp as Le,dR as Pt,eF as yt,cu as Ze,eG as St,F as he,eH as es,eI as ht}from"./main-1e616d6f.js";import{u as us,S as ps,r as p,E as vt}from"./tiptap-313d156f.js";import{A as Ct}from"./index-b80a0dc5.js";import{M as gs}from"./index-b5e6cc73.js";import{u as wt}from"./useTokenSupply-9a8f8b12.js";import{a as At}from"./query-keys-5b13e665.js";import{I as Tt,ag as Dt,a6 as ss}from"./osx-ethers-780b73f3.js";const aa=()=>{const{t}=re(),{address:a,ensAvatarUrl:o}=Ve(),{control:n}=ge();return e.jsxs(e.Fragment,{children:[e.jsxs(pe,{children:[e.jsx(ce,{label:t("labels.author")}),e.jsx(As,{label:"You",src:o||a,isConnected:!0,disabled:!0})]}),e.jsxs(pe,{children:[e.jsx(ce,{label:t("newWithdraw.defineProposal.title")}),e.jsx(ne,{name:"proposalTitle",defaultValue:"",control:n,rules:{required:t("errors.required.title"),validate:i=>Be(i)?t("errors.required.title"):!0},render:({field:{name:i,onBlur:r,onChange:c,value:m},fieldState:{error:g}})=>e.jsxs(e.Fragment,{children:[e.jsx(Ts,{name:i,value:m,onBlur:r,onChange:c,placeholder:t("newWithdraw.defineProposal.titlePlaceholder")}),g?.message&&e.jsx(ke,{message:g.message,variant:"critical"})]})})]}),e.jsxs(pe,{children:[e.jsx(ce,{label:t("labels.summary")}),e.jsx(ne,{name:"proposalSummary",control:n,rules:{required:t("errors.required.summary"),validate:i=>Be(i)?t("errors.required.summary"):!0},render:({field:{name:i,onBlur:r,onChange:c,value:m},fieldState:{error:g}})=>e.jsxs(e.Fragment,{children:[e.jsx(Ds,{name:i,value:m,onBlur:r,onChange:c,placeholder:t("newWithdraw.defineProposal.summaryPlaceholder")}),g?.message&&e.jsx(ke,{message:g.message,variant:"critical"})]})})]}),e.jsxs(pe,{children:[e.jsx(ce,{label:t("newWithdraw.defineProposal.body"),isOptional:!0}),e.jsx(ne,{name:"proposal",control:n,render:({field:{name:i,onBlur:r,onChange:c,value:m}})=>e.jsx(xs,{name:i,value:m,onBlur:r,onChange:c,placeholder:t("newWithdraw.defineProposal.proposalPlaceholder")})})]}),e.jsxs(pe,{children:[e.jsx(ce,{label:t("labels.resources"),helpText:t("labels.resourcesHelptext"),isOptional:!0}),e.jsx(Ct,{buttonPlusIcon:!0,buttonLabel:t("labels.addResource")})]})]})};function oa(t,a,o,n,i){return o==="os-update"&&(n?.os||n?.plugin)?!(n?.plugin&&!i):!(!t.proposalTitle||!t.proposalSummary||a.proposalTitle||a.proposalSummary)}const pe=K.div.attrs({className:"space-y-3"})``,xt={multiSelect:{active:e.jsx(oe,{icon:X.CHECKBOX_SELECTED}),default:e.jsx(oe,{icon:X.CHECKBOX}),error:e.jsx(oe,{icon:X.CHECKBOX})},radio:{active:e.jsx(oe,{icon:X.RADIO_SELECTED}),default:e.jsx(oe,{icon:X.RADIO}),error:e.jsx(oe,{icon:X.RADIO})}},Ie=({label:t,linkLabel:a,releaseNote:o,tagLabelNatural:n,tagLabelInfo:i,disabled:r=!1,type:c="default",multiSelect:m=!1,buttonPrimaryLabel:g,buttonSecondaryLabel:y,onClick:S,onClickActionPrimary:d,onClickActionSecondary:x})=>{const j=us({editable:!1,extensions:[ps,gs]});return p.useEffect(()=>{j?.commands.setContent(o?.summary??"")},[j,o]),e.jsx(Nt,{"data-testid":"checkboxListItem",type:c,disabled:r,onClick:S,children:e.jsxs(Et,{children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsxs(Lt,{disabled:r,type:c,children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("p",{className:"font-semibold ft-text-base",children:t}),n&&e.jsx(ze,{label:n}),i&&e.jsx(ze,{label:i,variant:"info"})]}),xt[m?"multiSelect":"radio"][c]]}),e.jsx(kt,{children:e.jsx(vt,{editor:j})}),e.jsx("span",{children:e.jsx(Ns,{label:a,iconRight:X.LINK_EXTERNAL,href:o?.html_url})})]}),(g||y)&&e.jsxs("div",{className:"mt-6 flex flex-col gap-y-3 md:flex-row",children:[y&&e.jsx(Oe,{variant:"tertiary",disabled:r,size:"md",onClick:x,children:y}),g&&e.jsx(Oe,{variant:"primary",disabled:r,size:"md",onClick:d,children:g})]})]})})},Nt=K.div.attrs(({disabled:t,type:a})=>({className:`flex-1 py-3 px-4 rounded-xl border-2 focus:outline-none focus-visible:ring focus-visible:ring-primary w-full ${t?"bg-neutral-100 border-neutral-300":`bg-neutral-0 group hover:border-primary-500 cursor-pointer ${a==="error"?"border-critical-500":a!=="default"?"border-primary-500":"border-neutral-100"}`}`,tabIndex:t?-1:0}))``,Et=K.div.attrs({className:"flex flex-col justify-between h-full"})``,Lt=K.div.attrs(({disabled:t,type:a})=>({className:`flex justify-between items-center group-hover:text-primary-500 space-x-3 ${t||a==="default"||a==="error"?"text-neutral-600":"text-primary-500"}`}))``,kt=K.p.attrs({className:"ft-text-base text-neutral-500 mr-7"})``;async function Ot(t,a,o,n){He(t!=null,"fetchPreparedList: client is not defined"),He(n!=null,"fetchPreparedList: pluginRepoAddress is not defined");const i=await t.methods.getPluginPreparations({limit:10,skip:0,direction:Ls.ASC,sortBy:ks.ID,pluginAddress:o,daoAddressOrEns:a,pluginRepoAddress:n}),r=new Map;return(i??[]).map(c=>{c.type==="Update"&&r.set(`${c.versionTag.release}.${c.versionTag.build}`,c)}),r}const It=(t,a={})=>{const{client:o}=Re(),{network:n}=je(),{data:i}=we(t.daoAddressOrEns);let r;return t.pluginType&&i&&(r=Es(n,t.pluginType,i)),(!r||!t.pluginAddress||!o)&&(a.enabled=!1),as(os.preparedPlugins(t),()=>Ot(o,t.daoAddressOrEns,t.pluginAddress,r),a)},Vt={showModal:{open:!1,type:""},pluginList:null,osxList:null},Rt=(t,a)=>{switch(a.type){case"setShowModal":return{...t,showModal:a.payload};case"setPreparationProcessState":return{...t,preparationProcessState:a.payload};case"setDaoUpdateData":return{...t,daoUpdateData:a.payload};case"setPluginAvailableVersions":return{...t,pluginList:a.payload};case"setOSXAvailableVersions":return{...t,osxList:a.payload};default:return t}},ms=p.createContext(null),na=({children:t})=>{const{t:a}=re(),{isOnWrongNetwork:o}=Ve(),[n,i]=p.useReducer(Rt,Vt),{data:r,isLoading:c}=Ae(),m=r?.plugins?.[0]?.id,g=r?.address,{client:y}=Re(),S=ns(m),{data:d}=Os({pluginType:m,daoAddress:g}),{data:x}=we(g),{data:j}=It({pluginType:m,pluginAddress:r?.plugins?.[0]?.instanceAddress,daoAddressOrEns:g}),{getValues:v,setValue:_}=ge(),E=v("pluginSelectedVersion"),A=n.daoUpdateData!==void 0&&n.preparationProcessState===P.WAITING,V=!n.daoUpdateData&&n.preparationProcessState!==P.SUCCESS;p.useEffect(()=>{if(x){const M=new Map;Object.keys(de).forEach(s=>{Is(de[s],x.join("."))===1&&(M.set(de[s],{version:de[s],...s==="LATEST"&&{isLatest:!0}}),s==="LATEST"&&_("osSelectedVersion",{version:de[s]}))}),i({type:"setOSXAvailableVersions",payload:M})}},[_,x]),p.useEffect(()=>{if(r&&d?.releases&&j){const M=new Map;d.releases.forEach((s,C)=>{s.builds.sort((u,B)=>u.build>B.build?1:-1),s.builds.forEach((u,B)=>{if(s.release>=r.plugins[0].release&&u.build>r.plugins[0].build){const me=`${s.release}.${u.build}`;M.set(me,{version:{build:u.build,release:s.release},...j.has(me)&&{isPrepared:!0,preparedData:{...j.get(`${s.release}.${u.build}`)}},...C===d.releases.length-1&&B===s.builds.length-1&&{isLatest:!0}}),_("pluginSelectedVersion",{version:{build:s.builds[s.builds.length-1].build,release:s.release},isPrepared:!!j.has(`${s.release}.${s.builds[s.builds.length-1].build}`)})}})}),i({type:"setPluginAvailableVersions",payload:M})}},[r,d?.releases,j,_]);const O=async M=>{c||(i({type:"setPreparationProcessState",payload:P.WAITING}),i({type:"setDaoUpdateData",payload:{daoAddressOrEns:r.address,pluginAddress:r?.plugins?.[0].instanceAddress,pluginRepo:d?.address,newVersion:E?.version}}),i({type:"setShowModal",payload:{open:!0,type:M}}))},h=async()=>{if(n.preparationProcessState===P.SUCCESS){f();return}if(!n.daoUpdateData||n.preparationProcessState===P.LOADING){console.log("Transaction is running");return}if(o){open("network"),f();return}await J()},f=()=>{switch(n.preparationProcessState){case P.LOADING:break;case P.SUCCESS:default:i({type:"setShowModal",payload:{...n.showModal,open:!1}}),z()}},I=p.useCallback(async()=>{if(n.daoUpdateData){if(n.showModal.type==="plugin"&&m!==rs)return S?.estimation.prepareUpdate(n.daoUpdateData);y?.estimation.prepareUpdate(n.daoUpdateData)}},[y?.estimation,S,m,n.daoUpdateData,n.showModal.type]),{tokenPrice:L,maxFee:l,averageFee:D,stopPolling:z,error:G}=is(I,A),J=async()=>{if(i({type:"setPreparationProcessState",payload:P.LOADING}),!y||!n.daoUpdateData)throw new Error("SDK client is not initialized correctly");const M=y?.methods.prepareUpdate(n.daoUpdateData);if(!M)throw new Error("deposit function is not initialized correctly");try{for await(const s of M)switch(s.key){case qe.PREPARING:console.log(s.txHash);break;case qe.DONE:{const C=n.pluginList,u={permissions:s.permissions,pluginAddress:s.pluginAddress,pluginRepo:s.pluginRepo,initData:s.initData,helpers:s.helpers,versionTag:s.versionTag};C?.set(`${s.versionTag.release}.${s.versionTag.build}`,{...n.pluginList.get(`${s.versionTag.release}.${s.versionTag.build}`),version:s.versionTag,isPrepared:!0,preparedData:u}),i({type:"setPluginAvailableVersions",payload:C}),_("pluginSelectedVersion",{version:s.versionTag,isPrepared:!0}),i({type:"setDaoUpdateData"}),i({type:"setPreparationProcessState",payload:P.SUCCESS})}break}}catch(s){console.log(s),i({type:"setPreparationProcessState",payload:P.ERROR})}},Z={[P.SUCCESS]:a("TransactionModal.goToProposal"),[P.WAITING]:a("update.modalPreparePlugin.ctaLabel")};return e.jsxs(ms.Provider,{value:{handlePreparePlugin:O,availablePluginVersions:n.pluginList,availableOSxVersions:n.osxList},children:[t,e.jsx(ls,{state:n.preparationProcessState??P.WAITING,isOpen:n.showModal.open,onClose:f,callback:h,closeOnDrag:n.preparationProcessState!==P.LOADING,maxFee:l,averageFee:D,gasEstimationError:G,tokenPrice:L,title:a("update.modalPreparePlugin.title"),subtitle:a("update.modalPreparePlugin.desc"),buttonStateLabels:Z,disabledCallback:V})]})};function fs(){return p.useContext(ms)}class jt{constructor(){this.latestRelease="1.3.0",this.getProtocolUpdateLabel=a=>{const o=Array.isArray(a)?a.join("."):a;return o?`Aragon OSx v${o}`:void 0},this.getPluginVersion=a=>{const{release:o,build:n}=a??{};return o?`${o}.${n}`:void 0},this.getPluginUpdateLabel=(a,o)=>{const n=this.getPluginVersion(a);return n?`${o} v${n}`:void 0},this.getReleaseNotes=({releases:a,version:o,isPlugin:n})=>{if(o==null)return;const i=typeof o=="string"?o:this.getPluginVersion(o);return a?.find(c=>c.tag_name.includes(n?this.latestRelease:i))}}}const U=new jt,Ut=/(?<=## Summary)(.*?)(?=#{2,}|$)/,_t=t=>{const a=t.body.replace(/\r\n/g," "),o=Ut.exec(a)?.[0].trim()??"";return{...t,summary:o}},Mt=async()=>(await(await fetch("https://api.github.com/repos/aragon/osx/releases")).json()).map(_t),bs=(t={})=>as(os.releaseNotes(),()=>Mt(),t),Gt=({showModal:t,handleCloseMenu:a})=>{const{t:o}=re(),{control:n}=ge(),{availableOSxVersions:i,availablePluginVersions:r}=fs(),{data:c}=bs(),m=p.useMemo(()=>{const y=[];return i?.forEach(S=>{y.push({label:U.getProtocolUpdateLabel(S.version),releaseNote:U.getReleaseNotes({releases:c,version:S.version}),version:S.version,...!!S.isLatest&&{isLatest:!0,tagLabelNatural:o("update.item.tagLatest")}})}),y},[i,c,o]),g=p.useMemo(()=>{const y=[];return r?.forEach(S=>{y.push({label:U.getPluginUpdateLabel(S.version),version:S.version,releaseNote:U.getReleaseNotes({releases:c,version:S.version,isPlugin:!0}),...S.isLatest&&{isLatest:!0,tagLabelNatural:o("update.item.tagLatest")},...S.isPrepared&&{isPrepared:!0,tagLabelInfo:o("update.item.tagPrepared")}})}),y},[r,c,o]);return e.jsx(Vs,{onClose:a,isOpen:t.isOpen,title:o("update.modalVersion.title"),subtitle:o("update.modalVersion.desc"),children:e.jsxs("div",{className:"grid gap-y-3 px-2 py-3",children:[t.type==="os"&&e.jsx(ne,{name:"osSelectedVersion",control:n,render:({field:{onChange:y,value:S}})=>e.jsx(e.Fragment,{children:e.jsx(ts,{children:m.map((d,x)=>p.createElement(Ie,{...d,key:x,type:S?.version===d.version?"active":"default",linkLabel:o("update.item.releaseNotesLabel"),onClick:()=>y({version:d.version,isLatest:d.isLatest})}))})})}),t.type==="plugin"&&e.jsx(ne,{name:"pluginSelectedVersion",rules:{required:"Validate"},control:n,render:({field:{onChange:y,value:S}})=>e.jsx(e.Fragment,{children:e.jsx(ts,{children:g.map((d,x)=>p.createElement(Ie,{...d,key:x,type:S?.version.build===d.version.build?"active":"default",linkLabel:o("update.item.releaseNotesLabel"),onClick:()=>y({version:d.version,isLatest:d.isLatest,isPrepared:d.isPrepared})}))})})}),e.jsx(Ft,{children:e.jsx(Oe,{variant:"primary",size:"lg",onClick:a,children:o("update.modalVersion.ctaLabel")})})]})})},ts=K.div.attrs({className:"grid gap-y-1.5"})``,Ft=K.div.attrs({className:"grid gap-y-1.5"})``,ra=()=>{const[t,a]=p.useState({type:"none",isOpen:!1}),{t:o}=re(),n=cs(),{handlePreparePlugin:i,availableOSxVersions:r,availablePluginVersions:c}=fs(),{data:m,isLoading:g}=Ae(),y=m?.address,S=m?.plugins[0].id==="token-voting.plugin.dao.eth"?"Token voting":"Multisig",{data:d,isLoading:x}=bs(),{data:j,isLoading:v}=we(y),_=us({extensions:[ps,gs]}),{control:E,setValue:A}=ge(),{touchedFields:V}=Rs({control:E}),O=Ee({name:"pluginSelectedVersion"}),h=Ee({name:"osSelectedVersion"}),f=Ee({name:"updateFramework"}),I=(r?.size||0)>1,L=(c?.size||0)>1,l=U.getReleaseNotes({releases:d,version:h?.version}),D=U.getReleaseNotes({releases:d,version:O?.version,isPlugin:!0}),z=!!r?.get(h?.version??"")?.isLatest,G=!!c?.get(U.getPluginVersion(O?.version)??"")?.isLatest,J=c?.get(U.getPluginVersion(O?.version)??"")?.isPrepared,Z=[{id:"os",label:U.getProtocolUpdateLabel(h?.version),releaseNote:l,linkLabel:o("update.item.releaseNotesLabel"),...z&&{tagLabelNatural:o("update.item.tagLatest")},...I&&{buttonSecondaryLabel:o("update.item.versionCtaLabel"),onClickActionSecondary:s=>{a({isOpen:!0,type:"os"}),s?.stopPropagation()}},disabled:r?.size===0},{id:"plugin",releaseNote:D,label:U.getPluginUpdateLabel(O?.version,S),linkLabel:o("update.item.releaseNotesLabel"),...G&&{tagLabelNatural:o("update.item.tagLatest")},...J?{tagLabelInfo:o("update.item.tagPrepared")}:{buttonPrimaryLabel:o("update.item.prepareCtaLabel"),onClickActionPrimary:s=>s?.stopPropagation()},...L&&{buttonSecondaryLabel:o("update.item.versionCtaLabel"),onClickActionSecondary:s=>{a({isOpen:!0,type:"plugin"}),s?.stopPropagation()}},disabled:c?.size===0}].filter(s=>!s.disabled),M=g||v||x||(c?.size??1)>0&&!D||(r?.size??1)>0&&!l;return p.useEffect(()=>{const s=o("update.proposal.title"),C=o("update.proposal.summary",{daoName:m?.metadata.name});A("proposalTitle",s),A("proposalSummary",C)},[m?.metadata.name,A,o]),p.useEffect(()=>{let s=o("update.proposal.descriptionHeader");if(f?.os){const C=U.getProtocolUpdateLabel(h?.version),u=U.getReleaseNotes({releases:d,version:h?.version});_?.commands.setContent(u?.summary??""),s+=o("update.proposal.descriptionProtocolUpgrade",{updatedVersion:C,description:_?.getHTML().replace(/<(\/){0,1}p>/g,""),releaseNotesLink:u?.html_url,currentVersion:U.getProtocolUpdateLabel(j)})}if(f?.plugin){const C=U.getPluginUpdateLabel(O?.version,S),u=U.getReleaseNotes({releases:d,version:O?.version,isPlugin:!0});_?.commands.setContent(u?.summary??""),s+=o("update.proposal.descriptionPluginUpgrade",{updatedVersion:C,description:_?.getHTML().replace(/<(\/){0,1}p>/g,""),releaseNotesLink:u?.html_url,currentVersion:U.getPluginUpdateLabel(m?.plugins[0],S)})}s+=o("update.proposal.descriptionFooter"),A("proposal",s)},[m?.plugins,_,h?.version,O?.version,d,A,o,f.os,f?.plugin,j,S]),p.useEffect(()=>{if(A("actions",[]),f?.os&&h?.version&&(A("actions.0.name","os_update"),A("actions.0.inputs.version",h?.version)),f?.plugin&&O?.version){const s=`${O.version.release}.${O.version.build}`,C=c?.get(s)?.preparedData,u=C?{versionTag:C.versionTag,initData:new Uint8Array([]),pluginAddress:C.pluginAddress,permissions:C.permissions,helpers:C.helpers,pluginRepo:typeof C.pluginRepo=="string"?C.pluginRepo:C.pluginRepo.id}:O.version;A("actions.1.name","plugin_update"),A("actions.1.inputs",u)}},[c,h?.version,O?.version,O?.isPrepared,A,f?.os,f?.plugin]),p.useEffect(()=>{V.updateFramework?.plugin||c?.size===1&&A("updateFramework.plugin",!0,{shouldTouch:!0})},[c?.size,A,V.updateFramework?.plugin]),p.useEffect(()=>{V.updateFramework?.os||r?.size===1&&A("updateFramework.os",!0,{shouldTouch:!0})},[r?.size,A,V.updateFramework?.os]),M?e.jsx(ds,{}):(c?.size===0&&r?.size===0&&n(js,{replace:!0}),e.jsxs(Wt,{children:[e.jsx($t,{children:e.jsx(ne,{name:"updateFramework",rules:{required:"Validate"},control:E,render:({field:{onChange:s,value:C}})=>e.jsx(e.Fragment,{children:Z.map(u=>e.jsx(Ie,{...u,type:C?.[u.id]?"active":"default",multiSelect:!0,onClick:()=>{s({...C,[u.id]:!C?.[u.id]})},onClickActionPrimary:B=>{B?.stopPropagation(),i(u.id)}},u.label))})})}),e.jsx(Gt,{showModal:t,handleCloseMenu:()=>{a({isOpen:!1,type:"none"})}}),e.jsx(ke,{message:o("update.itemList.alertInfo"),variant:"info"})]}))},$t=K.div.attrs({className:"flex flex-col items-center md:justify-center gap-y-3"})``,Wt=K.div.attrs({className:"space-y-4"})``,Bt=t=>{const{t:a}=re(),o={[F.WAITING]:a("labels.submitProposal"),[F.LOADING]:void 0,[F.SUCCESS]:a("TransactionModal.goToProposal"),[F.ERROR]:a("modal.transaction.multisig.ctaLabel.tryAgain")},n={REGISTER_VOCDONI_ACCOUNT:{title:a("modalTransaction.vocdoni.deploy.createOffchain"),helper:a("modalTransaction.vocdoni.deploy.signMessage")},CREATE_VOCDONI_ELECTION:{title:a("modalTransaction.vocdoni.deploy.registerProposalOff"),helper:a("modalTransaction.vocdoni.deploy.signMessage")},CREATE_ONCHAIN_PROPOSAL:{title:a("modalTransaction.vocdoni.deploy.registerProposalOn"),helper:a("modalTransaction.vocdoni.deploy.signTransaction")},PROPOSAL_IS_READY:{title:a("modalTransaction.vocdoni.deploy.proposalRready")}};return e.jsx(Us,{title:a("TransactionModal.createProposal"),buttonLabels:o,stepLabels:n,...t})},zt=({metadata:t,data:a,census:o})=>({title:t.title,description:t.description,question:t.summary,startDate:a.gaslessStartDate,endDate:a.gaslessEndDate,meta:a,census:o}),Ht=t=>{const{network:a}=je(),{data:o}=Ae(),n=o?.plugins?.[0]?.instanceAddress,i=o?.plugins?.[0]?.id,r=ve[a].id,{steps:c,updateStepStatus:m,doStep:g,globalState:y,resetStates:S}=_s({initialSteps:{REGISTER_VOCDONI_ACCOUNT:{status:F.WAITING},CREATE_VOCDONI_ELECTION:{status:F.WAITING},CREATE_ONCHAIN_PROPOSAL:{status:F.WAITING},PROPOSAL_IS_READY:{status:F.WAITING}}}),{client:d}=Ms(),x=Gs(),{createToken:j}=Fs({chainId:r,pluginType:i}),[v,_]=p.useState(void 0),E=p.useCallback(async f=>{let I=(await d.fetchAccount()).balance;for(;f>I;)try{I=(await d.collectFaucetTokens()).balance}catch(L){if(L instanceof $s){const l=`(until ${L.untilDate.toLocaleDateString()})`;throw Error(`This wallet has reached the maximum allocation of Vocdoni tokens for this period ${l}. For additional tokens, please visit https://onvote.app/faucet and retry after acquiring more.`)}throw L}},[d]),A=p.useCallback(async f=>{const I=Ws.from({title:f.title,description:f.description,endDate:f.endDate,startDate:f.startDate,census:f.census,maxCensusSize:f.census.size??void 0,electionType:{interruptible:!1}});I.addQuestion(f.question,"",Object.keys(Ce).filter(l=>isNaN(Number(l))).map((l,D)=>({title:l,value:D})));const L=await d.calculateElectionCost(I);return await E(L),await d.createElection(I)},[E,d]),V=p.useCallback(async()=>{let f;if(!v)try{f=await d.createAccount()}catch(I){throw console.log(I),Error("Error creating Vocdoni account")}finally{_(f)}},[v,d]),O=p.useCallback(async f=>{async function I(){let D=0;const z=6;for(;D<z;){try{const G=await x.getToken(f,r);if(G.status.synced)return G}catch(G){G instanceof zs&&await j(n)}D++,D<z&&await new Promise(G=>setTimeout(G,1e4))}throw Error("Census token is not already calculated, try again later")}const L=await I(),l=await x.createCensus(L.defaultStrategy);return new Bs(l.merkleRoot,l.uri,l.anonymous,L,l.size,BigInt(l.weight))},[x,r,j,n]),h=p.useCallback(async(f,I,L)=>{if(y===F.ERROR)S();else if(y===F.SUCCESS)return await L();if(!t)return new Error("ERC20 SDK client is not initialized correctly");await g("REGISTER_VOCDONI_ACCOUNT",V);let l;const D=await g("CREATE_VOCDONI_ELECTION",async()=>(l=await O(t),await A(zt({metadata:f,data:I,census:l}))));await g("CREATE_ONCHAIN_PROPOSAL",async()=>await L(D,l,I)),m("PROPOSAL_IS_READY",F.SUCCESS)},[V,O,A,t,g,y,S,m]);return{steps:c,globalState:y,createProposal:h}},ia=({showTxModal:t,setShowTxModal:a,children:o})=>{const{t:n}=re(),{open:i}=Hs(),r=qs(),c=cs(),{getValues:m}=ge(),{network:g}=je(),y=Ks(g),{isOnWrongNetwork:S,provider:d,address:x}=Ve(),{api:j}=Qs(),{data:v,isLoading:_}=Ae(),E=v?.plugins?.[0]?.instanceAddress,A=v?.plugins?.[0]?.id,{data:V}=Ys(E),{data:O}=wt(V?.address||""),{data:h}=Xs({pluginAddress:E,pluginType:A}),{data:f}=Js({tokenAddress:V?.address,address:x},{enabled:!!V?.address&&!!x}),{data:I}=we(v?.address),{client:L}=Re(),l=ns(A),D=A===rs,{days:z,hours:G,minutes:J}=Zs(h.minDuration),[Z,M]=p.useState(),[s,C]=p.useState(),[u,B]=p.useState(P.WAITING),me=p.useMemo(()=>u===P.WAITING&&s!==void 0,[u,s]),Ps=!s&&u!==P.SUCCESS,{steps:ys,globalState:fe,createProposal:Ue}=Ht(V?.address),_e=p.useCallback(async()=>{const N=m("actions"),w=[];if(!l||!L||!v?.address)return Promise.resolve([]);for await(const b of et(N,Je(h)?h:void 0,Ze(h)?h:void 0))switch(b.name){case"withdraw_assets":{w.push(L.encoding.withdrawAction({amount:BigInt(ss(b.amount.toString(),b.tokenDecimals).toString()),recipientAddressOrEns:b.to.address,...ct(b.tokenAddress)?{type:Ke.NATIVE}:{type:Ke.ERC20,tokenAddress:b.tokenAddress}}));break}case"mint_tokens":{b.inputs.mintTokensToWallets.forEach(T=>{w.push(Promise.resolve(l.encoding.mintTokenAction(b.summary.daoTokenAddress,{address:T.web3Address.address,amount:BigInt(ss(T.amount.toString(),18).toString())})))});break}case"add_address":{const T=b.inputs.memberWallets.map(k=>k.address);w.push(Promise.resolve(l.encoding.addAddressesAction({pluginAddress:E,members:T})));break}case"remove_address":{const T=b.inputs.memberWallets.map(k=>k.address);T.length>0&&w.push(Promise.resolve(l.encoding.removeAddressesAction({pluginAddress:E,members:T})));break}case"modify_multisig_voting_settings":{w.push(Promise.resolve(l.encoding.updateMultisigVotingSettings({pluginAddress:E,votingSettings:{minApprovals:b.inputs.minApprovals,onlyListed:h.onlyListed}})));break}case"external_contract_action":{const T=await rt(b.contractAddress,g);if(T.status==="1"&&T.result[0].ABI!=="Contract source code not verified"){const k=b.inputs?.filter(W=>W.name!==it(n)).map(W=>{const R=W.value;return typeof R=="string"&&R.indexOf("[")===0?JSON.parse(R):R}),te=new Tt(T.result[0].ABI).encodeFunctionData(b.functionName,k);w.push(Promise.resolve({to:b.contractAddress,value:Dt(b.value||"0").toBigInt(),data:lt(te)}))}break}case"wallet_connect_action":w.push(Promise.resolve({value:BigInt(0),...b.raw}));break;case"os_update":{y!=="unsupported"&&ot.includes(y)&&v.address&&I&&w.push(Promise.resolve(L.encoding.daoUpdateAction(v.address,{previousVersion:I,daoFactoryAddress:nt[b.inputs.version][y].daoFactoryAddress})));break}case"plugin_update":{L.encoding.applyUpdateAndPermissionsActionBlock(v.address,{...b.inputs}).map(k=>{w.push(Promise.resolve(k))});break}case"modify_metadata":{const T={...b};w.push(at(T,v.address,L));break}case"modify_gasless_voting_settings":{tt(l)&&w.push(Promise.resolve(l.encoding.updatePluginSettingsAction(E,b.inputs)));break}case"modify_token_voting_settings":{st(l)&&w.push(Promise.resolve(l.encoding.updatePluginSettingsAction(E,b.inputs)));break}}return Promise.all(w)},[L,v,m,g,E,l,n,y,I,h]),ie=p.useCallback(async()=>{const[N,w,b,T,k,H,te,W,R,q,De,Q]=m(["proposalTitle","proposalSummary","proposal","links","startDate","startTime","startUtc","endDate","endTime","endUtc","durationSwitch","startSwitch"]),Pe=await _e(),ye={title:N,summary:w,description:b,resources:T.filter(ae=>ae.name&&ae.url)};let Se;D||(Se=await l?.methods.pinMetadata(ye));let Y;Q==="now"?Y=new Date(`${Qe()}T${Ye()}:00${ue()}`):Y=new Date(`${k}T${H}:00${ue(te)}`);const xe=Y.valueOf()+dt(z||0)+ut(G||0)+pt(J||0);let $;if(De==="duration"){const[ae,Ne,Cs]=m(["durationDays","durationHours","durationMinutes"]),ws=Y.valueOf()+gt({days:Number(ae),hours:Number(Ne),minutes:Number(Cs)});$=new Date(ws),!D&&$.valueOf()<=xe&&Q==="now"?$=void 0:D&&$.valueOf()<=xe&&Q==="now"&&$.setMinutes($.getMinutes()+5)}else $=new Date(`${W}T${R}:00${ue(q)}`);if(Q==="duration"&&$&&(Y.valueOf()<new Date().valueOf()&&(Y=new Date(`${Qe()}T${Ye()}:00${ue()}`)),$.valueOf()<xe)){const ae=new Date(`${k}T${H}:00${ue(te)}`),Ne=$.valueOf()+(Y.valueOf()-ae.valueOf());$=new Date(Ne)}return{params:{pluginAddress:E,metadataUri:Se||"",startDate:Q==="now"?void 0:Y,endDate:$,actions:Pe},metadata:ye}},[m,_e,D,z,G,J,E,l]),ee=p.useCallback(N=>{const b=new Date(N.endDate);b.setMinutes(N.endDate.getMinutes()+1);let T;return N.startDate&&(T=new Date(N.startDate),T.setMinutes(N.startDate.getMinutes()-1)),{...N,tallyEndDate:void 0,endDate:N.endDate,gaslessEndDate:b,gaslessStartDate:T}},[]),Ss=p.useCallback(async()=>{if(!l)return Promise.reject(new Error("ERC20 SDK client is not initialized correctly"));if(s)return l.estimation.createProposal(s)},[D,l,s]),{tokenPrice:be,maxFee:Me,averageFee:se,stopPolling:Ge,error:Fe}=is(Ss,me),le=p.useCallback(()=>{u===P.LOADING||fe===F.LOADING||(u===P.SUCCESS?c(mt(bt,{network:g,dao:ft(v?.ensDomain)||v?.address,id:Z})):(B(P.WAITING),a(!1),Ge()))},[u,v?.address,v?.ensDomain,c,g,fe,Z,a,Ge]),$e=p.useCallback(async(N,w)=>{if(!x||!v||!h||!s)return;const b=await j.getBlockNumber(),[T,k,H,te]=m(["proposalTitle","proposalSummary","proposal","links"]),W={id:N,dao:{address:v.address,name:v.metadata.name},creationDate:new Date,creatorAddress:x,creationBlockNumber:b,startDate:s.startDate,endDate:s.endDate,metadata:{title:T,summary:k,description:H,resources:te.filter(R=>R.name&&R.url)},actions:s.actions??[],status:s.startDate?Xe.PENDING:Xe.ACTIVE};if(Je(h)){const{approve:R}=s,q={...W,approvals:R?[x]:[],settings:h};Le.addProposal(ve[g].id,q)}else if(Pt(h)){const{creatorVote:R}=s,q=f?.toBigInt()??BigInt(0),De={yes:R===Ce.YES?q:BigInt(0),no:R===Ce.NO?q:BigInt(0),abstain:R===Ce.ABSTAIN?q:BigInt(0)};let Q=BigInt(0);const Pe=[];R&&(Q=q,Pe.push({address:x,vote:R,voteReplaced:!1,weight:q}));const ye={supportThreshold:h.supportThreshold,minParticipation:h.minParticipation,duration:yt(W.endDate,W.startDate??new Date)},Se={...W,result:De,settings:ye,usedVotingWeight:Q,totalVotingWeight:O?.raw??BigInt(0),token:V??null,votes:Pe};Le.addProposal(ve[g].id,Se)}else if(Ze(h)){const R={...W,executed:!1,approvers:new Array,vochainProposalId:w,settings:h,participation:{currentParticipation:0,currentPercentage:0,missingParticipation:100},token:V};Le.addProposal(ve[g].id,R)}},[x,v,h,s,j,m,g,f,O?.raw,V]),We=p.useCallback(()=>{r.invalidateQueries([St.PROPOSALS]),r.invalidateQueries(At.totalProposalCount({pluginAddress:E,pluginType:A}))},[E,A,r]),Te=p.useCallback(async(N,w,b)=>{if(!l)return new Error("ERC20 SDK client is not initialized correctly");if(!s||u===P.LOADING){console.log("Transaction is running");return}he("newProposal_createNowBtn_clicked",{dao_address:v?.address,estimated_gwei_fee:se,total_usd_cost:se?be*Number(se):0});let T;if(D&&N&&w&&b){const k={...ee(b),censusRoot:w.censusId,censusURI:w.censusURI,totalVotingPower:w.weight,vochainProposalId:N};T=l.methods.createProposal({...k,vochainProposalId:N})}else T=l.methods.createProposal(s);if(u===P.SUCCESS){le();return}if(S){i("network"),le();return}B(P.LOADING);try{for await(const k of T)switch(k.key){case es.CREATING:console.log(k.txHash),he("newProposal_transaction_signed",{dao_address:v?.address,network:g,wallet_provider:d?.connection.url});break;case es.DONE:{const H=new ht(k.proposalId).makeGloballyUnique(E);M(H),B(P.SUCCESS),he("newProposal_transaction_success",{dao_address:v?.address,network:g,wallet_provider:d?.connection.url,proposalId:H}),$e(H,N),We();break}}}catch(k){if(console.error(k),B(P.ERROR),he("newProposal_transaction_failed",{dao_address:v?.address,network:g,wallet_provider:d?.connection.url,error:k}),N)throw k}},[l,s,u,v?.address,se,be,D,S,ee,le,i,g,d?.connection.url,E,$e,We]),hs=p.useCallback(async()=>{if(!l||!V)return new Error("ERC20 SDK client is not initialized correctly");const{params:N,metadata:w}=await ie();await Ue(w,ee(N),Te)},[l,V,ie,Ue,ee,Te]);p.useEffect(()=>{async function N(){if(t&&u===P.WAITING)if(D)C(ee((await ie()).params));else{const{params:w}=await ie();C(w)}else t||C(void 0)}N()},[u,ee,ie,D,t]);const vs={[P.SUCCESS]:n("TransactionModal.goToProposal"),[P.WAITING]:n("TransactionModal.createProposalNow")};return _?e.jsx(ds,{}):e.jsxs(e.Fragment,{children:[o,D?e.jsx(Bt,{steps:ys,globalState:fe,isOpen:t,onClose:le,callback:hs,closeOnDrag:u!==P.LOADING||fe!==F.LOADING,maxFee:Me,averageFee:se,gasEstimationError:Fe,tokenPrice:be,title:n("TransactionModal.createProposal")}):e.jsx(ls,{state:u||P.WAITING,isOpen:t,onClose:le,callback:Te,closeOnDrag:u!==P.LOADING,maxFee:Me,averageFee:se,gasEstimationError:Fe,tokenPrice:be,title:n("TransactionModal.createProposal"),buttonStateLabels:vs,disabledCallback:Ps})]})};export{ia as C,aa as D,na as U,ra as a,oa as i};
