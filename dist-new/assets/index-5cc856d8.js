import{q as c,y as $,w as J,t as O,z as H,aV as en,a0 as N,cA as tn,u as V,al as Fe,Y as is,e as me,am as rs,bh as sn,O as Be,cB as ns,G as re,aM as as,cC as rn,ar as xe,cD as W,cE as Bt,cF as nn,cG as wt,ax as Kt,S as oe,Q as $e,V as Se,I as Oe,cH as Ai,at as le,aw as Wt,aC as Ii,bZ as an,F as ve,aB as Gt,a3 as on,cI as tt,cJ as cn,A as ke,c4 as ln,cK as Ni,x as vt,c3 as dn,g as xt,cv as Ee,cL as hn,cM as un,cN as pn,h as Et,v as gn,b3 as mn,bM as _i,cO as Re,cP as vs,cQ as Fi,cR as F,cS as fn,cT as yn,cU as bn,cV as Ct,cW as wn,cX as vn,cY as xn,cZ as En,c_ as Cn,c$ as Sn,d0 as ge,d1 as ue,d2 as $i,d3 as Ri,d4 as ji,d5 as An,d6 as Oi,d7 as xs,d8 as In,d9 as Nn,da as _n,db as Fn,dc as Ti,B as dt,dd as $n,de as Es,df as Rn,j as St,dg as jn,p as Pi,dh as ki,as as Ue,di as On,dj as Tn,dk as Pn,dl as kn,dm as Cs,dn as Ss,J as Dn,W as As,L as Ln,dp as Mn,dq as Di,dr as Is,ds as Un,dt as qn,ao as Vn,b9 as zn,au as Bn,an as Kn,du as Wn,dv as Gn,bJ as Li,k as Hn,b8 as Jn,bw as Yn,cu as Qn,dw as Xn,aX as Zn}from"./main-1e616d6f.js";import{r as A}from"./tiptap-313d156f.js";import{I as ea,m as Ns,ae as ta,af as Mi}from"./osx-ethers-780b73f3.js";import{I as Ui,C as sa,W as ia}from"./index-b5e6cc73.js";import{u as ra,a as na}from"./useTokenMetadata-6398f62d.js";import{c as T,S as qi,N as Ot,g as aa,I as Ke,U as oa,a as At,_ as ca,b as _s,e as la,s as da,W as ha}from"./index.es-c80844a1.js";import{f as os,i as Ce,a as be,b as It,c as Nt,d as _t,e as Ft,s as ua,g as pa,J as ga,h as Vi}from"./browser-9096de8d.js";import{F as zi,A as ma}from"./index-4cbd21fe.js";import{a as fa}from"./index-30af19f4.js";import{U as ya,R as ba}from"./index-93139e2c.js";import{b as Bi}from"./accordionSummary-a06aa21e.js";const wa=({children:i,purpose:e=""})=>c.jsxs("div",{className:"m-10 space-y-2 bg-primary-100 p-4",children:[c.jsxs("p",{children:["This is a temporarily added section for demonstration purposes."," ",e]}),i]}),st=i=>{const{showBackButton:e,showCloseButton:t,onBackButtonClicked:s,onClose:r,title:n,subTitle:a,...o}=i;return c.jsxs(va,{children:[e&&c.jsx(J,{variant:"tertiary",size:"sm",iconLeft:O.CHEVRON_LEFT,onClick:s,...o}),c.jsxs("div",{className:"flex-1",children:[c.jsx(xa,{children:n}),a&&c.jsx(Ea,{dangerouslySetInnerHTML:{__html:a}})]}),t&&c.jsx(J,{variant:"tertiary",size:"sm",iconLeft:O.CLOSE,onClick:r})]})},va=$.div.attrs({className:"flex rounded-xl xl:space-x-6 p-4 xl:p-6 bg-neutral-0"})`
  box-shadow:
    0px 4px 8px rgba(31, 41, 51, 0.04),
    0px 0px 2px rgba(31, 41, 51, 0.06),
    0px 0px 1px rgba(31, 41, 51, 0.04);
`,xa=$.div.attrs({className:"font-semibold text-neutral-800 text-center xl:text-left"})``,Ea=$.div.attrs({className:"mt-1 text-sm leading-normal text-neutral-600"})``,Ca=(i,e,t)=>{const s=`${H[e].etherscanApi}?module=contract&action=getsourcecode&address=${i}&apikey=${H[e].etherscanApiKey}`;return en({queryKey:["verifyContractEtherscan",i,e],staleTime:1/0,queryFn:()=>fetch(s).then(r=>r.json().then(n=>n.result[0].Proxy==="1"?fetch(`${H[e].etherscanApi}?module=contract&action=getsourcecode&address=${n.result[0].Implementation}&apikey=${H[e].etherscanApiKey}`).then(async a=>(n.result[0].proxyImplementation=await a.json(),n)):n)),enabled:i!==null&&t===N.LOADING&&!!e})},Sa=(i,e,t)=>tn({queries:["full_match","partial_match"].map(s=>({queryKey:[`verifycontract${s}Sourcify`,i,e],queryFn:()=>fetch(`https://repo.sourcify.dev/contracts/${s}/${H[e].id}/${i}/metadata.json`).then(r=>r.json()),enabled:t===N.LOADING&&!!e,retry:!1}))}),Aa=(i,e,t)=>{const{data:s,isLoading:r}=Ca(i,e,t),n=Sa(i,e,t);return{sourcifyFullData:n[0].data,sourcifyPartialData:n[1].data,etherscanData:s,sourcifyLoading:n[0].isLoading||n[1].isLoading,etherscanLoading:r}},Ia={[N.WAITING]:void 0,[N.LOADING]:void 0,[N.SUCCESS]:O.CHEVRON_RIGHT,[N.ERROR]:void 0,[N.INCORRECT_URI]:void 0},Na=i=>{const{t:e}=V(),{alert:t}=Fe(),{address:s}=is(),{network:r}=me(),{api:n}=rs(),a=sn(),{dao:o}=Be(),l=ns(),{control:d,resetField:p,setValue:u,setError:v}=re(),{errors:b}=as({control:d}),{field:{value:y},fieldState:{error:x}}=rn({name:"ABIInput"}),[C,_]=xe({name:["contractAddress","contracts"],control:d}),[h,g]=A.useState(N.WAITING),[m,f]=A.useState(),[w,I]=A.useState(W.NOT_STARTED),{sourcifyFullData:E,sourcifyPartialData:R,etherscanData:B,sourcifyLoading:Ae,etherscanLoading:Ie}=Aa(C,r,h),ne=h===N.SUCCESS,L=h===N.LOADING,j=h===N.WAITING,P=h===N.ERROR,M=K=>{try{return new ea(K),I(W.SUCCESS),e("scc.abi.abiInput.alertWarning")}catch{return I(W.ERROR),e("scc.abi.abiInput.alertCritical")}};function z(K){const k=Object.entries(K?.devdoc.methods);return K?.abi.map(U=>{if(U.type==="function"&&k){const Q=k.find(([pe])=>pe.substring(0,pe.indexOf("("))===U.name);Q&&(U.notice=Q[1].details,U?.inputs.filter(pe=>{pe.notice=Q[1].params?.[pe.name]}))}return U})}const Y=A.useCallback((K,k,U)=>{if(k){g(N.SUCCESS);let Q={};if(K==="sourcifyMatch")Q={actions:z(k.output),address:C,name:k.output.devdoc.title,logo:U},f(k.output.devdoc.title);else{if(Q={actions:Bt(k.SourceCode,k.ContractName,JSON.parse(k?.ABI||"")),address:C,name:k.ContractName,logo:U,proxy:k.Proxy,implementation:k.Implementation},k.proxyImplementation){const Le=k.proxyImplementation.result[0],Zr=Bt(Le.SourceCode,Le.ContractName,JSON.parse(Le.ABI||""));Q.implementationData={actions:Zr,address:k.Implementation,proxyAddress:C,name:Le.ContractName,logo:U}}f(k?.ContractName)}u("contracts",[..._,Q]),nn(Q,s,H[r].id)}else f(""),g(N.WAITING)},[s,C,_,r,u]);A.useEffect(()=>{async function K(){if(!Ae&&!Ie&&L){const k=await Gt(C,n,H[r].nativeCurrency).then(U=>l({address:C,network:r,symbol:U.symbol}));if(g(N.SUCCESS),E||R||B.result[0].ABI!=="Contract source code not verified"){const U=[];let Q;(E||R)&&(U.push("sourcify"),Q=E?.output?.devdoc?.title||R?.output?.devdoc?.title),B.result[0].ABI!=="Contract source code not verified"&&(U.push("etherscan"),Q=B.result[0]?.ContractName),ve("newProposal_smartContractConnection_succeeded",{dao_address:o,smart_contract_address:C,smart_contract_name:Q,source:U})}else ve("newProposal_smartContractConnection_failed",{dao_address:o,smart_contract_address:C});E||R?(E&&(E.output.devdoc.title=E.output.devdoc.title||B.result[0].ContractName),R&&(R.output.devdoc.title=R.output.devdoc.title||B.result[0].ContractName),Y("sourcifyMatch",E||R,k?.imgUrl||"")):B.result[0].ABI!=="Contract source code not verified"?Y("etherscanMatch",B.result[0],k?.imgUrl||""):(f(""),g(N.ERROR),I(W.WAITING))}}K()},[C,o,B,Ie,l,L,r,n,v,Y,E,Ae,R,e]);const Ge={[N.WAITING]:e("scc.validation.ctaLabelWaiting"),[N.LOADING]:"",[N.SUCCESS]:e("scc.validation.ctaLabelSuccess"),[N.ERROR]:"",[N.INCORRECT_URI]:""},Wr={[W.WAITING]:e("TransactionModal.tryAgain"),[W.ABI_INPUT]:e("scc.abi.ctaLabelWaiting"),[W.SUCCESS]:e("scc.validation.ctaLabelSuccess"),[W.ERROR]:e("scc.abi.ctaLabelCritical")},Gr=A.useCallback((K,k)=>{K&&!ne&&!L?(k(""),t(e("alert.chip.inputCleared"))):wt(K,k,t)},[t,L,ne,e]),Hr=K=>_.some(U=>U.address.toLowerCase()===K.toLowerCase())?e("errors.duplicateContractAddress"):on.isAddress(K)?!0:e("errors.invalidAddress"),Jr=A.useMemo(()=>e(ne||L?"labels.copy":C&&C!==""?"labels.clear":"labels.paste"),[C,L,ne,e]),Yr=A.useMemo(()=>b.contractAddress!==void 0,[b.contractAddress]),Qr=A.useMemo(()=>Ae&&!P?c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(Kt,{size:"sm",variant:"primary"}),c.jsx(je,{colorClassName:"text-primary-800",children:e("scc.validation.sourcifyStatusPending")})]}):E?c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(oe,{icon:O.SUCCESS,className:"text-success-500"}),c.jsx(je,{colorClassName:"text-success-800",children:e("scc.validation.sourcifyStatusSuccess")})]}):R?c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(oe,{icon:O.WARNING}),c.jsx(je,{colorClassName:"text-warning-800",children:e("scc.validation.sourcifyStatusWarning")})]}):c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(oe,{icon:O.REMOVE,className:"text-critical-500"}),c.jsx(je,{colorClassName:"text-critical-800",children:e("scc.validation.sourcifyStatusCritical")})]}),[P,E,Ae,R,e]),Xr=A.useMemo(()=>Ie&&!P?c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(Kt,{size:"sm",variant:"primary"}),c.jsx(je,{colorClassName:"text-primary-800",children:e("scc.validation.etherscanStatusPending",{blockExplorerName:H[r].explorerName})})]}):B&&B?.result[0].ABI!=="Contract source code not verified"?c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(oe,{icon:O.SUCCESS,className:"text-success-500"}),c.jsx(je,{colorClassName:"text-success-800",children:e("scc.validation.etherscanStatusSuccess",{blockExplorerName:H[r].explorerName})})]}):c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(oe,{icon:O.REMOVE,className:"text-critical-500"}),c.jsx(je,{colorClassName:"text-critical-800",children:e("scc.validation.etherscanStatusCritical",{blockExplorerName:H[r].explorerName})})]}),[B,Ie,P,r,e]);return c.jsxs($e,{isOpen:i.isOpen,onClose:()=>{p("contractAddress"),g(N.WAITING),i.onClose()},children:[c.jsx(st,{title:e("scc.validation.modalTitle"),onClose:()=>{p("contractAddress"),g(N.WAITING),i.onClose()},onBackButtonClicked:()=>{p("contractAddress"),g(N.WAITING),i.onBackButtonClicked()},showBackButton:!(h===N.LOADING||ne),showCloseButton:!L}),c.jsxs(_a,{children:[c.jsxs(Fa,{children:[c.jsx($a,{children:e("scc.validation.addressInputLabel")}),c.jsxs(Ra,{children:[e("scc.validation.addressInputHelp"),c.jsx(Se,{external:!0,label:e("labels.etherscan"),href:`${H[r].explorer}`,className:"ml-1"})]})]}),c.jsx(Oe,{name:"contractAddress",rules:{required:e("errors.required.tokenAddress"),validate:Hr},control:d,defaultValue:"",render:({field:{name:K,onBlur:k,onChange:U,value:Q},fieldState:{error:pe}})=>c.jsxs(c.Fragment,{children:[c.jsx(Ai,{mode:pe?"critical":"default",name:K,onBlur:k,value:Q,onChange:Le=>U(Le.target.value.trim()),disabled:ne||L||P,placeholder:"0x ...",adornmentText:Jr,onAdornmentClick:()=>Gr(Q,U)}),c.jsx("div",{className:"mt-2",children:pe?.message&&c.jsx(le,{message:pe.message,variant:"critical"})})]})}),!j&&(w===W.NOT_STARTED||w===W.WAITING)&&c.jsxs(ja,{children:[c.jsx(Oa,{children:m||Wt(C)}),c.jsxs(Fs,{children:[Qr,!L&&c.jsx(Se,{external:!0,type:"neutral",iconRight:O.LINK_EXTERNAL,href:`https://sourcify.dev/#/lookup/${C}`,label:e("scc.validation.explorerLinkLabel"),className:"ft-text-sm"})]}),c.jsxs(Fs,{children:[Xr,!L&&c.jsx(Se,{external:!0,type:"neutral",iconRight:O.LINK_EXTERNAL,href:`${H[r].explorer}address/${C}#code`,label:e("scc.validation.explorerLinkLabel"),className:"ft-text-sm"})]})]}),w!==W.NOT_STARTED&&w!==W.WAITING&&!j&&c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"mt-4 font-semibold text-neutral-700 ft-text-base",children:e("scc.abi.abiInputLabel")}),c.jsx("p",{className:"mt-1 text-sm leading-normal text-neutral-600",dangerouslySetInnerHTML:{__html:Ii(e)("scc.abi.abiInputHelp")}}),c.jsx("div",{className:"mt-3",children:c.jsx(Oe,{name:"ABIInput",rules:{required:e("errors.required.summary"),validate:K=>M(K)},render:({field:{name:K,onBlur:k,onChange:U,value:Q}})=>c.jsx(c.Fragment,{children:c.jsx(an,{name:K,value:Q,onBlur:k,onChange:U})})})})]}),L?c.jsx(J,{onClick:async()=>{a.cancelQueries({queryKey:["verifyContractEtherscan","verifycontractfull_matchSourcify","verifycontractpartial_matchSourcify"]}),g(N.WAITING)},size:"lg",className:"mt-6 w-full",variant:"tertiary",children:e("scc.validation.cancelLabel")}):w!==W.WAITING&&c.jsx(J,{onClick:async()=>{h===N.SUCCESS?(i.onVerificationSuccess(),p("contractAddress"),g(N.WAITING),ve("newProposal_createAction_clicked",{dao_address:o,smart_contract_address:C,smart_contract_name:m})):w===W.NOT_STARTED?(ve("newProposal_validateSmartContract_clicked",{dao_address:o,smart_contract_address:C}),g(N.LOADING)):w===W.SUCCESS?(Y("manualABI",{ABI:y,ContractName:C},""),i.onVerificationSuccess(),p("contractAddress"),p("ABIInput"),g(N.WAITING),I(W.NOT_STARTED),ve("newProposal_createAction_clicked",{dao_address:o,smart_contract_address:C,smart_contract_name:m})):h===N.ERROR&&(p("contractAddress",{defaultValue:""}),g(N.WAITING),I(W.NOT_STARTED))},disabled:Yr,isLoading:L,iconRight:Ia[h],size:"lg",variant:"primary",className:"mt-6 w-full",children:w!==W.NOT_STARTED?Wr[w]:Ge[h]}),P&&w===W.WAITING&&c.jsx(J,{onClick:()=>{p("contractAddress"),g(N.WAITING),i.onClose()},size:"lg",className:"mt-4 w-full",variant:"tertiary",children:e("scc.validation.cancelLabel")}),x?.message&&c.jsx("div",{className:"mt-4 flex justify-center",children:c.jsx(le,{message:x.message,variant:w===W.ERROR?"critical":"warning"})})]})]})},_a=$.div.attrs({className:"px-4 md:px-6 py-6"})``,Fa=$.div.attrs({className:"space-y-1 mb-3"})``,$a=$.h2.attrs({className:"text-neutral-800 ft-text-base font-semibold"})``,Ra=$.p.attrs({className:"ft-text-sm text-neutral-600 font-normal"})``,ja=$.div.attrs({className:"bg-neutral-0 rounded-xl p-4 mt-6 space-y-4"})``,Oa=$.h2.attrs({className:"text-neutral-600 ft-text-base font-semibold"})``,Fs=$.div.attrs({className:"flex justify-between"})``,je=$.span.attrs(({colorClassName:i})=>({className:"ft-text-sm font-semibold "+i}))``,Ta=i=>c.jsxs(Pa,{children:[c.jsxs(ka,{children:[c.jsx(J,{iconLeft:i.buttonIcon||O.HOME,variant:"tertiary",size:"md",onClick:i.onHomeButtonClick}),c.jsx(oe,{icon:O.CHEVRON_RIGHT}),i.selectedValue&&c.jsxs(c.Fragment,{children:[c.jsx(Da,{children:i.selectedValue}),c.jsx(oe,{icon:O.CHEVRON_RIGHT})]}),c.jsx(La,{type:"text",placeholder:i.searchPlaceholder,onChange:e=>i.onSearch?.(e.target.value)})]}),c.jsx(J,{variant:"tertiary",size:"md",iconLeft:O.CLOSE,onClick:i.onClose})]}),Pa=$.div.attrs({className:"flex sticky top-0 justify-between items-center py-5 px-6 bg-neutral-0 border-b border-neutral-100"})``,ka=$.div.attrs({className:"flex gap-x-2 items-center text-neutral-300 ft-text-base"})``,Da=$.p.attrs({className:"font-semibold text-neutral-600 ft-text-base"})``,La=$.input.attrs({className:"flex-1 text-neutral-300 bg-neutral-0 ft-text-base focus:outline-none"})``,Ki=({actions:i,onActionSelected:e})=>{const{t}=V(),{setValue:s}=re(),[r]=xe({name:["selectedAction"]});return c.jsxs(Ma,{children:[c.jsx(Ua,{children:i.length===1?t("scc.labels.singleActionAvailable"):i.length===0?t("scc.writeContractEmptyState.desc"):t("scc.labels.nActionsAvailable",{numConnected:i.length})}),i.map(n=>c.jsx(tt,{title:n.name,subtitle:n.name,iconRight:c.jsx(oe,{icon:O.CHEVRON_RIGHT}),onClick:()=>{s("selectedAction",n),e?.()},bgWhite:r!==n,mode:r===n?"selected":"default",truncateText:!0},n.name))]})},Ma=$.div.attrs({className:"flex-1 pt-6 xl:pt-8 pb-4 space-y-2"})``,Ua=$.div.attrs({className:"ft-text-sm font-semibold text-neutral-400 hidden xl:block"})``,Wi=({sc:i,onRemoveContract:e,...t})=>{const{alert:s}=Fe(),{network:r}=me(),{t:n}=V(),{setValue:a,getValues:o}=re(),l=o("contracts"),d=[c.jsx(Se,{external:!0,type:"neutral",iconRight:O.LINK_EXTERNAL,href:cn(r,i.address)+"#code",label:n("scc.detailContract.dropdownExplorerLinkLabel",{address:i.address}),className:"my-2 w-full justify-between px-4"},0),c.jsx(Se,{external:!0,type:"neutral",iconRight:O.COPY,label:n("scc.detailContract.dropdownCopyLabel"),className:"my-2 w-full justify-between px-4",onClick:()=>{wt(i.address,()=>{},s)}},1),c.jsx(Se,{external:!0,type:"neutral",iconRight:O.CLOSE,label:n("scc.detailContract.dropdownRemoveLabel"),className:"my-2 w-full justify-between px-4",onClick:()=>{i.implementationData?e(i.proxyAddress):e(i.address)}},2)];(i.proxyAddress||i.implementationData)&&d.unshift(c.jsx(Se,{external:!0,type:"neutral",label:i.implementationData?n("scc.writeProxy.dropdownWriteAsProxyLabel"):n("scc.writeProxy.dropdownDontWriteLabel"),iconRight:O.BLOCKCHAIN_SMARTCONTRACT,className:"my-2 w-full justify-between px-4",onClick:()=>{if(i.implementationData)a("selectedSC",i.implementationData),a("selectedAction",i.implementationData.actions.filter(v=>v.type==="function"&&(v.stateMutability==="payable"||v.stateMutability==="nonpayable"))?.[0]);else{const v=l.filter(b=>b.address===i.proxyAddress)[0];a("selectedSC",v),a("selectedAction",v.actions.filter(b=>b.type==="function"&&(b.stateMutability==="payable"||b.stateMutability==="nonpayable"))?.[0])}}},3));const p=c.jsx(ke.Container,{align:"start",customTrigger:c.jsx("button",{children:c.jsx(oe,{icon:O.DOTS_VERTICAL})}),children:d}),u={title:i.name,subtitle:i.proxyAddress?`${n("scc.listContracts.proxyContractAddressLabel",{contractAddress:Wt(i.address)})}`:Wt(i.address),bgWhite:!0,logo:i.logo,iconRight:p};return c.jsx(tt,{...u,...t,iconLeft:u.title,truncateText:!0})},qa=({logo:i,dropdownItems:e,iconRight:t,...s})=>(e&&!t&&(t=c.jsx(ke.Container,{align:"start",customTrigger:c.jsx("button",{children:c.jsx(oe,{icon:O.DOTS_VERTICAL})}),children:e})),c.jsx(tt,{iconRight:t,...s,iconLeft:i||s.title,truncateText:!0})),Gi=()=>{const{t:i}=V(),{setValue:e,getValues:t}=re(),s=t("contracts")||[];return c.jsxs(Va,{children:[c.jsx(za,{children:s.length===1?i("scc.labels.singleContractConnected"):i("scc.labels.nContractsConnected",{numConnected:s.length})}),s.map(r=>c.jsx(qa,{title:r.name,subtitle:i("scc.listContracts.contractAmountActions",{amount:r.actions.filter(n=>n.type==="function"&&(n.stateMutability==="payable"||n.stateMutability==="nonpayable")).length.toString()}),logo:r.logo,bgWhite:!0,iconRight:c.jsx(oe,{icon:O.CHEVRON_RIGHT}),onClick:()=>{e("selectedSC",r),e("selectedAction",r.actions.filter(n=>n.type==="function"&&(n.stateMutability==="payable"||n.stateMutability==="nonpayable"))?.[0])}},r.address))]})},Va=$.div.attrs({className:"pb-4 space-y-2"})``,za=$.div.attrs({className:"ft-text-sm font-semibold text-neutral-400"})``,Ba=i=>{const{t:e}=V(),{dao:t}=Be(),[s,r]=xe({name:["selectedSC","selectedAction"]}),[n,a]=A.useState(""),{getValues:o,setValue:l,resetField:d}=re(),p=o("contracts")||[],u=p.length===1?p[0]:null,v=()=>{};return A.useEffect(()=>{l("selectedSC",u),u&&l("selectedAction",u.actions.filter(b=>b.type==="function"&&(b.stateMutability==="payable"||b.stateMutability==="nonpayable"))?.[0])},[u,l]),c.jsxs(Ya,{isOpen:i.isOpen,onClose:i.onClose,onInteractOutside:v,children:[c.jsx(Ta,{onClose:i.onClose,selectedValue:s?.name,onSearch:a,searchPlaceholder:e("scc.labels.searchPlaceholder"),onHomeButtonClick:()=>{d("selectedSC"),d("selectedAction")}}),c.jsxs(Ga,{children:[c.jsx(Ha,{children:s?c.jsxs(c.Fragment,{children:[c.jsx(Wi,{sc:s,onRemoveContract:i.onRemoveContract},s.address),c.jsx(Ki,{actions:s.actions.filter(Ni(n))})]}):c.jsxs(c.Fragment,{children:[c.jsx(Gi,{}),c.jsxs("div",{children:[c.jsx(J,{variant:"tertiary",size:"lg",onClick:()=>{ve("newProposal_connectSmartContract_clicked",{dao_address:t}),i.onConnectNew()},className:"w-full",children:e("scc.labels.connect")}),c.jsx(Se,{external:!0,type:"primary",iconRight:O.LINK_EXTERNAL,href:e("scc.listContracts.learnLinkURL"),label:e("scc.listContracts.learnLinkLabel"),className:"mt-4 w-full justify-center"})]})]})}),c.jsx(Ja,{children:s?r?c.jsx(Ui,{actionIndex:i.actionIndex,onComposeButtonClicked:i.onComposeButtonClicked}):c.jsx(Ka,{selectedSC:s}):c.jsx(Wa,{})})]})]})},Ka=({selectedSC:i})=>{const{t:e}=V(),{setValue:t}=re();return c.jsx(Hi,{children:c.jsxs("div",{children:[c.jsx(vt,{objectIllustration:{object:"SMART_CONTRACT"},heading:e("scc.writeContractEmptyState.title"),description:e("scc.writeContractEmptyState.desc")}),i.implementationData&&c.jsx(J,{className:"mx-auto mt-6",size:"md",variant:"primary",iconLeft:O.BLOCKCHAIN_SMARTCONTRACT,onClick:()=>{t("selectedSC",i.implementationData),t("selectedAction",i.implementationData.actions.filter(s=>s.type==="function"&&(s.stateMutability==="payable"||s.stateMutability==="nonpayable"))?.[0])},children:e("scc.writeContractEmptyState.ctaLabel")})]})})},Wa=()=>{const{t:i}=V(),{network:e}=me();return c.jsx(Hi,{children:c.jsx(vt,{objectIllustration:{object:"SMART_CONTRACT"},heading:i("scc.selectionEmptyState.title"),description:i("scc.selectionEmptyState.description",{networkName:H[e].name})})})},Ga=$.div.attrs({className:"flex flex-1 overflow-auto"})``,Ha=$.div.attrs({className:"flex flex-col justify-between overflow-auto p-6 w-80 bg-neutral-50 border-r border-neutral-100"})``,Ja=$.div.attrs({className:"overflow-auto flex-1"})``,Hi=$.div.attrs({className:"flex h-full bg-neutral-0 overflow-hidden pt-0 justify-center items-center"})``,Ya=$(ln).attrs({style:{position:"fixed",display:"flex",flexDirection:"column",top:"50%",left:"50%",transform:"translate(-50%, -50%)",borderRadius:12,width:"898px",height:"708px",outline:"none",overflow:"auto",boxShadow:`0px 24px 32px rgba(31, 41, 51, 0.04),
       0px 16px 24px rgba(31, 41, 51, 0.04),
       0px 4px 8px rgba(31, 41, 51, 0.04),
       0px 0px 1px rgba(31, 41, 51, 0.04)`}})``,Qa=i=>{const{t:e}=V(),{dao:t}=Be(),[s,r]=xe({name:["selectedSC","selectedAction"]}),[n,a]=A.useState(""),{setValue:o,getValues:l}=re(),d=l("contracts")||[],p=d.length===1?d[0]:null;return A.useEffect(()=>{o("selectedSC",p),p&&o("selectedAction",p.actions.filter(u=>u.type==="function"&&(u.stateMutability==="payable"||u.stateMutability==="nonpayable"))?.[0])},[p,o]),c.jsxs(dn,{isOpen:i.isOpen,onClose:i.onClose,children:[c.jsx(eo,{onClose:i.onClose,onBackButtonClicked:()=>{r?o("selectedAction",null):s!==null?o("selectedSC",null):i.onBackButtonClicked()},onSearch:a}),c.jsx(so,{children:r?s&&c.jsx(Ui,{actionIndex:i.actionIndex,onComposeButtonClicked:i.onComposeButtonClicked}):s?c.jsxs("div",{children:[c.jsx(Wi,{sc:s,onRemoveContract:i.onRemoveContract},s.address),c.jsx(Ki,{actions:s.actions.filter(Ni(n))})]}):c.jsxs(c.Fragment,{children:[d.length===0?c.jsx(Xa,{}):c.jsx(Gi,{}),c.jsxs("div",{children:[c.jsx(J,{variant:"tertiary",size:"lg",onClick:()=>{ve("newProposal_connectSmartContract_clicked",{dao_address:t}),i.onConnectNew()},className:"w-full",children:e("scc.labels.connect")}),c.jsx(Se,{external:!0,type:"primary",iconRight:O.LINK_EXTERNAL,href:e("scc.listContracts.learnLinkURL"),label:e("scc.listContracts.learnLinkLabel"),className:"mt-4 w-full justify-center"})]})]})})]})},Xa=()=>{const{t:i}=V(),{network:e}=me();return c.jsx(Za,{children:c.jsx(vt,{objectIllustration:{object:"SMART_CONTRACT"},heading:i("scc.selectionEmptyState.title"),description:i("scc.selectionEmptyState.description",{networkName:H[e].name})})})},Za=$.div.attrs({"data-test-id":"empty-container",className:"flex h-full bg-neutral-0 p-12 pt-0 justify-center items-center"})``,eo=i=>{const{t:e}=V(),t=xe({name:"selectedSC"});return c.jsxs(to,{children:[t?c.jsx(J,{variant:"tertiary",size:"sm",iconLeft:O.CHEVRON_LEFT,onClick:i.onBackButtonClicked}):c.jsx(J,{variant:"tertiary",size:"sm",iconLeft:O.HOME}),c.jsx(io,{type:"text",placeholder:e("scc.labels.searchPlaceholder"),onChange:s=>i.onSearch(s.target.value)}),c.jsx(J,{variant:"tertiary",size:"sm",iconLeft:O.CLOSE,onClick:i.onClose})]})},to=$.div.attrs({className:"flex items-center rounded-xl space-x-4 p-4 bg-neutral-0"})`
  box-shadow:
    0px 4px 8px rgba(31, 41, 51, 0.04),
    0px 0px 2px rgba(31, 41, 51, 0.06),
    0px 0px 1px rgba(31, 41, 51, 0.04);
`,so=$.div.attrs({className:"py-6 px-4 space-y-6 overflow-auto"})`
  max-height: 70vh;
`,io=$.input.attrs({className:"flex-1 text-neutral-300 bg-neutral-0 ft-text-base focus:outline-none"})``,ro=i=>{const{isDesktop:e}=xt();return e?c.jsx(Ba,{actionIndex:i.actionIndex,isOpen:i.isOpen,onClose:i.onClose,onConnectNew:i.onConnectNew,onBackButtonClicked:i.onBackButtonClicked,onComposeButtonClicked:i.onComposeButtonClicked,onRemoveContract:i.onRemoveContract}):c.jsx(Qa,{actionIndex:i.actionIndex,isOpen:i.isOpen,onClose:i.onClose,onConnectNew:i.onConnectNew,onBackButtonClicked:i.onBackButtonClicked,onComposeButtonClicked:i.onComposeButtonClicked,onRemoveContract:i.onRemoveContract})},no=i=>{const{t:e}=V(),{dao:t}=Be();return c.jsxs($e,{isOpen:i.isOpen,onClose:i.onClose,children:[c.jsx(st,{title:e("scc.emptyState.modalTitle"),onClose:i.onClose,onBackButtonClicked:i.onBackButtonClicked,showCloseButton:!0}),c.jsx(ao,{children:c.jsx(vt,{objectIllustration:{object:"SMART_CONTRACT"},heading:e("scc.emptyState.title"),description:e("scc.emptyState.description"),primaryButton:{label:e("scc.emptyState.ctaLabel"),onClick:()=>{ve("newProposal_connectSmartContract_clicked",{dao_address:t}),i.onConnectNew()}},secondaryButton:{label:e("navLinks.guide"),href:e("scc.emptyState.learnMore"),iconRight:O.LINK_EXTERNAL,target:"_blank"}})})]})},ao=$.div.attrs({className:"flex flex-col justify-center items-center overflow-hidden"})``,oo=({actionIndex:i})=>{const{address:e}=is(),[t,s]=A.useState(!0),[r,n]=A.useState(!1),[a,o]=A.useState(!1),{network:l}=me(),{setValue:d,getValues:p,resetField:u}=re(),v=xe({name:"contracts"}),{addAction:b,removeAction:y}=Ee(),{alert:x}=Fe();return A.useEffect(()=>{if(e){const C=hn(e,H[l].id);d("contracts",C)}},[e,l,d]),A.useEffect(()=>{v?.length>0&&!a&&(s(!1),n(!0))},[a,v?.length]),c.jsxs(c.Fragment,{children:[c.jsx(ro,{actionIndex:i,isOpen:r,onConnectNew:()=>{n(!1),o(!0)},onClose:()=>{d("selectedSC",null),d("selectedAction",null),n(!1),u("sccActions"),y(i)},onBackButtonClicked:()=>{d("selectedSC",null),d("selectedAction",null),n(!1),u("sccActions"),y(i)},onComposeButtonClicked:C=>{C||n(!1),C&&(x("Smart contract action added successfully"),b({name:"external_contract_modal"})),d("selectedSC",null),d("selectedAction",null)},onRemoveContract:C=>{d("selectedSC",null),d("selectedAction",null),u("sccActions"),un(C,e,H[l].id);const _=p("contracts"),h=_.findIndex(({address:g})=>g===C);h!==-1&&(_.splice(h,1),d("contracts",_))}}),c.jsx(no,{isOpen:t,onConnectNew:()=>{s(!1),o(!0)},onClose:()=>{s(!1),y(i)},onBackButtonClicked:()=>{s(!1),y(i)}}),c.jsx(Na,{isOpen:a,onVerificationSuccess:()=>{o(!1),n(!0)},onClose:()=>{o(!1),y(i)},onBackButtonClicked:()=>{o(!1),y(i)}})]})};function co({tokenName:i,tokenLogo:e,tokenSymbol:t,tokenBalance:s}){return c.jsxs(lo,{children:[c.jsx(ho,{children:c.jsx(pn,{size:"medium",src:e})}),c.jsxs(uo,{children:[c.jsx(po,{children:i}),c.jsx(go,{children:s?`${s} ${t}`:"-"})]})]})}const lo=$.div.attrs({className:`flex items-center gap-x-4 py-3 px-4
    bg-neutral-0 rounded-xl cursor-pointer
    hover:text-neutral-800 hover:bg-neutral-100`})``,ho=$.span``,uo=$.div.attrs({className:"flex overflow-hidden gap-x-4 w-full"})``,po=$.span.attrs({className:"ft-text-base font-semibold ft-text-base flex-1 text-left truncate text-neutral-600"})``,go=$.span.attrs({className:"ft-text-base font-normal flex-none w-1/3 text-neutral-500 text-right truncate"})``,mo={address:"",count:BigInt(0),decimals:18,imgUrl:"",symbol:"",name:""},fo=({isWallet:i=!0,tokenBalances:e,onTokenSelect:t})=>{const{t:s}=V(),{data:r}=ra(e),{isOpen:n,close:a}=Et("token"),[o,l]=A.useState(""),d=b=>{t({address:b.metadata.id,name:b.metadata.name,count:b.balance,imgUrl:b.metadata.imgUrl,symbol:b.metadata.symbol,decimals:b.metadata.decimals}),a()},p=A.useCallback(b=>{if(o!==""){const y=new RegExp(o,"i");return b?.metadata.name?.match(y)||b?.metadata.symbol?.match(y)}return!0},[o]),u=(b,y)=>{if(b.metadata.id===Ns||y.metadata.id===Ns)return 1;{const x=(b.metadata.name||"").toLowerCase(),C=(y.metadata.name||"").toLowerCase();return x.localeCompare(C)}},v=()=>{const b=r.filter(p).sort(u);return b.length===0&&o===""?c.jsxs(Co,{children:[c.jsx(So,{children:c.jsx(oe,{icon:O.APP_ASSETS,size:"lg"})}),c.jsx($s,{children:s("TokenModal.tokenNotAvailable")}),c.jsx(vo,{children:s(i?"TokenModal.tokenNotAvailableSubtitle":"TokenModal.tokenNotAvailableSubtitleDao")})]}):b.length===0?c.jsxs(Eo,{children:[c.jsx($s,{children:s("TokenModal.tokenNotFoundTitle")}),c.jsx(wo,{children:s(i?"TokenModal.tokenNotFoundSubtitle":"TokenModal.tokenNotFoundSubtitleDao")})]}):c.jsx(c.Fragment,{children:b.map(y=>c.jsx("div",{onClick:()=>d(y),children:c.jsx(co,{tokenName:y.metadata.name,tokenLogo:y.metadata.imgUrl,tokenSymbol:y.metadata.symbol,tokenBalance:mn(_i(y.balance,y.metadata.decimals))})},y.metadata.id))})};return c.jsx($e,{isOpen:n,onClose:a,"data-testid":"TokenMenu",children:c.jsxs(yo,{children:[c.jsx(gn,{value:o,onChange:b=>l(b.target.value),placeholder:s("placeHolders.searchTokens")}),c.jsx(bo,{children:c.jsx(v,{})}),c.jsx(xo,{variant:"tertiary",size:"lg",iconLeft:O.PLUS,onClick:()=>{t({...mo,symbol:o}),a()},children:"Add Custom Token"})]})})},yo=$.div.attrs({className:"space-y-6 p-6"})``,bo=$.div.attrs({className:"space-y-2 mt-2"})``,$s=$.h2.attrs({className:"text-base leading-normal font-semibold"})``,wo=$.h2.attrs({className:"text-sm leading-normal text-neutral-600"})``,vo=$.h2.attrs({className:"text-sm leading-normal text-center text-neutral-600"})``,xo=$(J).attrs({className:"w-full justify-center"})``,Eo=$.div.attrs({className:"space-y-1 mb-6"})``,Co=$.div.attrs({className:`flex flex-col items-center mb-6
    justify-center bg-neutral-100 py-6 px-4 rounded-xl`})``,So=$.div.attrs({className:"mb-3"})``;let Ao=class{constructor(e){this.client=e}},Io=class{constructor(e){this.opts=e}};const No="https://rpc.walletconnect.com/v1",ot={wc_authRequest:{req:{ttl:F.ONE_DAY,prompt:!0,tag:3e3},res:{ttl:F.ONE_DAY,prompt:!1,tag:3001}}},Tt={min:F.FIVE_MINUTES,max:F.SEVEN_DAYS},Ji="wc",_o=1,Fo="auth",Rs="authClient",ht=`${Ji}@1:${Fo}:`,Xe=`${ht}:PUB_KEY`;function cs(i){return i?.split(":")}function $o(i){const e=i&&cs(i);if(e)return e[3]}function Ro(i){const e=i&&cs(i);if(e)return e[2]+":"+e[3]}function js(i){const e=i&&cs(i);if(e)return e.pop()}async function jo(i,e,t,s,r){switch(t.t){case"eip191":return Oo(i,e,t.s);case"eip1271":return await To(i,e,t.s,s,r);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}function Oo(i,e,t){return ta(Mi(e),t).toLowerCase()===i.toLowerCase()}async function To(i,e,t,s,r){try{const n="0x1626ba7e",a="0000000000000000000000000000000000000000000000000000000000000040",o="0000000000000000000000000000000000000000000000000000000000000041",l=t.substring(2),d=Mi(e).substring(2),p=n+d+a+o+l,u=await fn(`${No}/?chainId=${s}&projectId=${r}`,{method:"POST",body:JSON.stringify({id:Po(),jsonrpc:"2.0",method:"eth_call",params:[{to:i,data:p},"latest"]})}),{result:v}=await u.json();return v?v.slice(0,n.length).toLowerCase()===n.toLowerCase():!1}catch(n){return console.error("isValidEip1271Signature: ",n),!1}}function Po(){return Date.now()+Math.floor(Math.random()*1e3)}function Yi(i){return i.getAll().filter(e=>"requester"in e)}function Qi(i,e){return Yi(i).find(t=>t.id===e)}function ko(i){const e=yn(i.aud),t=new RegExp(`${i.domain}`).test(i.aud),s=!!i.nonce,r=i.type?i.type==="eip4361":!0,n=i.expiry;if(n&&!bn(n,Tt)){const{message:a}=Fi("MISSING_OR_INVALID",`request() expiry: ${n}. Expiry must be a number (in seconds) between ${Tt.min} and ${Tt.max}`);throw new Error(a)}return!!(e&&t&&s&&r)}function Do(i,e){return!!Qi(e,i.id)}function Lo(i=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(i):new Uint8Array(i)}function Mo(i,e){if(i.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var r=0;r<i.length;r++){var n=i.charAt(r),a=n.charCodeAt(0);if(t[a]!==255)throw new TypeError(n+" is ambiguous");t[a]=r}var o=i.length,l=i.charAt(0),d=Math.log(o)/Math.log(256),p=Math.log(256)/Math.log(o);function u(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var x=0,C=0,_=0,h=y.length;_!==h&&y[_]===0;)_++,x++;for(var g=(h-_)*p+1>>>0,m=new Uint8Array(g);_!==h;){for(var f=y[_],w=0,I=g-1;(f!==0||w<C)&&I!==-1;I--,w++)f+=256*m[I]>>>0,m[I]=f%o>>>0,f=f/o>>>0;if(f!==0)throw new Error("Non-zero carry");C=w,_++}for(var E=g-C;E!==g&&m[E]===0;)E++;for(var R=l.repeat(x);E<g;++E)R+=i.charAt(m[E]);return R}function v(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var x=0;if(y[x]!==" "){for(var C=0,_=0;y[x]===l;)C++,x++;for(var h=(y.length-x)*d+1>>>0,g=new Uint8Array(h);y[x];){var m=t[y.charCodeAt(x)];if(m===255)return;for(var f=0,w=h-1;(m!==0||f<_)&&w!==-1;w--,f++)m+=o*g[w]>>>0,g[w]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");_=f,x++}if(y[x]!==" "){for(var I=h-_;I!==h&&g[I]===0;)I++;for(var E=new Uint8Array(C+(h-I)),R=C;I!==h;)E[R++]=g[I++];return E}}}function b(y){var x=v(y);if(x)return x;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:v,decode:b}}var Uo=Mo,qo=Uo;const Xi=i=>{if(i instanceof Uint8Array&&i.constructor.name==="Uint8Array")return i;if(i instanceof ArrayBuffer)return new Uint8Array(i);if(ArrayBuffer.isView(i))return new Uint8Array(i.buffer,i.byteOffset,i.byteLength);throw new Error("Unknown type, must be binary type")},Vo=i=>new TextEncoder().encode(i),zo=i=>new TextDecoder().decode(i);let Bo=class{constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Ko=class{constructor(e,t,s){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=s}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Zi(this,e)}},Wo=class{constructor(e){this.decoders=e}or(e){return Zi(this,e)}decode(e){const t=e[0],s=this.decoders[t];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Zi=(i,e)=>new Wo({...i.decoders||{[i.prefix]:i},...e.decoders||{[e.prefix]:e}});let Go=class{constructor(e,t,s,r){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=r,this.encoder=new Bo(e,t,s),this.decoder=new Ko(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const $t=({name:i,prefix:e,encode:t,decode:s})=>new Go(i,e,t,s),it=({prefix:i,name:e,alphabet:t})=>{const{encode:s,decode:r}=qo(t,e);return $t({prefix:i,name:e,encode:s,decode:n=>Xi(r(n))})},Ho=(i,e,t,s)=>{const r={};for(let p=0;p<e.length;++p)r[e[p]]=p;let n=i.length;for(;i[n-1]==="=";)--n;const a=new Uint8Array(n*t/8|0);let o=0,l=0,d=0;for(let p=0;p<n;++p){const u=r[i[p]];if(u===void 0)throw new SyntaxError(`Non-${s} character`);l=l<<t|u,o+=t,o>=8&&(o-=8,a[d++]=255&l>>o)}if(o>=t||255&l<<8-o)throw new SyntaxError("Unexpected end of data");return a},Jo=(i,e,t)=>{const s=e[e.length-1]==="=",r=(1<<t)-1;let n="",a=0,o=0;for(let l=0;l<i.length;++l)for(o=o<<8|i[l],a+=8;a>t;)a-=t,n+=e[r&o>>a];if(a&&(n+=e[r&o<<t-a]),s)for(;n.length*t&7;)n+="=";return n},ee=({name:i,prefix:e,bitsPerChar:t,alphabet:s})=>$t({prefix:e,name:i,encode(r){return Jo(r,s,t)},decode(r){return Ho(r,s,t,i)}}),Yo=$t({prefix:"\0",name:"identity",encode:i=>zo(i),decode:i=>Vo(i)});var Qo=Object.freeze({__proto__:null,identity:Yo});const Xo=ee({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Zo=Object.freeze({__proto__:null,base2:Xo});const ec=ee({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var tc=Object.freeze({__proto__:null,base8:ec});const sc=it({prefix:"9",name:"base10",alphabet:"0123456789"});var ic=Object.freeze({__proto__:null,base10:sc});const rc=ee({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),nc=ee({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ac=Object.freeze({__proto__:null,base16:rc,base16upper:nc});const oc=ee({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),cc=ee({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),lc=ee({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),dc=ee({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),hc=ee({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),uc=ee({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),pc=ee({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),gc=ee({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),mc=ee({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var fc=Object.freeze({__proto__:null,base32:oc,base32upper:cc,base32pad:lc,base32padupper:dc,base32hex:hc,base32hexupper:uc,base32hexpad:pc,base32hexpadupper:gc,base32z:mc});const yc=it({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),bc=it({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var wc=Object.freeze({__proto__:null,base36:yc,base36upper:bc});const vc=it({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),xc=it({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ec=Object.freeze({__proto__:null,base58btc:vc,base58flickr:xc});const Cc=ee({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Sc=ee({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Ac=ee({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ic=ee({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Nc=Object.freeze({__proto__:null,base64:Cc,base64pad:Sc,base64url:Ac,base64urlpad:Ic});const er=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),_c=er.reduce((i,e,t)=>(i[t]=e,i),[]),Fc=er.reduce((i,e,t)=>(i[e.codePointAt(0)]=t,i),[]);function $c(i){return i.reduce((e,t)=>(e+=_c[t],e),"")}function Rc(i){const e=[];for(const t of i){const s=Fc[t.codePointAt(0)];if(s===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const jc=$t({prefix:"🚀",name:"base256emoji",encode:$c,decode:Rc});var Oc=Object.freeze({__proto__:null,base256emoji:jc}),Tc=tr,Os=128,Pc=127,kc=~Pc,Dc=Math.pow(2,31);function tr(i,e,t){e=e||[],t=t||0;for(var s=t;i>=Dc;)e[t++]=i&255|Os,i/=128;for(;i&kc;)e[t++]=i&255|Os,i>>>=7;return e[t]=i|0,tr.bytes=t-s+1,e}var Lc=Ht,Mc=128,Ts=127;function Ht(i,s){var t=0,s=s||0,r=0,n=s,a,o=i.length;do{if(n>=o)throw Ht.bytes=0,new RangeError("Could not decode varint");a=i[n++],t+=r<28?(a&Ts)<<r:(a&Ts)*Math.pow(2,r),r+=7}while(a>=Mc);return Ht.bytes=n-s,t}var Uc=Math.pow(2,7),qc=Math.pow(2,14),Vc=Math.pow(2,21),zc=Math.pow(2,28),Bc=Math.pow(2,35),Kc=Math.pow(2,42),Wc=Math.pow(2,49),Gc=Math.pow(2,56),Hc=Math.pow(2,63),Jc=function(i){return i<Uc?1:i<qc?2:i<Vc?3:i<zc?4:i<Bc?5:i<Kc?6:i<Wc?7:i<Gc?8:i<Hc?9:10},Yc={encode:Tc,decode:Lc,encodingLength:Jc},sr=Yc;const Ps=(i,e,t=0)=>(sr.encode(i,e,t),e),ks=i=>sr.encodingLength(i),Jt=(i,e)=>{const t=e.byteLength,s=ks(i),r=s+ks(t),n=new Uint8Array(r+t);return Ps(i,n,0),Ps(t,n,s),n.set(e,r),new Qc(i,t,e,n)};let Qc=class{constructor(e,t,s,r){this.code=e,this.size=t,this.digest=s,this.bytes=r}};const ir=({name:i,code:e,encode:t})=>new Xc(i,e,t);let Xc=class{constructor(e,t,s){this.name=e,this.code=t,this.encode=s}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Jt(this.code,t):t.then(s=>Jt(this.code,s))}else throw Error("Unknown type, must be binary type")}};const rr=i=>async e=>new Uint8Array(await crypto.subtle.digest(i,e)),Zc=ir({name:"sha2-256",code:18,encode:rr("SHA-256")}),el=ir({name:"sha2-512",code:19,encode:rr("SHA-512")});var tl=Object.freeze({__proto__:null,sha256:Zc,sha512:el});const nr=0,sl="identity",ar=Xi,il=i=>Jt(nr,ar(i)),rl={code:nr,name:sl,encode:ar,digest:il};var nl=Object.freeze({__proto__:null,identity:rl});new TextEncoder,new TextDecoder;const Ds={...Qo,...Zo,...tc,...ic,...ac,...fc,...wc,...Ec,...Nc,...Oc};({...tl,...nl});function or(i,e,t,s){return{name:i,prefix:e,encoder:{name:i,prefix:e,encode:t},decoder:{decode:s}}}const Ls=or("utf8","u",i=>"u"+new TextDecoder("utf8").decode(i),i=>new TextEncoder().encode(i.substring(1))),Pt=or("ascii","a",i=>{let e="a";for(let t=0;t<i.length;t++)e+=String.fromCharCode(i[t]);return e},i=>{i=i.substring(1);const e=Lo(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}),cr={utf8:Ls,"utf-8":Ls,hex:Ds.base16,latin1:Pt,ascii:Pt,binary:Pt,...Ds};function al(i,e="utf8"){const t=cr[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(i,"utf8"):t.decoder.decode(`${t.prefix}${i}`)}function ol(i,e="utf8"){const t=cr[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(i.buffer,i.byteOffset,i.byteLength).toString("utf8"):t.encoder.encode(i).substring(1)}const cl="base16",ll="utf8";function dl(i){const e=Ct.hash(al(i,ll));return ol(e,cl)}var hl=Object.defineProperty,ul=Object.defineProperties,pl=Object.getOwnPropertyDescriptors,Ms=Object.getOwnPropertySymbols,gl=Object.prototype.hasOwnProperty,ml=Object.prototype.propertyIsEnumerable,Us=(i,e,t)=>e in i?hl(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,kt=(i,e)=>{for(var t in e||(e={}))gl.call(e,t)&&Us(i,t,e[t]);if(Ms)for(var t of Ms(e))ml.call(e,t)&&Us(i,t,e[t]);return i},fl=(i,e)=>ul(i,pl(e));class yl extends Ao{constructor(e){super(e),this.initialized=!1,this.name="authEngine",this.init=()=>{this.initialized||(this.registerRelayerEvents(),this.client.core.pairing.register({methods:Object.keys(ot)}),this.initialized=!0)},this.request=async(t,s)=>{if(this.isInitialized(),!ko(t))throw new Error("Invalid request");if(s!=null&&s.topic)return await this.requestOnKnownPairing(s.topic,t);const{chainId:r,statement:n,aud:a,domain:o,nonce:l,type:d}=t,{topic:p,uri:u}=await this.client.core.pairing.create();this.client.logger.info({message:"Generated new pairing",pairing:{topic:p,uri:u}});const v=await this.client.core.crypto.generateKeyPair(),b=vs(v);await this.client.authKeys.set(Xe,{responseTopic:b,publicKey:v}),await this.client.pairingTopics.set(b,{topic:b,pairingTopic:p}),await this.client.core.relayer.subscribe(b),this.client.logger.info(`sending request to new pairing topic: ${p}`);const y=await this.sendRequest(p,"wc_authRequest",{payloadParams:{type:d??"eip4361",chainId:r,statement:n,aud:a,domain:o,version:"1",nonce:l,iat:new Date().toISOString()},requester:{publicKey:v,metadata:this.client.metadata}},{},t.expiry);return this.client.logger.info(`sent request to new pairing topic: ${p}`),{uri:u,id:y}},this.respond=async(t,s)=>{if(this.isInitialized(),!Do(t,this.client.requests))throw new Error("Invalid response");const r=Qi(this.client.requests,t.id),n=r.requester.publicKey,a=await this.client.core.crypto.generateKeyPair(),o=vs(n),l={type:wn,receiverPublicKey:n,senderPublicKey:a};if("error"in t){await this.sendError(r.id,o,t,l);return}const d={h:{t:"eip4361"},p:fl(kt({},r.cacaoPayload),{iss:s}),s:t.signature},p=await this.sendResult(r.id,o,d,l);await this.client.requests.update(p,kt({},d))},this.getPendingRequests=()=>Yi(this.client.requests),this.formatMessage=(t,s)=>{this.client.logger.debug(`formatMessage, cacao is: ${JSON.stringify(t)}`);const r=`${t.domain} wants you to sign in with your Ethereum account:`,n=js(s),a=t.statement,o=`URI: ${t.aud}`,l=`Version: ${t.version}`,d=`Chain ID: ${$o(s)}`,p=`Nonce: ${t.nonce}`,u=`Issued At: ${t.iat}`,v=t.resources&&t.resources.length>0?`Resources:
${t.resources.map(b=>`- ${b}`).join(`
`)}`:void 0;return[r,n,"",a,"",o,l,d,p,u,v].filter(b=>b!=null).join(`
`)},this.setExpiry=async(t,s)=>{this.client.core.pairing.pairings.keys.includes(t)&&await this.client.core.pairing.updateExpiry({topic:t,expiry:s}),this.client.core.expirer.set(t,s)},this.sendRequest=async(t,s,r,n,a)=>{const o=_t(s,r),l=await this.client.core.crypto.encode(t,o,n),d=ot[s].req;return a&&(d.ttl=a),this.client.core.history.set(t,o),await this.client.core.relayer.publish(t,l,d),o.id},this.sendResult=async(t,s,r,n)=>{const a=Ft(t,r),o=await this.client.core.crypto.encode(s,a,n),l=await this.client.core.history.get(s,t),d=ot[l.request.method].res;return await this.client.core.relayer.publish(s,o,d),await this.client.core.history.resolve(a),a.id},this.sendError=async(t,s,r,n)=>{const a=os(t,r.error),o=await this.client.core.crypto.encode(s,a,n),l=await this.client.core.history.get(s,t),d=ot[l.request.method].res;return await this.client.core.relayer.publish(s,o,d),await this.client.core.history.resolve(a),a.id},this.requestOnKnownPairing=async(t,s)=>{const r=this.client.core.pairing.pairings.getAll({active:!0}).find(b=>b.topic===t);if(!r)throw new Error(`Could not find pairing for provided topic ${t}`);const{publicKey:n}=this.client.authKeys.get(Xe),{chainId:a,statement:o,aud:l,domain:d,nonce:p,type:u}=s,v=await this.sendRequest(r.topic,"wc_authRequest",{payloadParams:{type:u??"eip4361",chainId:a,statement:o,aud:l,domain:d,version:"1",nonce:p,iat:new Date().toISOString()},requester:{publicKey:n,metadata:this.client.metadata}},{},s.expiry);return this.client.logger.info(`sent request to known pairing topic: ${r.topic}`),{id:v}},this.onRelayEventRequest=t=>{const{topic:s,payload:r}=t,n=r.method;switch(n){case"wc_authRequest":return this.onAuthRequest(s,r);default:return this.client.logger.info(`Unsupported request method ${n}`)}},this.onRelayEventResponse=async t=>{const{topic:s,payload:r}=t,n=(await this.client.core.history.get(s,r.id)).request.method;switch(n){case"wc_authRequest":return this.onAuthResponse(s,r);default:return this.client.logger.info(`Unsupported response method ${n}`)}},this.onAuthRequest=async(t,s)=>{const{requester:r,payloadParams:{resources:n,statement:a,aud:o,domain:l,version:d,nonce:p,iat:u,chainId:v}}=s.params;this.client.logger.info({type:"onAuthRequest",topic:t,payload:s});try{const b={aud:o,domain:l,version:d,nonce:p,iat:u,statement:a,resources:n,chainId:v};await this.client.requests.set(s.id,{requester:r,pairingTopic:t,id:s.id,cacaoPayload:b});const y=dl(JSON.stringify(s)),x=await this.getVerifyContext(y,this.client.metadata);this.client.emit("auth_request",{id:s.id,topic:t,params:{requester:r,cacaoPayload:b},verifyContext:x})}catch(b){await this.sendError(s.id,t,b),this.client.logger.error(b)}},this.onAuthResponse=async(t,s)=>{const{id:r}=s;if(this.client.logger.info({type:"onAuthResponse",topic:t,response:s}),Ce(s)){const{pairingTopic:n}=this.client.pairingTopics.get(t);await this.client.core.pairing.activate({topic:n});const{s:a,p:o}=s.result;await this.client.requests.set(r,kt({id:r,pairingTopic:n},s.result));const l=this.formatMessage(o,o.iss);this.client.logger.debug(`reconstructed message:
`,JSON.stringify(l)),this.client.logger.debug("payload.iss:",o.iss),this.client.logger.debug("signature:",a);const d=js(o.iss),p=Ro(o.iss);if(!d)throw new Error("Could not derive address from `payload.iss`");if(!p)throw new Error("Could not derive chainId from `payload.iss`");this.client.logger.debug("walletAddress extracted from `payload.iss`:",d),await jo(d,l,a,p,this.client.projectId)?this.client.emit("auth_response",{id:r,topic:t,params:s}):this.client.emit("auth_response",{id:r,topic:t,params:{message:"Invalid signature",code:-1}})}else be(s)&&this.client.emit("auth_response",{id:r,topic:t,params:s})},this.getVerifyContext=async(t,s)=>{const r={verified:{verifyUrl:s.verifyUrl||"",validation:"UNKNOWN",origin:s.url||""}};try{const n=await this.client.core.verify.resolve({attestationId:t,verifyUrl:s.verifyUrl});n&&(r.verified.origin=n,r.verified.validation=n===s.url?"VALID":"INVALID")}catch(n){this.client.logger.error(n)}return this.client.logger.info(`Verify context: ${JSON.stringify(r)}`),r}}isInitialized(){if(!this.initialized){const{message:e}=Fi("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.client.core.relayer.on(aa.message,async e=>{const{topic:t,message:s}=e,{responseTopic:r,publicKey:n}=this.client.authKeys.keys.includes(Xe)?this.client.authKeys.get(Xe):{responseTopic:void 0,publicKey:void 0};if(r&&t!==r){this.client.logger.debug("[Auth] Ignoring message from unknown topic",t);return}const a=await this.client.core.crypto.decode(t,s,{receiverPublicKey:n});It(a)?(this.client.core.history.set(t,a),this.onRelayEventRequest({topic:t,payload:a})):Nt(a)&&(await this.client.core.history.resolve(a),this.onRelayEventResponse({topic:t,payload:a}))})}}let bl=class lr extends Io{constructor(e){super(e),this.protocol=Ji,this.version=_o,this.name=Rs,this.events=new Re.EventEmitter,this.emit=(s,r)=>this.events.emit(s,r),this.on=(s,r)=>this.events.on(s,r),this.once=(s,r)=>this.events.once(s,r),this.off=(s,r)=>this.events.off(s,r),this.removeListener=(s,r)=>this.events.removeListener(s,r),this.request=async(s,r)=>{try{return await this.engine.request(s,r)}catch(n){throw this.logger.error(n.message),n}},this.respond=async(s,r)=>{try{return await this.engine.respond(s,r)}catch(n){throw this.logger.error(n.message),n}},this.getPendingRequests=()=>{try{return this.engine.getPendingRequests()}catch(s){throw this.logger.error(s.message),s}},this.formatMessage=(s,r)=>{try{return this.engine.formatMessage(s,r)}catch(n){throw this.logger.error(n.message),n}};const t=typeof e.logger<"u"&&typeof e.logger!="string"?e.logger:T.pino(T.getDefaultLoggerOptions({level:e.logger||"error"}));this.name=e?.name||Rs,this.metadata=e.metadata,this.projectId=e.projectId,this.core=e.core||new qi(e),this.logger=T.generateChildLogger(t,this.name),this.authKeys=new Ot(this.core,this.logger,"authKeys",ht,()=>Xe),this.pairingTopics=new Ot(this.core,this.logger,"pairingTopics",ht),this.requests=new Ot(this.core,this.logger,"requests",ht),this.engine=new yl(this)}static async init(e){const t=new lr(e);return await t.initialize(),t}get context(){return T.getLoggerContext(this.logger)}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.authKeys.init(),await this.requests.init(),await this.pairingTopics.init(),await this.engine.init(),this.logger.info("AuthClient Initialization Success"),this.logger.info({authClient:this})}catch(e){throw this.logger.info("AuthClient Initialization Failure"),this.logger.error(e.message),e}}};const wl=bl;class vl extends Ke{constructor(e){super(),this.opts=e,this.protocol="wc",this.version=2}}class xl extends Ke{constructor(e,t){super(),this.core=e,this.logger=t,this.records=new Map}}class El{constructor(e,t){this.logger=e,this.core=t}}let Cl=class extends Ke{constructor(e,t){super(),this.relayer=e,this.logger=t}},Sl=class extends Ke{constructor(e){super()}},Al=class{constructor(e,t,s,r){this.core=e,this.logger=t,this.name=s}},Il=class extends Ke{constructor(e,t){super(),this.relayer=e,this.logger=t}},Nl=class extends Ke{constructor(e,t){super(),this.core=e,this.logger=t}},_l=class{constructor(e,t){this.projectId=e,this.logger=t}},Fl=class{constructor(e){this.opts=e,this.protocol="wc",this.version=2}},$l=class{constructor(e){this.client=e}};var et={};(function(i){const e=En,t=Cn,s=vn,r=xn,n=h=>h==null,a=Symbol("encodeFragmentIdentifier");function o(h){switch(h.arrayFormat){case"index":return g=>(m,f)=>{const w=m.length;return f===void 0||h.skipNull&&f===null||h.skipEmptyString&&f===""?m:f===null?[...m,[p(g,h),"[",w,"]"].join("")]:[...m,[p(g,h),"[",p(w,h),"]=",p(f,h)].join("")]};case"bracket":return g=>(m,f)=>f===void 0||h.skipNull&&f===null||h.skipEmptyString&&f===""?m:f===null?[...m,[p(g,h),"[]"].join("")]:[...m,[p(g,h),"[]=",p(f,h)].join("")];case"colon-list-separator":return g=>(m,f)=>f===void 0||h.skipNull&&f===null||h.skipEmptyString&&f===""?m:f===null?[...m,[p(g,h),":list="].join("")]:[...m,[p(g,h),":list=",p(f,h)].join("")];case"comma":case"separator":case"bracket-separator":{const g=h.arrayFormat==="bracket-separator"?"[]=":"=";return m=>(f,w)=>w===void 0||h.skipNull&&w===null||h.skipEmptyString&&w===""?f:(w=w===null?"":w,f.length===0?[[p(m,h),g,p(w,h)].join("")]:[[f,p(w,h)].join(h.arrayFormatSeparator)])}default:return g=>(m,f)=>f===void 0||h.skipNull&&f===null||h.skipEmptyString&&f===""?m:f===null?[...m,p(g,h)]:[...m,[p(g,h),"=",p(f,h)].join("")]}}function l(h){let g;switch(h.arrayFormat){case"index":return(m,f,w)=>{if(g=/\[(\d*)\]$/.exec(m),m=m.replace(/\[\d*\]$/,""),!g){w[m]=f;return}w[m]===void 0&&(w[m]={}),w[m][g[1]]=f};case"bracket":return(m,f,w)=>{if(g=/(\[\])$/.exec(m),m=m.replace(/\[\]$/,""),!g){w[m]=f;return}if(w[m]===void 0){w[m]=[f];return}w[m]=[].concat(w[m],f)};case"colon-list-separator":return(m,f,w)=>{if(g=/(:list)$/.exec(m),m=m.replace(/:list$/,""),!g){w[m]=f;return}if(w[m]===void 0){w[m]=[f];return}w[m]=[].concat(w[m],f)};case"comma":case"separator":return(m,f,w)=>{const I=typeof f=="string"&&f.includes(h.arrayFormatSeparator),E=typeof f=="string"&&!I&&u(f,h).includes(h.arrayFormatSeparator);f=E?u(f,h):f;const R=I||E?f.split(h.arrayFormatSeparator).map(B=>u(B,h)):f===null?f:u(f,h);w[m]=R};case"bracket-separator":return(m,f,w)=>{const I=/(\[\])$/.test(m);if(m=m.replace(/\[\]$/,""),!I){w[m]=f&&u(f,h);return}const E=f===null?[]:f.split(h.arrayFormatSeparator).map(R=>u(R,h));if(w[m]===void 0){w[m]=E;return}w[m]=[].concat(w[m],E)};default:return(m,f,w)=>{if(w[m]===void 0){w[m]=f;return}w[m]=[].concat(w[m],f)}}}function d(h){if(typeof h!="string"||h.length!==1)throw new TypeError("arrayFormatSeparator must be single character string")}function p(h,g){return g.encode?g.strict?e(h):encodeURIComponent(h):h}function u(h,g){return g.decode?t(h):h}function v(h){return Array.isArray(h)?h.sort():typeof h=="object"?v(Object.keys(h)).sort((g,m)=>Number(g)-Number(m)).map(g=>h[g]):h}function b(h){const g=h.indexOf("#");return g!==-1&&(h=h.slice(0,g)),h}function y(h){let g="";const m=h.indexOf("#");return m!==-1&&(g=h.slice(m)),g}function x(h){h=b(h);const g=h.indexOf("?");return g===-1?"":h.slice(g+1)}function C(h,g){return g.parseNumbers&&!Number.isNaN(Number(h))&&typeof h=="string"&&h.trim()!==""?h=Number(h):g.parseBooleans&&h!==null&&(h.toLowerCase()==="true"||h.toLowerCase()==="false")&&(h=h.toLowerCase()==="true"),h}function _(h,g){g=Object.assign({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},g),d(g.arrayFormatSeparator);const m=l(g),f=Object.create(null);if(typeof h!="string"||(h=h.trim().replace(/^[?#&]/,""),!h))return f;for(const w of h.split("&")){if(w==="")continue;let[I,E]=s(g.decode?w.replace(/\+/g," "):w,"=");E=E===void 0?null:["comma","separator","bracket-separator"].includes(g.arrayFormat)?E:u(E,g),m(u(I,g),E,f)}for(const w of Object.keys(f)){const I=f[w];if(typeof I=="object"&&I!==null)for(const E of Object.keys(I))I[E]=C(I[E],g);else f[w]=C(I,g)}return g.sort===!1?f:(g.sort===!0?Object.keys(f).sort():Object.keys(f).sort(g.sort)).reduce((w,I)=>{const E=f[I];return E&&typeof E=="object"&&!Array.isArray(E)?w[I]=v(E):w[I]=E,w},Object.create(null))}i.extract=x,i.parse=_,i.stringify=(h,g)=>{if(!h)return"";g=Object.assign({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},g),d(g.arrayFormatSeparator);const m=E=>g.skipNull&&n(h[E])||g.skipEmptyString&&h[E]==="",f=o(g),w={};for(const E of Object.keys(h))m(E)||(w[E]=h[E]);const I=Object.keys(w);return g.sort!==!1&&I.sort(g.sort),I.map(E=>{const R=h[E];return R===void 0?"":R===null?p(E,g):Array.isArray(R)?R.length===0&&g.arrayFormat==="bracket-separator"?p(E,g)+"[]":R.reduce(f(E),[]).join("&"):p(E,g)+"="+p(R,g)}).filter(E=>E.length>0).join("&")},i.parseUrl=(h,g)=>{g=Object.assign({decode:!0},g);const[m,f]=s(h,"#");return Object.assign({url:m.split("?")[0]||"",query:_(x(h),g)},g&&g.parseFragmentIdentifier&&f?{fragmentIdentifier:u(f,g)}:{})},i.stringifyUrl=(h,g)=>{g=Object.assign({encode:!0,strict:!0,[a]:!0},g);const m=b(h.url).split("?")[0]||"",f=i.extract(h.url),w=i.parse(f,{sort:!1}),I=Object.assign(w,h.query);let E=i.stringify(I,g);E&&(E=`?${E}`);let R=y(h.url);return h.fragmentIdentifier&&(R=`#${g[a]?p(h.fragmentIdentifier,g):h.fragmentIdentifier}`),`${m}${E}${R}`},i.pick=(h,g,m)=>{m=Object.assign({parseFragmentIdentifier:!0,[a]:!1},m);const{url:f,query:w,fragmentIdentifier:I}=i.parseUrl(h,m);return i.stringifyUrl({url:f,query:r(w,g),fragmentIdentifier:I},m)},i.exclude=(h,g,m)=>{const f=Array.isArray(g)?w=>!g.includes(w):(w,I)=>!g(w,I);return i.pick(h,f,m)}})(et);function dr(i,e){return i.includes(":")?[i]:e.chains||[]}const hr="base10",ie="base16",Yt="base64pad",ls="utf8",ur=0,De=1,Rl=0,qs=1,Qt=12,ds=32;function jl(){const i=Ri.generateKeyPair();return{privateKey:ue(i.secretKey,ie),publicKey:ue(i.publicKey,ie)}}function Xt(){const i=ji.randomBytes(ds);return ue(i,ie)}function Ol(i,e){const t=Ri.sharedKey(ge(i,ie),ge(e,ie)),s=new An(Ct.SHA256,t).expand(ds);return ue(s,ie)}function Tl(i){const e=Ct.hash(ge(i,ie));return ue(e,ie)}function qe(i){const e=Ct.hash(ge(i,ls));return ue(e,ie)}function Pl(i){return ge(`${i}`,hr)}function rt(i){return Number(ue(i,hr))}function kl(i){const e=Pl(typeof i.type<"u"?i.type:ur);if(rt(e)===De&&typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");const t=typeof i.senderPublicKey<"u"?ge(i.senderPublicKey,ie):void 0,s=typeof i.iv<"u"?ge(i.iv,ie):ji.randomBytes(Qt),r=new Oi.ChaCha20Poly1305(ge(i.symKey,ie)).seal(s,ge(i.message,ls));return Ll({type:e,sealed:r,iv:s,senderPublicKey:t})}function Dl(i){const e=new Oi.ChaCha20Poly1305(ge(i.symKey,ie)),{sealed:t,iv:s}=ft(i.encoded),r=e.open(s,t);if(r===null)throw new Error("Failed to decrypt");return ue(r,ls)}function Ll(i){if(rt(i.type)===De){if(typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return ue(xs([i.type,i.senderPublicKey,i.iv,i.sealed]),Yt)}return ue(xs([i.type,i.iv,i.sealed]),Yt)}function ft(i){const e=ge(i,Yt),t=e.slice(Rl,qs),s=qs;if(rt(t)===De){const o=s+ds,l=o+Qt,d=e.slice(s,o),p=e.slice(o,l),u=e.slice(l);return{type:t,sealed:u,iv:p,senderPublicKey:d}}const r=s+Qt,n=e.slice(s,r),a=e.slice(r);return{type:t,sealed:a,iv:n}}function Ml(i,e){const t=ft(i);return pr({type:rt(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?ue(t.senderPublicKey,ie):void 0,receiverPublicKey:e?.receiverPublicKey})}function pr(i){const e=i?.type||ur;if(e===De){if(typeof i?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof i?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:i?.senderPublicKey,receiverPublicKey:i?.receiverPublicKey}}function Vs(i){return i.type===De&&typeof i.senderPublicKey=="string"&&typeof i.receiverPublicKey=="string"}var Ul=Object.defineProperty,zs=Object.getOwnPropertySymbols,ql=Object.prototype.hasOwnProperty,Vl=Object.prototype.propertyIsEnumerable,Bs=(i,e,t)=>e in i?Ul(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ks=(i,e)=>{for(var t in e||(e={}))ql.call(e,t)&&Bs(i,t,e[t]);if(zs)for(var t of zs(e))Vl.call(e,t)&&Bs(i,t,e[t]);return i};const zl="ReactNative",Te={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"},Bl="js";function hs(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function gr(){return!In()&&!!$i()&&navigator.product===zl}function us(){return!hs()&&!!$i()}function mr(){return gr()?Te.reactNative:hs()?Te.node:us()?Te.browser:Te.unknown}function Kl(i,e){let t=et.parse(i);return t=Ks(Ks({},t),e),i=et.stringify(t),i}function Wl(){return Sn()||{name:"",description:"",url:"",icons:[""]}}function Gl(){if(typeof(global==null?void 0:global.Platform)<"u"){const{OS:t,Version:s}=global.Platform;return[t,s].join("-")}const i=Nn();if(i===null)return"unknown";const e=i.os?i.os.replace(" ","").toLowerCase():"unknown";return i.type==="browser"?[e,i.name,i.version].join("-"):[e,i.version].join("-")}function Hl(){var i;const e=mr();return e===Te.browser?[e,((i=_n())==null?void 0:i.host)||"unknown"].join(":"):e}function Jl(i,e,t){const s=Gl(),r=Hl();return[[i,e].join("-"),[Bl,t].join("-"),s,r].join("/")}function Yl({protocol:i,version:e,relayUrl:t,sdkVersion:s,auth:r,projectId:n,useOnCloseEvent:a}){const o=t.split("?"),l=Jl(i,e,s),d={auth:r,ua:l,projectId:n,useOnCloseEvent:a||void 0},p=Kl(o[1]||"",d);return o[0]+"?"+p}function Pe(i,e){return i.filter(t=>e.includes(t)).length===i.length}function fr(i){return Object.fromEntries(i.entries())}function yr(i){return new Map(Object.entries(i))}function Me(i=F.FIVE_MINUTES,e){const t=F.toMiliseconds(i||F.FIVE_MINUTES);let s,r,n;return{resolve:a=>{n&&s&&(clearTimeout(n),s(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,o)=>{n=setTimeout(()=>{o(new Error(e))},t),s=a,r=o})}}function yt(i,e,t){return new Promise(async(s,r)=>{const n=setTimeout(()=>r(new Error(t)),e);try{const a=await i;s(a)}catch(a){r(a)}clearTimeout(n)})}function br(i,e){if(typeof e=="string"&&e.startsWith(`${i}:`))return e;if(i.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(i.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${i}`)}function Ql(i){return br("topic",i)}function Xl(i){return br("id",i)}function wr(i){const[e,t]=i.split(":"),s={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")s.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))s.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return s}function we(i,e){return F.fromMiliseconds((e||Date.now())+F.toMiliseconds(i))}function Ne(i){return Date.now()>=F.toMiliseconds(i)}function G(i,e){return`${i}${e?`:${e}`:""}`}async function Zl({id:i,topic:e,wcDeepLink:t}){try{if(!t)return;let r=(typeof t=="string"?JSON.parse(t):t)?.href;if(typeof r!="string")return;r.endsWith("/")&&(r=r.slice(0,-1));const n=`${r}/wc?requestId=${i}&sessionTopic=${e}`,a=mr();a===Te.browser?window.open(n,"_self","noreferrer noopener"):a===Te.reactNative&&typeof(global==null?void 0:global.Linking)<"u"&&await global.Linking.openURL(n)}catch(s){console.error(s)}}const ed="irn";function Zt(i){return i?.relay||{protocol:ed}}function ut(i){const e=Fn[i];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${i}`);return e}var td=Object.defineProperty,Ws=Object.getOwnPropertySymbols,sd=Object.prototype.hasOwnProperty,id=Object.prototype.propertyIsEnumerable,Gs=(i,e,t)=>e in i?td(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,rd=(i,e)=>{for(var t in e||(e={}))sd.call(e,t)&&Gs(i,t,e[t]);if(Ws)for(var t of Ws(e))id.call(e,t)&&Gs(i,t,e[t]);return i};function nd(i,e="-"){const t={},s="relay"+e;return Object.keys(i).forEach(r=>{if(r.startsWith(s)){const n=r.replace(s,""),a=i[r];t[n]=a}}),t}function ad(i){const e=i.indexOf(":"),t=i.indexOf("?")!==-1?i.indexOf("?"):void 0,s=i.substring(0,e),r=i.substring(e+1,t).split("@"),n=typeof t<"u"?i.substring(t):"",a=et.parse(n);return{protocol:s,topic:od(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:nd(a)}}function od(i){return i.startsWith("//")?i.substring(2):i}function cd(i,e="-"){const t="relay",s={};return Object.keys(i).forEach(r=>{const n=t+e+r;i[r]&&(s[n]=i[r])}),s}function ld(i){return`${i.protocol}:${i.topic}@${i.version}?`+et.stringify(rd({symKey:i.symKey},cd(i.relay)))}function We(i){const e=[];return i.forEach(t=>{const[s,r]=t.split(":");e.push(`${s}:${r}`)}),e}function dd(i){const e=[];return Object.values(i).forEach(t=>{e.push(...We(t.accounts))}),e}function hd(i,e){const t=[];return Object.values(i).forEach(s=>{We(s.accounts).includes(e)&&t.push(...s.methods)}),t}function ud(i,e){const t=[];return Object.values(i).forEach(s=>{We(s.accounts).includes(e)&&t.push(...s.events)}),t}function pd(i,e){const t=pt(i,e);if(t)throw new Error(t.message);const s={};for(const[r,n]of Object.entries(i))s[r]={methods:n.methods,events:n.events,chains:n.accounts.map(a=>`${a.split(":")[0]}:${a.split(":")[1]}`)};return s}const gd={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},md={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function S(i,e){const{message:t,code:s}=md[i];return{message:e?`${t} ${e}`:t,code:s}}function X(i,e){const{message:t,code:s}=gd[i];return{message:e?`${t} ${e}`:t,code:s}}function nt(i,e){return Array.isArray(i)?typeof e<"u"&&i.length?i.every(e):!0:!1}function Ze(i){return Object.getPrototypeOf(i)===Object.prototype&&Object.keys(i).length}function se(i){return typeof i>"u"}function Z(i,e){return e&&se(i)?!0:typeof i=="string"&&!!i.trim().length}function ps(i,e){return e&&se(i)?!0:typeof i=="number"&&!isNaN(i)}function fd(i,e){const{requiredNamespaces:t}=e,s=Object.keys(i.namespaces),r=Object.keys(t);let n=!0;return Pe(r,s)?(s.forEach(a=>{const{accounts:o,methods:l,events:d}=i.namespaces[a],p=We(o),u=t[a];(!Pe(dr(a,u),p)||!Pe(u.methods,l)||!Pe(u.events,d))&&(n=!1)}),n):!1}function gs(i){return Z(i,!1)&&i.includes(":")?i.split(":").length===2:!1}function yd(i){if(Z(i,!1)&&i.includes(":")){const e=i.split(":");if(e.length===3){const t=e[0]+":"+e[1];return!!e[2]&&gs(t)}}return!1}function bd(i){if(Z(i,!1))try{return typeof new URL(i)<"u"}catch{return!1}return!1}function wd(i){var e;return(e=i?.proposer)==null?void 0:e.publicKey}function vd(i){return i?.topic}function xd(i,e){let t=null;return Z(i?.publicKey,!1)||(t=S("MISSING_OR_INVALID",`${e} controller public key should be a string`)),t}function Hs(i){let e=!0;return nt(i)?i.length&&(e=i.every(t=>Z(t,!1))):e=!1,e}function Ed(i,e,t){let s=null;return nt(e)?e.forEach(r=>{s||(!gs(r)||!r.includes(i))&&(s=X("UNSUPPORTED_CHAINS",`${t}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):s=X("UNSUPPORTED_CHAINS",`${t}, chains ${e} should be an array of strings conforming to "namespace:chainId" format`),s}function Cd(i,e){let t=null;return Object.entries(i).forEach(([s,r])=>{if(t)return;const n=Ed(s,dr(s,r),`${e} requiredNamespace`);n&&(t=n)}),t}function Sd(i,e){let t=null;return nt(i)?i.forEach(s=>{t||yd(s)||(t=X("UNSUPPORTED_ACCOUNTS",`${e}, account ${s} should be a string and conform to "namespace:chainId:address" format`))}):t=X("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function Ad(i,e){let t=null;return Object.values(i).forEach(s=>{if(t)return;const r=Sd(s?.accounts,`${e} namespace`);r&&(t=r)}),t}function Id(i,e){let t=null;return Hs(i?.methods)?Hs(i?.events)||(t=X("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):t=X("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),t}function vr(i,e){let t=null;return Object.values(i).forEach(s=>{if(t)return;const r=Id(s,`${e}, namespace`);r&&(t=r)}),t}function Nd(i,e,t){let s=null;if(i&&Ze(i)){const r=vr(i,e);r&&(s=r);const n=Cd(i,e);n&&(s=n)}else s=S("MISSING_OR_INVALID",`${e}, ${t} should be an object with data`);return s}function pt(i,e){let t=null;if(i&&Ze(i)){const s=vr(i,e);s&&(t=s);const r=Ad(i,e);r&&(t=r)}else t=S("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return t}function xr(i){return Z(i.protocol,!0)}function _d(i,e){let t=!1;return e&&!i?t=!0:i&&nt(i)&&i.length&&i.forEach(s=>{t=xr(s)}),t}function Fd(i){return typeof i=="number"}function ae(i){return typeof i<"u"&&typeof i!==null}function $d(i){return!(!i||typeof i!="object"||!i.code||!ps(i.code,!1)||!i.message||!Z(i.message,!1))}function Rd(i){return!(se(i)||!Z(i.method,!1))}function jd(i){return!(se(i)||se(i.result)&&se(i.error)||!ps(i.id,!1)||!Z(i.jsonrpc,!1))}function Od(i){return!(se(i)||!Z(i.name,!1))}function Js(i,e){return!(!gs(e)||!dd(i).includes(e))}function Td(i,e,t){return Z(t,!1)?hd(i,e).includes(t):!1}function Pd(i,e,t){return Z(t,!1)?ud(i,e).includes(t):!1}function Ys(i,e,t){let s=null;const r=kd(i),n=Dd(e),a=Object.keys(r),o=Object.keys(n),l=Qs(Object.keys(i)),d=Qs(Object.keys(e)),p=l.filter(u=>!d.includes(u));return p.length&&(s=S("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${p.toString()}
      Received: ${Object.keys(e).toString()}`)),Pe(a,o)||(s=S("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${a.toString()}
      Approved: ${o.toString()}`)),Object.keys(e).forEach(u=>{if(!u.includes(":")||s)return;const v=We(e[u].accounts);v.includes(u)||(s=S("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${u}
        Required: ${u}
        Approved: ${v.toString()}`))}),a.forEach(u=>{s||(Pe(r[u].methods,n[u].methods)?Pe(r[u].events,n[u].events)||(s=S("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${u}`)):s=S("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${u}`))}),s}function kd(i){const e={};return Object.keys(i).forEach(t=>{var s;t.includes(":")?e[t]=i[t]:(s=i[t].chains)==null||s.forEach(r=>{e[r]={methods:i[t].methods,events:i[t].events}})}),e}function Qs(i){return[...new Set(i.map(e=>e.includes(":")?e.split(":")[0]:e))]}function Dd(i){const e={};return Object.keys(i).forEach(t=>{t.includes(":")?e[t]=i[t]:We(i[t].accounts)?.forEach(r=>{e[r]={accounts:i[t].accounts.filter(n=>n.includes(`${r}:`)),methods:i[t].methods,events:i[t].events}})}),e}function Ld(i,e){return ps(i,!1)&&i<=e.max&&i>=e.min}function Md(i,e){if(i.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var r=0;r<i.length;r++){var n=i.charAt(r),a=n.charCodeAt(0);if(t[a]!==255)throw new TypeError(n+" is ambiguous");t[a]=r}var o=i.length,l=i.charAt(0),d=Math.log(o)/Math.log(256),p=Math.log(256)/Math.log(o);function u(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var x=0,C=0,_=0,h=y.length;_!==h&&y[_]===0;)_++,x++;for(var g=(h-_)*p+1>>>0,m=new Uint8Array(g);_!==h;){for(var f=y[_],w=0,I=g-1;(f!==0||w<C)&&I!==-1;I--,w++)f+=256*m[I]>>>0,m[I]=f%o>>>0,f=f/o>>>0;if(f!==0)throw new Error("Non-zero carry");C=w,_++}for(var E=g-C;E!==g&&m[E]===0;)E++;for(var R=l.repeat(x);E<g;++E)R+=i.charAt(m[E]);return R}function v(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var x=0;if(y[x]!==" "){for(var C=0,_=0;y[x]===l;)C++,x++;for(var h=(y.length-x)*d+1>>>0,g=new Uint8Array(h);y[x];){var m=t[y.charCodeAt(x)];if(m===255)return;for(var f=0,w=h-1;(m!==0||f<_)&&w!==-1;w--,f++)m+=o*g[w]>>>0,g[w]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");_=f,x++}if(y[x]!==" "){for(var I=h-_;I!==h&&g[I]===0;)I++;for(var E=new Uint8Array(C+(h-I)),R=C;I!==h;)E[R++]=g[I++];return E}}}function b(y){var x=v(y);if(x)return x;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:v,decode:b}}var Ud=Md,qd=Ud;const Er=i=>{if(i instanceof Uint8Array&&i.constructor.name==="Uint8Array")return i;if(i instanceof ArrayBuffer)return new Uint8Array(i);if(ArrayBuffer.isView(i))return new Uint8Array(i.buffer,i.byteOffset,i.byteLength);throw new Error("Unknown type, must be binary type")},Vd=i=>new TextEncoder().encode(i),zd=i=>new TextDecoder().decode(i);class Bd{constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Kd{constructor(e,t,s){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=s}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Cr(this,e)}}class Wd{constructor(e){this.decoders=e}or(e){return Cr(this,e)}decode(e){const t=e[0],s=this.decoders[t];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const Cr=(i,e)=>new Wd({...i.decoders||{[i.prefix]:i},...e.decoders||{[e.prefix]:e}});class Gd{constructor(e,t,s,r){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=r,this.encoder=new Bd(e,t,s),this.decoder=new Kd(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Rt=({name:i,prefix:e,encode:t,decode:s})=>new Gd(i,e,t,s),at=({prefix:i,name:e,alphabet:t})=>{const{encode:s,decode:r}=qd(t,e);return Rt({prefix:i,name:e,encode:s,decode:n=>Er(r(n))})},Hd=(i,e,t,s)=>{const r={};for(let p=0;p<e.length;++p)r[e[p]]=p;let n=i.length;for(;i[n-1]==="=";)--n;const a=new Uint8Array(n*t/8|0);let o=0,l=0,d=0;for(let p=0;p<n;++p){const u=r[i[p]];if(u===void 0)throw new SyntaxError(`Non-${s} character`);l=l<<t|u,o+=t,o>=8&&(o-=8,a[d++]=255&l>>o)}if(o>=t||255&l<<8-o)throw new SyntaxError("Unexpected end of data");return a},Jd=(i,e,t)=>{const s=e[e.length-1]==="=",r=(1<<t)-1;let n="",a=0,o=0;for(let l=0;l<i.length;++l)for(o=o<<8|i[l],a+=8;a>t;)a-=t,n+=e[r&o>>a];if(a&&(n+=e[r&o<<t-a]),s)for(;n.length*t&7;)n+="=";return n},te=({name:i,prefix:e,bitsPerChar:t,alphabet:s})=>Rt({prefix:e,name:i,encode(r){return Jd(r,s,t)},decode(r){return Hd(r,s,t,i)}}),Yd=Rt({prefix:"\0",name:"identity",encode:i=>zd(i),decode:i=>Vd(i)});var Qd=Object.freeze({__proto__:null,identity:Yd});const Xd=te({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Zd=Object.freeze({__proto__:null,base2:Xd});const eh=te({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var th=Object.freeze({__proto__:null,base8:eh});const sh=at({prefix:"9",name:"base10",alphabet:"0123456789"});var ih=Object.freeze({__proto__:null,base10:sh});const rh=te({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),nh=te({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ah=Object.freeze({__proto__:null,base16:rh,base16upper:nh});const oh=te({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ch=te({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),lh=te({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),dh=te({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),hh=te({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),uh=te({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ph=te({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),gh=te({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),mh=te({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var fh=Object.freeze({__proto__:null,base32:oh,base32upper:ch,base32pad:lh,base32padupper:dh,base32hex:hh,base32hexupper:uh,base32hexpad:ph,base32hexpadupper:gh,base32z:mh});const yh=at({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),bh=at({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var wh=Object.freeze({__proto__:null,base36:yh,base36upper:bh});const vh=at({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),xh=at({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Eh=Object.freeze({__proto__:null,base58btc:vh,base58flickr:xh});const Ch=te({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Sh=te({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Ah=te({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ih=te({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Nh=Object.freeze({__proto__:null,base64:Ch,base64pad:Sh,base64url:Ah,base64urlpad:Ih});const Sr=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),_h=Sr.reduce((i,e,t)=>(i[t]=e,i),[]),Fh=Sr.reduce((i,e,t)=>(i[e.codePointAt(0)]=t,i),[]);function $h(i){return i.reduce((e,t)=>(e+=_h[t],e),"")}function Rh(i){const e=[];for(const t of i){const s=Fh[t.codePointAt(0)];if(s===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const jh=Rt({prefix:"🚀",name:"base256emoji",encode:$h,decode:Rh});var Oh=Object.freeze({__proto__:null,base256emoji:jh}),Th=Ar,Xs=128,Ph=127,kh=~Ph,Dh=Math.pow(2,31);function Ar(i,e,t){e=e||[],t=t||0;for(var s=t;i>=Dh;)e[t++]=i&255|Xs,i/=128;for(;i&kh;)e[t++]=i&255|Xs,i>>>=7;return e[t]=i|0,Ar.bytes=t-s+1,e}var Lh=es,Mh=128,Zs=127;function es(i,s){var t=0,s=s||0,r=0,n=s,a,o=i.length;do{if(n>=o)throw es.bytes=0,new RangeError("Could not decode varint");a=i[n++],t+=r<28?(a&Zs)<<r:(a&Zs)*Math.pow(2,r),r+=7}while(a>=Mh);return es.bytes=n-s,t}var Uh=Math.pow(2,7),qh=Math.pow(2,14),Vh=Math.pow(2,21),zh=Math.pow(2,28),Bh=Math.pow(2,35),Kh=Math.pow(2,42),Wh=Math.pow(2,49),Gh=Math.pow(2,56),Hh=Math.pow(2,63),Jh=function(i){return i<Uh?1:i<qh?2:i<Vh?3:i<zh?4:i<Bh?5:i<Kh?6:i<Wh?7:i<Gh?8:i<Hh?9:10},Yh={encode:Th,decode:Lh,encodingLength:Jh},Ir=Yh;const ei=(i,e,t=0)=>(Ir.encode(i,e,t),e),ti=i=>Ir.encodingLength(i),ts=(i,e)=>{const t=e.byteLength,s=ti(i),r=s+ti(t),n=new Uint8Array(r+t);return ei(i,n,0),ei(t,n,s),n.set(e,r),new Qh(i,t,e,n)};class Qh{constructor(e,t,s,r){this.code=e,this.size=t,this.digest=s,this.bytes=r}}const Nr=({name:i,code:e,encode:t})=>new Xh(i,e,t);class Xh{constructor(e,t,s){this.name=e,this.code=t,this.encode=s}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ts(this.code,t):t.then(s=>ts(this.code,s))}else throw Error("Unknown type, must be binary type")}}const _r=i=>async e=>new Uint8Array(await crypto.subtle.digest(i,e)),Zh=Nr({name:"sha2-256",code:18,encode:_r("SHA-256")}),eu=Nr({name:"sha2-512",code:19,encode:_r("SHA-512")});var tu=Object.freeze({__proto__:null,sha256:Zh,sha512:eu});const Fr=0,su="identity",$r=Er,iu=i=>ts(Fr,$r(i)),ru={code:Fr,name:su,encode:$r,digest:iu};var nu=Object.freeze({__proto__:null,identity:ru});new TextEncoder,new TextDecoder;const si={...Qd,...Zd,...th,...ih,...ah,...fh,...wh,...Eh,...Nh,...Oh};({...tu,...nu});function Rr(i){return globalThis.Buffer!=null?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):i}function au(i=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?Rr(globalThis.Buffer.allocUnsafe(i)):new Uint8Array(i)}function jr(i,e,t,s){return{name:i,prefix:e,encoder:{name:i,prefix:e,encode:t},decoder:{decode:s}}}const ii=jr("utf8","u",i=>"u"+new TextDecoder("utf8").decode(i),i=>new TextEncoder().encode(i.substring(1))),Dt=jr("ascii","a",i=>{let e="a";for(let t=0;t<i.length;t++)e+=String.fromCharCode(i[t]);return e},i=>{i=i.substring(1);const e=au(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}),ou={utf8:ii,"utf-8":ii,hex:si.base16,latin1:Dt,ascii:Dt,binary:Dt,...si};function cu(i,e="utf8"){const t=ou[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Rr(globalThis.Buffer.from(i,"utf-8")):t.decoder.decode(`${t.prefix}${i}`)}const Or="wc",lu=2,ms="core",_e=`${Or}@2:${ms}:`,du={name:ms,logger:"error"},hu={database:":memory:"},uu="crypto",ri="client_ed25519_seed",pu=F.ONE_DAY,gu="keychain",mu="0.3",fu="messages",yu="0.3",bu=F.SIX_HOURS,wu="publisher",Tr="irn",vu="error",Pr="wss://relay.walletconnect.com",xu="relayer",q={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Eu="_subscription",He={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},Cu=F.ONE_SECOND/2,Su="2.8.2",Au=1e4,Iu="0.3",Nu="WALLETCONNECT_CLIENT_ID",ye={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},_u="subscription",Fu="0.3",$u=F.FIVE_SECONDS*1e3,Ru="pairing",ju="0.3",Je={wc_pairingDelete:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:F.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:F.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:F.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:F.ONE_DAY,prompt:!1,tag:0},res:{ttl:F.ONE_DAY,prompt:!1,tag:0}}},fe={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},Ou="history",Tu="0.3",Pu="expirer",he={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},ku="0.3",Lt="verify-api",ni="https://verify.walletconnect.com";class Du{constructor(e,t){this.core=e,this.logger=t,this.keychain=new Map,this.name=gu,this.version=mu,this.initialized=!1,this.storagePrefix=_e,this.init=async()=>{if(!this.initialized){const s=await this.getKeyChain();typeof s<"u"&&(this.keychain=s),this.initialized=!0}},this.has=s=>(this.isInitialized(),this.keychain.has(s)),this.set=async(s,r)=>{this.isInitialized(),this.keychain.set(s,r),await this.persist()},this.get=s=>{this.isInitialized();const r=this.keychain.get(s);if(typeof r>"u"){const{message:n}=S("NO_MATCHING_KEY",`${this.name}: ${s}`);throw new Error(n)}return r},this.del=async s=>{this.isInitialized(),this.keychain.delete(s),await this.persist()},this.core=e,this.logger=T.generateChildLogger(t,this.name)}get context(){return T.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,fr(e))}async getKeyChain(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?yr(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Lu{constructor(e,t,s){this.core=e,this.logger=t,this.name=uu,this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=r=>(this.isInitialized(),this.keychain.has(r)),this.getClientId=async()=>{this.isInitialized();const r=await this.getClientSeed(),n=_s(r);return la(n.publicKey)},this.generateKeyPair=()=>{this.isInitialized();const r=jl();return this.setPrivateKey(r.publicKey,r.privateKey)},this.signJWT=async r=>{this.isInitialized();const n=await this.getClientSeed(),a=_s(n),o=Xt();return await da(o,r,pu,a)},this.generateSharedKey=(r,n,a)=>{this.isInitialized();const o=this.getPrivateKey(r),l=Ol(o,n);return this.setSymKey(l,a)},this.setSymKey=async(r,n)=>{this.isInitialized();const a=n||Tl(r);return await this.keychain.set(a,r),a},this.deleteKeyPair=async r=>{this.isInitialized(),await this.keychain.del(r)},this.deleteSymKey=async r=>{this.isInitialized(),await this.keychain.del(r)},this.encode=async(r,n,a)=>{this.isInitialized();const o=pr(a),l=ua(n);if(Vs(o)){const v=o.senderPublicKey,b=o.receiverPublicKey;r=await this.generateSharedKey(v,b)}const d=this.getSymKey(r),{type:p,senderPublicKey:u}=o;return kl({type:p,symKey:d,message:l,senderPublicKey:u})},this.decode=async(r,n,a)=>{this.isInitialized();const o=Ml(n,a);if(Vs(o)){const p=o.receiverPublicKey,u=o.senderPublicKey;r=await this.generateSharedKey(p,u)}const l=this.getSymKey(r),d=Dl({symKey:l,encoded:n});return pa(d)},this.getPayloadType=r=>{const n=ft(r);return rt(n.type)},this.getPayloadSenderPublicKey=r=>{const n=ft(r);return n.senderPublicKey?ue(n.senderPublicKey,ie):void 0},this.core=e,this.logger=T.generateChildLogger(t,this.name),this.keychain=s||new Du(this.core,this.logger)}get context(){return T.getLoggerContext(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(ri)}catch{e=Xt(),await this.keychain.set(ri,e)}return cu(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Mu extends El{constructor(e,t){super(e,t),this.logger=e,this.core=t,this.messages=new Map,this.name=fu,this.version=yu,this.initialized=!1,this.storagePrefix=_e,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const s=await this.getRelayerMessages();typeof s<"u"&&(this.messages=s),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(s){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(s)}finally{this.initialized=!0}}},this.set=async(s,r)=>{this.isInitialized();const n=qe(r);let a=this.messages.get(s);return typeof a>"u"&&(a={}),typeof a[n]<"u"||(a[n]=r,this.messages.set(s,a),await this.persist()),n},this.get=s=>{this.isInitialized();let r=this.messages.get(s);return typeof r>"u"&&(r={}),r},this.has=(s,r)=>{this.isInitialized();const n=this.get(s),a=qe(r);return typeof n[a]<"u"},this.del=async s=>{this.isInitialized(),this.messages.delete(s),await this.persist()},this.logger=T.generateChildLogger(e,this.name),this.core=t}get context(){return T.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,fr(e))}async getRelayerMessages(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?yr(e):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Uu extends Cl{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.events=new Re.EventEmitter,this.name=wu,this.queue=new Map,this.publishTimeout=F.toMiliseconds(F.TEN_SECONDS),this.queueTimeout=F.toMiliseconds(F.FIVE_SECONDS),this.needsTransportRestart=!1,this.publish=async(s,r,n)=>{this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:s,message:r,opts:n}});try{const a=n?.ttl||bu,o=Zt(n),l=n?.prompt||!1,d=n?.tag||0,p=n?.id||Vi().toString(),u={topic:s,message:r,opts:{ttl:a,relay:o,prompt:l,tag:d,id:p}},v=setTimeout(()=>this.queue.set(p,u),this.queueTimeout);try{await await yt(this.rpcPublish(s,r,a,o,l,d,p),this.publishTimeout),clearTimeout(v),this.relayer.events.emit(q.publish,u)}catch{this.logger.debug("Publishing Payload stalled"),this.needsTransportRestart=!0;return}this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:s,message:r,opts:n}})}catch(a){throw this.logger.debug("Failed to Publish Payload"),this.logger.error(a),a}},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.relayer=e,this.logger=T.generateChildLogger(t,this.name),this.registerEventListeners()}get context(){return T.getLoggerContext(this.logger)}rpcPublish(e,t,s,r,n,a,o){var l,d,p,u;const v={method:ut(r.protocol).publish,params:{topic:e,message:t,ttl:s,prompt:n,tag:a},id:o};return se((l=v.params)==null?void 0:l.prompt)&&((d=v.params)==null||delete d.prompt),se((p=v.params)==null?void 0:p.tag)&&((u=v.params)==null||delete u.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:v}),this.relayer.request(v)}onPublish(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{const{topic:t,message:s,opts:r}=e;await this.publish(t,s,r)})}registerEventListeners(){this.relayer.core.heartbeat.on(At.HEARTBEAT_EVENTS.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(q.connection_stalled);return}this.checkQueue()}),this.relayer.on(q.message_ack,e=>{this.onPublish(e.id.toString())})}}class qu{constructor(){this.map=new Map,this.set=(e,t)=>{const s=this.get(e);this.exists(e,t)||this.map.set(e,[...s,t])},this.get=e=>this.map.get(e)||[],this.exists=(e,t)=>this.get(e).includes(t),this.delete=(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const s=this.get(e);if(!this.exists(e,t))return;const r=s.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var Vu=Object.defineProperty,zu=Object.defineProperties,Bu=Object.getOwnPropertyDescriptors,ai=Object.getOwnPropertySymbols,Ku=Object.prototype.hasOwnProperty,Wu=Object.prototype.propertyIsEnumerable,oi=(i,e,t)=>e in i?Vu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ye=(i,e)=>{for(var t in e||(e={}))Ku.call(e,t)&&oi(i,t,e[t]);if(ai)for(var t of ai(e))Wu.call(e,t)&&oi(i,t,e[t]);return i},Mt=(i,e)=>zu(i,Bu(e));class Gu extends Il{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.subscriptions=new Map,this.topicMap=new qu,this.events=new Re.EventEmitter,this.name=_u,this.version=Fu,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=_e,this.subscribeTimeout=1e4,this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restart(),this.registerEventListeners(),this.onEnable(),this.clientId=await this.relayer.core.crypto.getClientId())},this.subscribe=async(s,r)=>{await this.restartToComplete(),this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}});try{const n=Zt(r),a={topic:s,relay:n};this.pending.set(s,a);const o=await this.rpcSubscribe(s,n);return this.onSubscribe(o,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}}),o}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}},this.unsubscribe=async(s,r)=>{await this.restartToComplete(),this.isInitialized(),typeof r?.id<"u"?await this.unsubscribeById(s,r.id,r):await this.unsubscribeByTopic(s,r)},this.isSubscribed=async s=>this.topics.includes(s)?!0:await new Promise((r,n)=>{const a=new F.Watch;a.start(this.pendingSubscriptionWatchLabel);const o=setInterval(()=>{!this.pending.has(s)&&this.topics.includes(s)&&(clearInterval(o),a.stop(this.pendingSubscriptionWatchLabel),r(!0)),a.elapsed(this.pendingSubscriptionWatchLabel)>=$u&&(clearInterval(o),a.stop(this.pendingSubscriptionWatchLabel),n(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1),this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=T.generateChildLogger(t,this.name),this.clientId=""}get context(){return T.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,t){let s=!1;try{s=this.getSubscription(e).topic===t}catch{}return s}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){const s=this.topicMap.get(e);await Promise.all(s.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,s){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}});try{const r=Zt(s);await this.rpcUnsubscribe(e,t,r);const n=X("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t){const s={method:ut(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});try{await await yt(this.relayer.request(s),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(q.connection_stalled)}return qe(e+this.clientId)}async rpcBatchSubscribe(e){if(!e.length)return;const t=e[0].relay,s={method:ut(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});try{return await await yt(this.relayer.request(s),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Payload stalled"),this.relayer.events.emit(q.connection_stalled)}}rpcUnsubscribe(e,t,s){const r={method:ut(s.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,Mt(Ye({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,Ye({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,s){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,s),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.subscriptions.has(e)||(this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t))}addSubscription(e,t){this.subscriptions.set(e,Ye({},t)),this.topicMap.set(t.topic,e),this.events.emit(ye.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const t=this.subscriptions.get(e);if(!t){const{message:s}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});const s=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(s.topic,e),this.events.emit(ye.deleted,Mt(Ye({},s),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(ye.sync)}async reset(){if(this.cached.length){const e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let t=0;t<e;t++){const s=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(s)}}this.events.emit(ye.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;const t=await this.rpcBatchSubscribe(e);nt(t)&&this.onBatchSubscribe(t.map((s,r)=>Mt(Ye({},e[r]),{id:s})))}async onConnect(){this.restartInProgress||(await this.restart(),this.onEnable())}onDisconnect(){this.onDisable()}async checkPending(){if(this.relayer.transportExplicitlyClosed)return;const e=[];this.pending.forEach(t=>{e.push(t)}),await this.batchSubscribe(e)}registerEventListeners(){this.relayer.core.heartbeat.on(At.HEARTBEAT_EVENTS.pulse,async()=>{await this.checkPending()}),this.relayer.on(q.connect,async()=>{await this.onConnect()}),this.relayer.on(q.disconnect,()=>{this.onDisconnect()}),this.events.on(ye.created,async e=>{const t=ye.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()}),this.events.on(ye.deleted,async e=>{const t=ye.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){this.restartInProgress&&await new Promise(e=>{const t=setInterval(()=>{this.restartInProgress||(clearInterval(t),e())},this.pollingInterval)})}}var Hu=Object.defineProperty,ci=Object.getOwnPropertySymbols,Ju=Object.prototype.hasOwnProperty,Yu=Object.prototype.propertyIsEnumerable,li=(i,e,t)=>e in i?Hu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Qu=(i,e)=>{for(var t in e||(e={}))Ju.call(e,t)&&li(i,t,e[t]);if(ci)for(var t of ci(e))Yu.call(e,t)&&li(i,t,e[t]);return i};class Xu extends Sl{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new Re.EventEmitter,this.name=xu,this.transportExplicitlyClosed=!1,this.initialized=!1,this.reconnecting=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","socket stalled"],this.request=async t=>{this.logger.debug("Publishing Request Payload");try{return await this.toEstablishConnection(),await this.provider.request(t)}catch(s){throw this.logger.debug("Failed to Publish Request"),this.logger.error(s),s}},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?T.generateChildLogger(e.logger,this.name):T.pino(T.getDefaultLoggerOptions({level:e.logger||vu})),this.messages=new Mu(this.logger,e.core),this.subscriber=new Gu(this,this.logger),this.publisher=new Uu(this,this.logger),this.relayUrl=e?.relayUrl||Pr,this.projectId=e.projectId,this.provider={}}async init(){this.logger.trace("Initialized"),await this.createProvider(),await Promise.all([this.messages.init(),this.transportOpen(),this.subscriber.init()]),this.registerEventListeners(),this.initialized=!0,setTimeout(async()=>{this.subscriber.topics.length===0&&(this.logger.info("No topics subscribted to after init, closing transport"),await this.transportClose(),this.transportExplicitlyClosed=!1)},Au)}get context(){return T.getLoggerContext(this.logger)}get connected(){return this.provider.connection.connected}get connecting(){return this.provider.connection.connecting}async publish(e,t,s){this.isInitialized(),await this.publisher.publish(e,t,s),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now()})}async subscribe(e,t){var s;this.isInitialized();let r=((s=this.subscriber.topicMap.get(e))==null?void 0:s[0])||"";return r||(await Promise.all([new Promise(n=>{this.subscriber.once(ye.created,a=>{a.topic===e&&n()})}),new Promise(async n=>{r=await this.subscriber.subscribe(e,t),n()})]),r)}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportClose(){this.transportExplicitlyClosed=!0,this.connected&&(await this.provider.disconnect(),this.events.emit(q.transport_closed))}async transportOpen(e){if(this.transportExplicitlyClosed=!1,!this.reconnecting){this.relayUrl=e||this.relayUrl,this.reconnecting=!0;try{await Promise.all([new Promise(t=>{this.initialized||t(),this.subscriber.once(ye.resubscribed,()=>{t()})}),await Promise.race([new Promise(async(t,s)=>{await yt(this.provider.connect(),5e3,"socket stalled").catch(r=>s(r)).then(()=>t()).finally(()=>this.removeListener(q.transport_closed,this.rejectTransportOpen))}),new Promise(t=>this.once(q.transport_closed,this.rejectTransportOpen))])])}catch(t){this.logger.error(t);const s=t;if(!this.isConnectionStalled(s.message))throw t;this.events.emit(q.transport_closed)}finally{this.reconnecting=!1}}}async restartTransport(e){this.transportExplicitlyClosed||this.reconnecting||(this.relayUrl=e||this.relayUrl,this.connected&&await Promise.all([new Promise(t=>{this.provider.once(He.disconnect,()=>{t()})}),this.transportClose()]),await this.createProvider(),await this.transportOpen())}isConnectionStalled(e){return this.staleConnectionErrors.some(t=>e.includes(t))}rejectTransportOpen(){throw new Error("Attempt to connect to relay via `transportOpen` has stalled. Retrying...")}async createProvider(){const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new ga(new ha(Yl({sdkVersion:Su,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0}))),this.registerProviderListeners()}async recordMessageEvent(e){const{topic:t,message:s}=e;await this.messages.set(t,s)}async shouldIgnoreMessageEvent(e){const{topic:t,message:s}=e;return await this.subscriber.isSubscribed(t)?this.messages.has(t,s):!0}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),It(e)){if(!e.method.endsWith(Eu))return;const t=e.params,{topic:s,message:r,publishedAt:n}=t.data,a={topic:s,message:r,publishedAt:n};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Qu({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else Nt(e)&&this.events.emit(q.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(q.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){const t=Ft(e.id,!0);await this.provider.connection.send(t)}registerProviderListeners(){this.provider.on(He.payload,e=>this.onProviderPayload(e)),this.provider.on(He.connect,()=>{this.events.emit(q.connect)}),this.provider.on(He.disconnect,()=>{this.onProviderDisconnect()}),this.provider.on(He.error,e=>{this.logger.error(e),this.events.emit(q.error,e)})}registerEventListeners(){this.events.on(q.connection_stalled,async()=>{await this.restartTransport()})}onProviderDisconnect(){this.events.emit(q.disconnect),this.attemptToReconnect()}attemptToReconnect(){this.transportExplicitlyClosed||setTimeout(async()=>{await this.restartTransport()},F.toMiliseconds(Cu))}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(!this.connected){if(this.connecting)return await new Promise(e=>{const t=setInterval(()=>{this.connected&&(clearInterval(t),e())},this.connectionStatusPollingInterval)});await this.restartTransport()}}}var Zu=Object.defineProperty,di=Object.getOwnPropertySymbols,ep=Object.prototype.hasOwnProperty,tp=Object.prototype.propertyIsEnumerable,hi=(i,e,t)=>e in i?Zu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ui=(i,e)=>{for(var t in e||(e={}))ep.call(e,t)&&hi(i,t,e[t]);if(di)for(var t of di(e))tp.call(e,t)&&hi(i,t,e[t]);return i};class jt extends Al{constructor(e,t,s,r=_e,n=void 0){super(e,t,s,r),this.core=e,this.logger=t,this.name=s,this.map=new Map,this.version=Iu,this.cached=[],this.initialized=!1,this.storagePrefix=_e,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>{this.getKey&&a!==null&&!se(a)?this.map.set(this.getKey(a),a):wd(a)?this.map.set(a.id,a):vd(a)&&this.map.set(a.topic,a)}),this.cached=[],this.initialized=!0)},this.set=async(a,o)=>{this.isInitialized(),this.map.has(a)?await this.update(a,o):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:a,value:o}),this.map.set(a,o),await this.persist())},this.get=a=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:a}),this.getData(a)),this.getAll=a=>(this.isInitialized(),a?this.values.filter(o=>Object.keys(a).every(l=>oa(o[l],a[l]))):this.values),this.update=async(a,o)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:a,update:o});const l=ui(ui({},this.getData(a)),o);this.map.set(a,l),await this.persist()},this.delete=async(a,o)=>{this.isInitialized(),this.map.has(a)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:a,reason:o}),this.map.delete(a),await this.persist())},this.logger=T.generateChildLogger(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return T.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const t=this.map.get(e);if(!t){const{message:s}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(s),new Error(s)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class sp{constructor(e,t){this.core=e,this.logger=t,this.name=Ru,this.version=ju,this.events=new Ti,this.initialized=!1,this.storagePrefix=_e,this.ignoredPayloadTypes=[De],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:s})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...s])]},this.create=async()=>{this.isInitialized();const s=Xt(),r=await this.core.crypto.setSymKey(s),n=we(F.FIVE_MINUTES),a={protocol:Tr},o={topic:r,expiry:n,relay:a,active:!1},l=ld({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:s,relay:a});return await this.pairings.set(r,o),await this.core.relayer.subscribe(r),this.core.expirer.set(r,n),{topic:r,uri:l}},this.pair=async s=>{this.isInitialized(),this.isValidPair(s);const{topic:r,symKey:n,relay:a}=ad(s.uri);if(this.pairings.keys.includes(r))throw new Error(`Pairing already exists: ${r}`);if(this.core.crypto.hasKeys(r))throw new Error(`Keychain already exists: ${r}`);const o=we(F.FIVE_MINUTES),l={topic:r,relay:a,expiry:o,active:!1};return await this.pairings.set(r,l),await this.core.crypto.setSymKey(n,r),await this.core.relayer.subscribe(r,{relay:a}),this.core.expirer.set(r,o),s.activatePairing&&await this.activate({topic:r}),l},this.activate=async({topic:s})=>{this.isInitialized();const r=we(F.THIRTY_DAYS);await this.pairings.update(s,{active:!0,expiry:r}),this.core.expirer.set(s,r)},this.ping=async s=>{this.isInitialized(),await this.isValidPing(s);const{topic:r}=s;if(this.pairings.keys.includes(r)){const n=await this.sendRequest(r,"wc_pairingPing",{}),{done:a,resolve:o,reject:l}=Me();this.events.once(G("pairing_ping",n),({error:d})=>{d?l(d):o()}),await a()}},this.updateExpiry=async({topic:s,expiry:r})=>{this.isInitialized(),await this.pairings.update(s,{expiry:r})},this.updateMetadata=async({topic:s,metadata:r})=>{this.isInitialized(),await this.pairings.update(s,{peerMetadata:r})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async s=>{this.isInitialized(),await this.isValidDisconnect(s);const{topic:r}=s;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",X("USER_DISCONNECTED")),await this.deletePairing(r))},this.sendRequest=async(s,r,n)=>{const a=_t(r,n),o=await this.core.crypto.encode(s,a),l=Je[r].req;return this.core.history.set(s,a),this.core.relayer.publish(s,o,l),a.id},this.sendResult=async(s,r,n)=>{const a=Ft(s,n),o=await this.core.crypto.encode(r,a),l=await this.core.history.get(r,s),d=Je[l.request.method].res;await this.core.relayer.publish(r,o,d),await this.core.history.resolve(a)},this.sendError=async(s,r,n)=>{const a=os(s,n),o=await this.core.crypto.encode(r,a),l=await this.core.history.get(r,s),d=Je[l.request.method]?Je[l.request.method].res:Je.unregistered_method.res;await this.core.relayer.publish(r,o,d),await this.core.history.resolve(a)},this.deletePairing=async(s,r)=>{await this.core.relayer.unsubscribe(s),await Promise.all([this.pairings.delete(s,X("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(s),r?Promise.resolve():this.core.expirer.del(s)])},this.cleanup=async()=>{const s=this.pairings.getAll().filter(r=>Ne(r.expiry));await Promise.all(s.map(r=>this.deletePairing(r.topic)))},this.onRelayEventRequest=s=>{const{topic:r,payload:n}=s,a=n.method;if(this.pairings.keys.includes(r))switch(a){case"wc_pairingPing":return this.onPairingPingRequest(r,n);case"wc_pairingDelete":return this.onPairingDeleteRequest(r,n);default:return this.onUnknownRpcMethodRequest(r,n)}},this.onRelayEventResponse=async s=>{const{topic:r,payload:n}=s,a=(await this.core.history.get(r,n.id)).request.method;if(this.pairings.keys.includes(r))switch(a){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(a)}},this.onPairingPingRequest=async(s,r)=>{const{id:n}=r;try{this.isValidPing({topic:s}),await this.sendResult(n,s,!0),this.events.emit("pairing_ping",{id:n,topic:s})}catch(a){await this.sendError(n,s,a),this.logger.error(a)}},this.onPairingPingResponse=(s,r)=>{const{id:n}=r;setTimeout(()=>{Ce(r)?this.events.emit(G("pairing_ping",n),{}):be(r)&&this.events.emit(G("pairing_ping",n),{error:r.error})},500)},this.onPairingDeleteRequest=async(s,r)=>{const{id:n}=r;try{this.isValidDisconnect({topic:s}),await this.deletePairing(s),this.events.emit("pairing_delete",{id:n,topic:s})}catch(a){await this.sendError(n,s,a),this.logger.error(a)}},this.onUnknownRpcMethodRequest=async(s,r)=>{const{id:n,method:a}=r;try{if(this.registeredMethods.includes(a))return;const o=X("WC_METHOD_UNSUPPORTED",a);await this.sendError(n,s,o),this.logger.error(o)}catch(o){await this.sendError(n,s,o),this.logger.error(o)}},this.onUnknownRpcMethodResponse=s=>{this.registeredMethods.includes(s)||this.logger.error(X("WC_METHOD_UNSUPPORTED",s))},this.isValidPair=s=>{if(!ae(s)){const{message:r}=S("MISSING_OR_INVALID",`pair() params: ${s}`);throw new Error(r)}if(!bd(s.uri)){const{message:r}=S("MISSING_OR_INVALID",`pair() uri: ${s.uri}`);throw new Error(r)}},this.isValidPing=async s=>{if(!ae(s)){const{message:n}=S("MISSING_OR_INVALID",`ping() params: ${s}`);throw new Error(n)}const{topic:r}=s;await this.isValidPairingTopic(r)},this.isValidDisconnect=async s=>{if(!ae(s)){const{message:n}=S("MISSING_OR_INVALID",`disconnect() params: ${s}`);throw new Error(n)}const{topic:r}=s;await this.isValidPairingTopic(r)},this.isValidPairingTopic=async s=>{if(!Z(s,!1)){const{message:r}=S("MISSING_OR_INVALID",`pairing topic should be a string: ${s}`);throw new Error(r)}if(!this.pairings.keys.includes(s)){const{message:r}=S("NO_MATCHING_KEY",`pairing topic doesn't exist: ${s}`);throw new Error(r)}if(Ne(this.pairings.get(s).expiry)){await this.deletePairing(s);const{message:r}=S("EXPIRED",`pairing topic: ${s}`);throw new Error(r)}},this.core=e,this.logger=T.generateChildLogger(t,this.name),this.pairings=new jt(this.core,this.logger,this.name,this.storagePrefix)}get context(){return T.getLoggerContext(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(q.message,async e=>{const{topic:t,message:s}=e;if(this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(s)))return;const r=await this.core.crypto.decode(t,s);It(r)?(this.core.history.set(t,r),this.onRelayEventRequest({topic:t,payload:r})):Nt(r)&&(await this.core.history.resolve(r),this.onRelayEventResponse({topic:t,payload:r}))})}registerExpirerEvents(){this.core.expirer.on(he.expired,async e=>{const{topic:t}=wr(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit("pairing_expire",{topic:t}))})}}class ip extends xl{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.records=new Map,this.events=new Re.EventEmitter,this.name=Ou,this.version=Tu,this.cached=[],this.initialized=!1,this.storagePrefix=_e,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.records.set(s.id,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(s,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:s,request:r,chainId:n}),this.records.has(r.id))return;const a={id:r.id,topic:s,request:{method:r.method,params:r.params||null},chainId:n};this.records.set(a.id,a),this.events.emit(fe.created,a)},this.resolve=async s=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:s}),!this.records.has(s.id))return;const r=await this.getRecord(s.id);typeof r.response>"u"&&(r.response=be(s)?{error:s.error}:{result:s.result},this.records.set(r.id,r),this.events.emit(fe.updated,r))},this.get=async(s,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:s,id:r}),await this.getRecord(r)),this.delete=(s,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===s){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(fe.deleted,n)}})},this.exists=async(s,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===s:!1),this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.logger=T.generateChildLogger(t,this.name)}get context(){return T.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;const s={topic:t.topic,request:_t(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(s)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const t=this.records.get(e);if(!t){const{message:s}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(fe.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(fe.created,e=>{const t=fe.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(fe.updated,e=>{const t=fe.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(fe.deleted,e=>{const t=fe.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class rp extends Nl{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.expirations=new Map,this.events=new Re.EventEmitter,this.name=Pu,this.version=ku,this.cached=[],this.initialized=!1,this.storagePrefix=_e,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.expirations.set(s.target,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=s=>{try{const r=this.formatTarget(s);return typeof this.getExpiration(r)<"u"}catch{return!1}},this.set=(s,r)=>{this.isInitialized();const n=this.formatTarget(s),a={target:n,expiry:r};this.expirations.set(n,a),this.checkExpiry(n,a),this.events.emit(he.created,{target:n,expiration:a})},this.get=s=>{this.isInitialized();const r=this.formatTarget(s);return this.getExpiration(r)},this.del=s=>{if(this.isInitialized(),this.has(s)){const r=this.formatTarget(s),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(he.deleted,{target:r,expiration:n})}},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.logger=T.generateChildLogger(t,this.name)}get context(){return T.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return Ql(e);if(typeof e=="number")return Xl(e);const{message:t}=S("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(he.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const t=this.expirations.get(e);if(!t){const{message:s}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(s),new Error(s)}return t}checkExpiry(e,t){const{expiry:s}=t;F.toMiliseconds(s)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(he.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(At.HEARTBEAT_EVENTS.pulse,()=>this.checkExpirations()),this.events.on(he.created,e=>{const t=he.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(he.expired,e=>{const t=he.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(he.deleted,e=>{const t=he.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class np extends _l{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,this.name=Lt,this.initialized=!1,this.init=async s=>{gr()||!us()||(this.verifyUrl=s?.verifyUrl||ni,await this.createIframe())},this.register=async s=>{var r;if(this.initialized||await this.init(),!!this.iframe)try{(r=this.iframe.contentWindow)==null||r.postMessage(s.attestationId,this.verifyUrl),this.logger.info(`postMessage sent: ${s.attestationId} ${this.verifyUrl}`)}catch{}},this.resolve=async s=>{var r;if(this.isDevEnv)return"";this.logger.info(`resolving attestation: ${s.attestationId}`);const n=this.startAbortTimer(F.FIVE_SECONDS),a=await fetch(`${this.verifyUrl}/attestation/${s.attestationId}`,{signal:this.abortController.signal});return clearTimeout(n),a.status===200?(r=await a.json())==null?void 0:r.origin:""},this.createIframe=async()=>{try{await Promise.race([new Promise((s,r)=>{if(document.getElementById(Lt))return s();const n=document.createElement("iframe");n.setAttribute("id",Lt),n.setAttribute("src",`${this.verifyUrl}/${this.projectId}`),n.style.display="none",n.addEventListener("load",()=>{this.initialized=!0,s()}),n.addEventListener("error",a=>{r(a)}),document.body.append(n),this.iframe=n}),new Promise(s=>{setTimeout(()=>s("iframe load timeout"),F.toMiliseconds(F.ONE_SECOND/2))})])}catch(s){this.logger.error(`Verify iframe failed to load: ${this.verifyUrl}`),this.logger.error(s)}},this.logger=T.generateChildLogger(t,this.name),this.verifyUrl=ni,this.abortController=new AbortController,this.isDevEnv=hs()&&{}.IS_VITEST}get context(){return T.getLoggerContext(this.logger)}startAbortTimer(e){return setTimeout(()=>this.abortController.abort(),F.toMiliseconds(e))}}var ap=Object.defineProperty,pi=Object.getOwnPropertySymbols,op=Object.prototype.hasOwnProperty,cp=Object.prototype.propertyIsEnumerable,gi=(i,e,t)=>e in i?ap(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,mi=(i,e)=>{for(var t in e||(e={}))op.call(e,t)&&gi(i,t,e[t]);if(pi)for(var t of pi(e))cp.call(e,t)&&gi(i,t,e[t]);return i};let lp=class kr extends vl{constructor(e){super(e),this.protocol=Or,this.version=lu,this.name=ms,this.events=new Re.EventEmitter,this.initialized=!1,this.on=(s,r)=>this.events.on(s,r),this.once=(s,r)=>this.events.once(s,r),this.off=(s,r)=>this.events.off(s,r),this.removeListener=(s,r)=>this.events.removeListener(s,r),this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||Pr;const t=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:T.pino(T.getDefaultLoggerOptions({level:e?.logger||du.logger}));this.logger=T.generateChildLogger(t,this.name),this.heartbeat=new At.HeartBeat,this.crypto=new Lu(this,this.logger,e?.keychain),this.history=new ip(this,this.logger),this.expirer=new rp(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new ca(mi(mi({},hu),e?.storageOptions)),this.relayer=new Xu({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new sp(this,this.logger),this.verify=new np(this.projectId||"",this.logger)}static async init(e){const t=new kr(e);await t.initialize();const s=await t.crypto.getClientId();return await t.storage.setItem(Nu,s),t}get context(){return T.getLoggerContext(this.logger)}async start(){this.initialized||await this.initialize()}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}};const dp=lp,Dr="wc",Lr=2,Mr="client",fs=`${Dr}@${Lr}:${Mr}:`,Ut={name:Mr,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.com"},hp="WALLETCONNECT_DEEPLINK_CHOICE",up="proposal",pp="Proposal expired",gp="session",ct=F.SEVEN_DAYS,mp="engine",Qe={wc_sessionPropose:{req:{ttl:F.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1101}},wc_sessionSettle:{req:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1104},res:{ttl:F.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1106},res:{ttl:F.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:F.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:F.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1112},res:{ttl:F.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:F.THIRTY_SECONDS,prompt:!1,tag:1114},res:{ttl:F.THIRTY_SECONDS,prompt:!1,tag:1115}}},qt={min:F.FIVE_MINUTES,max:F.SEVEN_DAYS},fp="request",yp=["wc_sessionPropose","wc_sessionRequest","wc_authRequest"];var bp=Object.defineProperty,wp=Object.defineProperties,vp=Object.getOwnPropertyDescriptors,fi=Object.getOwnPropertySymbols,xp=Object.prototype.hasOwnProperty,Ep=Object.prototype.propertyIsEnumerable,yi=(i,e,t)=>e in i?bp(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,de=(i,e)=>{for(var t in e||(e={}))xp.call(e,t)&&yi(i,t,e[t]);if(fi)for(var t of fi(e))Ep.call(e,t)&&yi(i,t,e[t]);return i},Vt=(i,e)=>wp(i,vp(e));class Cp extends $l{constructor(e){super(e),this.name=mp,this.events=new Ti,this.initialized=!1,this.ignoredPayloadTypes=[De],this.init=async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.client.core.pairing.register({methods:Object.keys(Qe)}),this.initialized=!0)},this.connect=async t=>{this.isInitialized();const s=Vt(de({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(s);const{pairingTopic:r,requiredNamespaces:n,optionalNamespaces:a,sessionProperties:o,relays:l}=s;let d=r,p,u=!1;if(d&&(u=this.client.core.pairing.pairings.get(d).active),!d||!u){const{topic:g,uri:m}=await this.client.core.pairing.create();d=g,p=m}const v=await this.client.core.crypto.generateKeyPair(),b=de({requiredNamespaces:n,optionalNamespaces:a,relays:l??[{protocol:Tr}],proposer:{publicKey:v,metadata:this.client.metadata}},o&&{sessionProperties:o}),{reject:y,resolve:x,done:C}=Me(F.FIVE_MINUTES,pp);if(this.events.once(G("session_connect"),async({error:g,session:m})=>{if(g)y(g);else if(m){m.self.publicKey=v;const f=Vt(de({},m),{requiredNamespaces:m.requiredNamespaces,optionalNamespaces:m.optionalNamespaces});await this.client.session.set(m.topic,f),await this.setExpiry(m.topic,m.expiry),d&&await this.client.core.pairing.updateMetadata({topic:d,metadata:m.peer.metadata}),x(f)}}),!d){const{message:g}=S("NO_MATCHING_KEY",`connect() pairing topic: ${d}`);throw new Error(g)}const _=await this.sendRequest(d,"wc_sessionPropose",b),h=we(F.FIVE_MINUTES);return await this.setProposal(_,de({id:_,expiry:h},b)),{uri:p,approval:C}},this.pair=async t=>(this.isInitialized(),await this.client.core.pairing.pair(t)),this.approve=async t=>{this.isInitialized(),await this.isValidApprove(t);const{id:s,relayProtocol:r,namespaces:n,sessionProperties:a}=t,o=this.client.proposal.get(s);let{pairingTopic:l,proposer:d,requiredNamespaces:p,optionalNamespaces:u}=o;l=l||"",Ze(p)||(p=pd(n,"approve()"));const v=await this.client.core.crypto.generateKeyPair(),b=d.publicKey,y=await this.client.core.crypto.generateSharedKey(v,b);l&&s&&(await this.client.core.pairing.updateMetadata({topic:l,metadata:d.metadata}),await this.sendResult(s,l,{relay:{protocol:r??"irn"},responderPublicKey:v}),await this.client.proposal.delete(s,X("USER_DISCONNECTED")),await this.client.core.pairing.activate({topic:l}));const x=de({relay:{protocol:r??"irn"},namespaces:n,requiredNamespaces:p,optionalNamespaces:u,pairingTopic:l,controller:{publicKey:v,metadata:this.client.metadata},expiry:we(ct)},a&&{sessionProperties:a});await this.client.core.relayer.subscribe(y),await this.sendRequest(y,"wc_sessionSettle",x);const C=Vt(de({},x),{topic:y,pairingTopic:l,acknowledged:!1,self:x.controller,peer:{publicKey:d.publicKey,metadata:d.metadata},controller:v});return await this.client.session.set(y,C),await this.setExpiry(y,we(ct)),{topic:y,acknowledged:()=>new Promise(_=>setTimeout(()=>_(this.client.session.get(y)),500))}},this.reject=async t=>{this.isInitialized(),await this.isValidReject(t);const{id:s,reason:r}=t,{pairingTopic:n}=this.client.proposal.get(s);n&&(await this.sendError(s,n,r),await this.client.proposal.delete(s,X("USER_DISCONNECTED")))},this.update=async t=>{this.isInitialized(),await this.isValidUpdate(t);const{topic:s,namespaces:r}=t,n=await this.sendRequest(s,"wc_sessionUpdate",{namespaces:r}),{done:a,resolve:o,reject:l}=Me();return this.events.once(G("session_update",n),({error:d})=>{d?l(d):o()}),await this.client.session.update(s,{namespaces:r}),{acknowledged:a}},this.extend=async t=>{this.isInitialized(),await this.isValidExtend(t);const{topic:s}=t,r=await this.sendRequest(s,"wc_sessionExtend",{}),{done:n,resolve:a,reject:o}=Me();return this.events.once(G("session_extend",r),({error:l})=>{l?o(l):a()}),await this.setExpiry(s,we(ct)),{acknowledged:n}},this.request=async t=>{this.isInitialized(),await this.isValidRequest(t);const{chainId:s,request:r,topic:n,expiry:a}=t,o=await this.sendRequest(n,"wc_sessionRequest",{request:r,chainId:s},a),{done:l,resolve:d,reject:p}=Me(a);this.events.once(G("session_request",o),({error:v,result:b})=>{v?p(v):d(b)}),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:s,id:o});const u=await this.client.core.storage.getItem(hp);return Zl({id:o,topic:n,wcDeepLink:u}),await l()},this.respond=async t=>{this.isInitialized(),await this.isValidRespond(t);const{topic:s,response:r}=t,{id:n}=r;Ce(r)?await this.sendResult(n,s,r.result):be(r)&&await this.sendError(n,s,r.error),this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0})},this.ping=async t=>{this.isInitialized(),await this.isValidPing(t);const{topic:s}=t;if(this.client.session.keys.includes(s)){const r=await this.sendRequest(s,"wc_sessionPing",{}),{done:n,resolve:a,reject:o}=Me();this.events.once(G("session_ping",r),({error:l})=>{l?o(l):a()}),await n()}else this.client.core.pairing.pairings.keys.includes(s)&&await this.client.core.pairing.ping({topic:s})},this.emit=async t=>{this.isInitialized(),await this.isValidEmit(t);const{topic:s,event:r,chainId:n}=t;await this.sendRequest(s,"wc_sessionEvent",{event:r,chainId:n})},this.disconnect=async t=>{this.isInitialized(),await this.isValidDisconnect(t);const{topic:s}=t;if(this.client.session.keys.includes(s)){const r=Vi().toString();let n;const a=o=>{o?.id.toString()===r&&(this.client.core.relayer.events.removeListener(q.message_ack,a),n())};await Promise.all([new Promise(o=>{n=o,this.client.core.relayer.on(q.message_ack,a)}),this.sendRequest(s,"wc_sessionDelete",X("USER_DISCONNECTED"),void 0,r)]),await this.deleteSession(s)}else await this.client.core.pairing.disconnect({topic:s})},this.find=t=>(this.isInitialized(),this.client.session.getAll().filter(s=>fd(s,t))),this.getPendingSessionRequests=()=>(this.isInitialized(),this.client.pendingRequest.getAll()),this.cleanupDuplicatePairings=async t=>{if(t.pairingTopic)try{const s=this.client.core.pairing.pairings.get(t.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var a,o;return((a=n.peerMetadata)==null?void 0:a.url)&&((o=n.peerMetadata)==null?void 0:o.url)===t.peer.metadata.url&&n.topic&&n.topic!==s.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(s){this.client.logger.error(s)}},this.deleteSession=async(t,s)=>{const{self:r}=this.client.session.get(t);await this.client.core.relayer.unsubscribe(t),this.client.session.delete(t,X("USER_DISCONNECTED")),this.client.core.crypto.keychain.has(r.publicKey)&&await this.client.core.crypto.deleteKeyPair(r.publicKey),this.client.core.crypto.keychain.has(t)&&await this.client.core.crypto.deleteSymKey(t),s||this.client.core.expirer.del(t)},this.deleteProposal=async(t,s)=>{await Promise.all([this.client.proposal.delete(t,X("USER_DISCONNECTED")),s?Promise.resolve():this.client.core.expirer.del(t)])},this.deletePendingSessionRequest=async(t,s,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,s),r?Promise.resolve():this.client.core.expirer.del(t)])},this.setExpiry=async(t,s)=>{this.client.session.keys.includes(t)&&await this.client.session.update(t,{expiry:s}),this.client.core.expirer.set(t,s)},this.setProposal=async(t,s)=>{await this.client.proposal.set(t,s),this.client.core.expirer.set(t,s.expiry)},this.setPendingSessionRequest=async t=>{const s=Qe.wc_sessionRequest.req.ttl,{id:r,topic:n,params:a}=t;await this.client.pendingRequest.set(r,{id:r,topic:n,params:a}),s&&this.client.core.expirer.set(r,we(s))},this.sendRequest=async(t,s,r,n,a)=>{const o=_t(s,r);if(us()&&yp.includes(s)){const p=qe(JSON.stringify(o));await this.client.core.verify.register({attestationId:p})}const l=await this.client.core.crypto.encode(t,o),d=Qe[s].req;return n&&(d.ttl=n),a&&(d.id=a),this.client.core.history.set(t,o),this.client.core.relayer.publish(t,l,d),o.id},this.sendResult=async(t,s,r)=>{const n=Ft(t,r),a=await this.client.core.crypto.encode(s,n),o=await this.client.core.history.get(s,t),l=Qe[o.request.method].res;this.client.core.relayer.publish(s,a,l),await this.client.core.history.resolve(n)},this.sendError=async(t,s,r)=>{const n=os(t,r),a=await this.client.core.crypto.encode(s,n),o=await this.client.core.history.get(s,t),l=Qe[o.request.method].res;this.client.core.relayer.publish(s,a,l),await this.client.core.history.resolve(n)},this.cleanup=async()=>{const t=[],s=[];this.client.session.getAll().forEach(r=>{Ne(r.expiry)&&t.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{Ne(r.expiry)&&s.push(r.id)}),await Promise.all([...t.map(r=>this.deleteSession(r)),...s.map(r=>this.deleteProposal(r))])},this.onRelayEventRequest=t=>{const{topic:s,payload:r}=t,n=r.method;switch(n){case"wc_sessionPropose":return this.onSessionProposeRequest(s,r);case"wc_sessionSettle":return this.onSessionSettleRequest(s,r);case"wc_sessionUpdate":return this.onSessionUpdateRequest(s,r);case"wc_sessionExtend":return this.onSessionExtendRequest(s,r);case"wc_sessionPing":return this.onSessionPingRequest(s,r);case"wc_sessionDelete":return this.onSessionDeleteRequest(s,r);case"wc_sessionRequest":return this.onSessionRequest(s,r);case"wc_sessionEvent":return this.onSessionEventRequest(s,r);default:return this.client.logger.info(`Unsupported request method ${n}`)}},this.onRelayEventResponse=async t=>{const{topic:s,payload:r}=t,n=(await this.client.core.history.get(s,r.id)).request.method;switch(n){case"wc_sessionPropose":return this.onSessionProposeResponse(s,r);case"wc_sessionSettle":return this.onSessionSettleResponse(s,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(s,r);case"wc_sessionExtend":return this.onSessionExtendResponse(s,r);case"wc_sessionPing":return this.onSessionPingResponse(s,r);case"wc_sessionRequest":return this.onSessionRequestResponse(s,r);default:return this.client.logger.info(`Unsupported response method ${n}`)}},this.onRelayEventUnknownPayload=t=>{const{topic:s}=t,{message:r}=S("MISSING_OR_INVALID",`Decoded payload on topic ${s} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)},this.onSessionProposeRequest=async(t,s)=>{const{params:r,id:n}=s;try{this.isValidConnect(de({},s.params));const a=we(F.FIVE_MINUTES),o=de({id:n,pairingTopic:t,expiry:a},r);await this.setProposal(n,o);const l=qe(JSON.stringify(s)),d=await this.getVerifyContext(l,o.proposer.metadata);this.client.events.emit("session_proposal",{id:n,params:o,verifyContext:d})}catch(a){await this.sendError(n,t,a),this.client.logger.error(a)}},this.onSessionProposeResponse=async(t,s)=>{const{id:r}=s;if(Ce(s)){const{result:n}=s;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:n});const a=this.client.proposal.get(r);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});const o=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:o});const l=n.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:l});const d=await this.client.core.crypto.generateSharedKey(o,l);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",sessionTopic:d});const p=await this.client.core.relayer.subscribe(d);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:p}),await this.client.core.pairing.activate({topic:t})}else be(s)&&(await this.client.proposal.delete(r,X("USER_DISCONNECTED")),this.events.emit(G("session_connect"),{error:s.error}))},this.onSessionSettleRequest=async(t,s)=>{const{id:r,params:n}=s;try{this.isValidSessionSettleRequest(n);const{relay:a,controller:o,expiry:l,namespaces:d,requiredNamespaces:p,optionalNamespaces:u,sessionProperties:v,pairingTopic:b}=s.params,y=de({topic:t,relay:a,expiry:l,namespaces:d,acknowledged:!0,pairingTopic:b,requiredNamespaces:p,optionalNamespaces:u,controller:o.publicKey,self:{publicKey:"",metadata:this.client.metadata},peer:{publicKey:o.publicKey,metadata:o.metadata}},v&&{sessionProperties:v});await this.sendResult(s.id,t,!0),this.events.emit(G("session_connect"),{session:y}),this.cleanupDuplicatePairings(y)}catch(a){await this.sendError(r,t,a),this.client.logger.error(a)}},this.onSessionSettleResponse=async(t,s)=>{const{id:r}=s;Ce(s)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(G("session_approve",r),{})):be(s)&&(await this.client.session.delete(t,X("USER_DISCONNECTED")),this.events.emit(G("session_approve",r),{error:s.error}))},this.onSessionUpdateRequest=async(t,s)=>{const{params:r,id:n}=s;try{this.isValidUpdate(de({topic:t},r)),await this.client.session.update(t,{namespaces:r.namespaces}),await this.sendResult(n,t,!0),this.client.events.emit("session_update",{id:n,topic:t,params:r})}catch(a){await this.sendError(n,t,a),this.client.logger.error(a)}},this.onSessionUpdateResponse=(t,s)=>{const{id:r}=s;Ce(s)?this.events.emit(G("session_update",r),{}):be(s)&&this.events.emit(G("session_update",r),{error:s.error})},this.onSessionExtendRequest=async(t,s)=>{const{id:r}=s;try{this.isValidExtend({topic:t}),await this.setExpiry(t,we(ct)),await this.sendResult(r,t,!0),this.client.events.emit("session_extend",{id:r,topic:t})}catch(n){await this.sendError(r,t,n),this.client.logger.error(n)}},this.onSessionExtendResponse=(t,s)=>{const{id:r}=s;Ce(s)?this.events.emit(G("session_extend",r),{}):be(s)&&this.events.emit(G("session_extend",r),{error:s.error})},this.onSessionPingRequest=async(t,s)=>{const{id:r}=s;try{this.isValidPing({topic:t}),await this.sendResult(r,t,!0),this.client.events.emit("session_ping",{id:r,topic:t})}catch(n){await this.sendError(r,t,n),this.client.logger.error(n)}},this.onSessionPingResponse=(t,s)=>{const{id:r}=s;setTimeout(()=>{Ce(s)?this.events.emit(G("session_ping",r),{}):be(s)&&this.events.emit(G("session_ping",r),{error:s.error})},500)},this.onSessionDeleteRequest=async(t,s)=>{const{id:r}=s;try{this.isValidDisconnect({topic:t,reason:s.params}),await Promise.all([new Promise(n=>{this.client.core.relayer.once(q.publish,async()=>{n(await this.deleteSession(t))})}),this.sendResult(r,t,!0)]),this.client.events.emit("session_delete",{id:r,topic:t})}catch(n){this.client.logger.error(n)}},this.onSessionRequest=async(t,s)=>{const{id:r,params:n}=s;try{this.isValidRequest(de({topic:t},n)),await this.setPendingSessionRequest({id:r,topic:t,params:n});const a=qe(JSON.stringify(s)),o=this.client.session.get(t),l=await this.getVerifyContext(a,o.peer.metadata);this.client.events.emit("session_request",{id:r,topic:t,params:n,verifyContext:l})}catch(a){await this.sendError(r,t,a),this.client.logger.error(a)}},this.onSessionRequestResponse=(t,s)=>{const{id:r}=s;Ce(s)?this.events.emit(G("session_request",r),{result:s.result}):be(s)&&this.events.emit(G("session_request",r),{error:s.error})},this.onSessionEventRequest=async(t,s)=>{const{id:r,params:n}=s;try{this.isValidEmit(de({topic:t},n)),this.client.events.emit("session_event",{id:r,topic:t,params:n})}catch(a){await this.sendError(r,t,a),this.client.logger.error(a)}},this.isValidConnect=async t=>{if(!ae(t)){const{message:l}=S("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(l)}const{pairingTopic:s,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:a,relays:o}=t;if(se(s)||await this.isValidPairingTopic(s),!_d(o,!0)){const{message:l}=S("MISSING_OR_INVALID",`connect() relays: ${o}`);throw new Error(l)}!se(r)&&Ze(r)!==0&&this.validateNamespaces(r,"requiredNamespaces"),!se(n)&&Ze(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),se(a)||this.validateSessionProps(a,"sessionProperties")},this.validateNamespaces=(t,s)=>{const r=Nd(t,"connect()",s);if(r)throw new Error(r.message)},this.isValidApprove=async t=>{if(!ae(t))throw new Error(S("MISSING_OR_INVALID",`approve() params: ${t}`).message);const{id:s,namespaces:r,relayProtocol:n,sessionProperties:a}=t;await this.isValidProposalId(s);const o=this.client.proposal.get(s),l=pt(r,"approve()");if(l)throw new Error(l.message);const d=Ys(o.requiredNamespaces,r,"approve()");if(d)throw new Error(d.message);if(!Z(n,!0)){const{message:p}=S("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(p)}se(a)||this.validateSessionProps(a,"sessionProperties")},this.isValidReject=async t=>{if(!ae(t)){const{message:n}=S("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(n)}const{id:s,reason:r}=t;if(await this.isValidProposalId(s),!$d(r)){const{message:n}=S("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}},this.isValidSessionSettleRequest=t=>{if(!ae(t)){const{message:d}=S("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(d)}const{relay:s,controller:r,namespaces:n,expiry:a}=t;if(!xr(s)){const{message:d}=S("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(d)}const o=xd(r,"onSessionSettleRequest()");if(o)throw new Error(o.message);const l=pt(n,"onSessionSettleRequest()");if(l)throw new Error(l.message);if(Ne(a)){const{message:d}=S("EXPIRED","onSessionSettleRequest()");throw new Error(d)}},this.isValidUpdate=async t=>{if(!ae(t)){const{message:l}=S("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(l)}const{topic:s,namespaces:r}=t;await this.isValidSessionTopic(s);const n=this.client.session.get(s),a=pt(r,"update()");if(a)throw new Error(a.message);const o=Ys(n.requiredNamespaces,r,"update()");if(o)throw new Error(o.message)},this.isValidExtend=async t=>{if(!ae(t)){const{message:r}=S("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(r)}const{topic:s}=t;await this.isValidSessionTopic(s)},this.isValidRequest=async t=>{if(!ae(t)){const{message:l}=S("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(l)}const{topic:s,request:r,chainId:n,expiry:a}=t;await this.isValidSessionTopic(s);const{namespaces:o}=this.client.session.get(s);if(!Js(o,n)){const{message:l}=S("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(l)}if(!Rd(r)){const{message:l}=S("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(l)}if(!Td(o,n,r.method)){const{message:l}=S("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(l)}if(a&&!Ld(a,qt)){const{message:l}=S("MISSING_OR_INVALID",`request() expiry: ${a}. Expiry must be a number (in seconds) between ${qt.min} and ${qt.max}`);throw new Error(l)}},this.isValidRespond=async t=>{if(!ae(t)){const{message:n}=S("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(n)}const{topic:s,response:r}=t;if(await this.isValidSessionTopic(s),!jd(r)){const{message:n}=S("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(r)}`);throw new Error(n)}},this.isValidPing=async t=>{if(!ae(t)){const{message:r}=S("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(r)}const{topic:s}=t;await this.isValidSessionOrPairingTopic(s)},this.isValidEmit=async t=>{if(!ae(t)){const{message:o}=S("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(o)}const{topic:s,event:r,chainId:n}=t;await this.isValidSessionTopic(s);const{namespaces:a}=this.client.session.get(s);if(!Js(a,n)){const{message:o}=S("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(o)}if(!Od(r)){const{message:o}=S("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(o)}if(!Pd(a,n,r.name)){const{message:o}=S("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(o)}},this.isValidDisconnect=async t=>{if(!ae(t)){const{message:r}=S("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(r)}const{topic:s}=t;await this.isValidSessionOrPairingTopic(s)},this.getVerifyContext=async(t,s)=>{const r={verified:{verifyUrl:s.verifyUrl||"",validation:"UNKNOWN",origin:s.url||""}};try{const n=await this.client.core.verify.resolve({attestationId:t,verifyUrl:s.verifyUrl});n&&(r.verified.origin=n,r.verified.validation=n===s.url?"VALID":"INVALID")}catch(n){this.client.logger.error(n)}return this.client.logger.info(`Verify context: ${JSON.stringify(r)}`),r},this.validateSessionProps=(t,s)=>{Object.values(t).forEach(r=>{if(!Z(r,!1)){const{message:n}=S("MISSING_OR_INVALID",`${s} must be in Record<string, string> format. Received: ${JSON.stringify(r)}`);throw new Error(n)}})}}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.client.core.relayer.on(q.message,async e=>{const{topic:t,message:s}=e;if(this.ignoredPayloadTypes.includes(this.client.core.crypto.getPayloadType(s)))return;const r=await this.client.core.crypto.decode(t,s);It(r)?(this.client.core.history.set(t,r),this.onRelayEventRequest({topic:t,payload:r})):Nt(r)?(await this.client.core.history.resolve(r),this.onRelayEventResponse({topic:t,payload:r})):this.onRelayEventUnknownPayload({topic:t,payload:r})})}registerExpirerEvents(){this.client.core.expirer.on(he.expired,async e=>{const{topic:t,id:s}=wr(e.target);if(s&&this.client.pendingRequest.keys.includes(s))return await this.deletePendingSessionRequest(s,S("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession(t,!0),this.client.events.emit("session_expire",{topic:t})):s&&(await this.deleteProposal(s,!0),this.client.events.emit("proposal_expire",{id:s}))})}isValidPairingTopic(e){if(!Z(e,!1)){const{message:t}=S("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){const{message:t}=S("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(Ne(this.client.core.pairing.pairings.get(e).expiry)){const{message:t}=S("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!Z(e,!1)){const{message:t}=S("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(!this.client.session.keys.includes(e)){const{message:t}=S("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(Ne(this.client.session.get(e).expiry)){await this.deleteSession(e);const{message:t}=S("EXPIRED",`session topic: ${e}`);throw new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(Z(e,!1)){const{message:t}=S("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{const{message:t}=S("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!Fd(e)){const{message:t}=S("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){const{message:t}=S("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(Ne(this.client.proposal.get(e).expiry)){await this.deleteProposal(e);const{message:t}=S("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}}class Sp extends jt{constructor(e,t){super(e,t,up,fs),this.core=e,this.logger=t}}class Ap extends jt{constructor(e,t){super(e,t,gp,fs),this.core=e,this.logger=t}}class Ip extends jt{constructor(e,t){super(e,t,fp,fs,s=>s.id),this.core=e,this.logger=t}}let Np=class Ur extends Fl{constructor(e){super(e),this.protocol=Dr,this.version=Lr,this.name=Ut.name,this.events=new Re.EventEmitter,this.on=(s,r)=>this.events.on(s,r),this.once=(s,r)=>this.events.once(s,r),this.off=(s,r)=>this.events.off(s,r),this.removeListener=(s,r)=>this.events.removeListener(s,r),this.removeAllListeners=s=>this.events.removeAllListeners(s),this.connect=async s=>{try{return await this.engine.connect(s)}catch(r){throw this.logger.error(r.message),r}},this.pair=async s=>{try{return await this.engine.pair(s)}catch(r){throw this.logger.error(r.message),r}},this.approve=async s=>{try{return await this.engine.approve(s)}catch(r){throw this.logger.error(r.message),r}},this.reject=async s=>{try{return await this.engine.reject(s)}catch(r){throw this.logger.error(r.message),r}},this.update=async s=>{try{return await this.engine.update(s)}catch(r){throw this.logger.error(r.message),r}},this.extend=async s=>{try{return await this.engine.extend(s)}catch(r){throw this.logger.error(r.message),r}},this.request=async s=>{try{return await this.engine.request(s)}catch(r){throw this.logger.error(r.message),r}},this.respond=async s=>{try{return await this.engine.respond(s)}catch(r){throw this.logger.error(r.message),r}},this.ping=async s=>{try{return await this.engine.ping(s)}catch(r){throw this.logger.error(r.message),r}},this.emit=async s=>{try{return await this.engine.emit(s)}catch(r){throw this.logger.error(r.message),r}},this.disconnect=async s=>{try{return await this.engine.disconnect(s)}catch(r){throw this.logger.error(r.message),r}},this.find=s=>{try{return this.engine.find(s)}catch(r){throw this.logger.error(r.message),r}},this.getPendingSessionRequests=()=>{try{return this.engine.getPendingSessionRequests()}catch(s){throw this.logger.error(s.message),s}},this.name=e?.name||Ut.name,this.metadata=e?.metadata||Wl();const t=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:T.pino(T.getDefaultLoggerOptions({level:e?.logger||Ut.logger}));this.core=e?.core||new dp(e),this.logger=T.generateChildLogger(t,this.name),this.session=new Ap(this.core,this.logger),this.proposal=new Sp(this.core,this.logger),this.pendingRequest=new Ip(this.core,this.logger),this.engine=new Cp(this)}static async init(e){const t=new Ur(e);return await t.initialize(),t}get context(){return T.getLoggerContext(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.engine.init(),this.core.verify.init({verifyUrl:this.metadata.verifyUrl}),this.logger.info("SignClient Initialization Success")}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}};const _p=Np;var ss={exports:{}},Ve=typeof Reflect=="object"?Reflect:null,bi=Ve&&typeof Ve.apply=="function"?Ve.apply:function(i,e,t){return Function.prototype.apply.call(i,e,t)},gt;Ve&&typeof Ve.ownKeys=="function"?gt=Ve.ownKeys:Object.getOwnPropertySymbols?gt=function(i){return Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i))}:gt=function(i){return Object.getOwnPropertyNames(i)};function Fp(i){console&&console.warn&&console.warn(i)}var wi=Number.isNaN||function(i){return i!==i};function D(){D.init.call(this)}ss.exports=D,ss.exports.once=Op,D.EventEmitter=D,D.prototype._events=void 0,D.prototype._eventsCount=0,D.prototype._maxListeners=void 0;var vi=10;function mt(i){if(typeof i!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i)}Object.defineProperty(D,"defaultMaxListeners",{enumerable:!0,get:function(){return vi},set:function(i){if(typeof i!="number"||i<0||wi(i))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+i+".");vi=i}}),D.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},D.prototype.setMaxListeners=function(i){if(typeof i!="number"||i<0||wi(i))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+i+".");return this._maxListeners=i,this};function qr(i){return i._maxListeners===void 0?D.defaultMaxListeners:i._maxListeners}D.prototype.getMaxListeners=function(){return qr(this)},D.prototype.emit=function(i){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var s=i==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var n;if(e.length>0&&(n=e[0]),n instanceof Error)throw n;var a=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw a.context=n,a}var o=r[i];if(o===void 0)return!1;if(typeof o=="function")bi(o,this,e);else for(var l=o.length,d=Vr(o,l),t=0;t<l;++t)bi(d[t],this,e);return!0};function xi(i,e,t,s){var r,n,a;if(mt(t),n=i._events,n===void 0?(n=i._events=Object.create(null),i._eventsCount=0):(n.newListener!==void 0&&(i.emit("newListener",e,t.listener?t.listener:t),n=i._events),a=n[e]),a===void 0)a=n[e]=t,++i._eventsCount;else if(typeof a=="function"?a=n[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),r=qr(i),r>0&&a.length>r&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=i,o.type=e,o.count=a.length,Fp(o)}return i}D.prototype.addListener=function(i,e){return xi(this,i,e,!1)},D.prototype.on=D.prototype.addListener,D.prototype.prependListener=function(i,e){return xi(this,i,e,!0)};function $p(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ei(i,e,t){var s={fired:!1,wrapFn:void 0,target:i,type:e,listener:t},r=$p.bind(s);return r.listener=t,s.wrapFn=r,r}D.prototype.once=function(i,e){return mt(e),this.on(i,Ei(this,i,e)),this},D.prototype.prependOnceListener=function(i,e){return mt(e),this.prependListener(i,Ei(this,i,e)),this},D.prototype.removeListener=function(i,e){var t,s,r,n,a;if(mt(e),s=this._events,s===void 0)return this;if(t=s[i],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete s[i],s.removeListener&&this.emit("removeListener",i,t.listener||e));else if(typeof t!="function"){for(r=-1,n=t.length-1;n>=0;n--)if(t[n]===e||t[n].listener===e){a=t[n].listener,r=n;break}if(r<0)return this;r===0?t.shift():Rp(t,r),t.length===1&&(s[i]=t[0]),s.removeListener!==void 0&&this.emit("removeListener",i,a||e)}return this},D.prototype.off=D.prototype.removeListener,D.prototype.removeAllListeners=function(i){var e,t,s;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[i]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[i]),this;if(arguments.length===0){var r=Object.keys(t),n;for(s=0;s<r.length;++s)n=r[s],n!=="removeListener"&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[i],typeof e=="function")this.removeListener(i,e);else if(e!==void 0)for(s=e.length-1;s>=0;s--)this.removeListener(i,e[s]);return this};function Ci(i,e,t){var s=i._events;if(s===void 0)return[];var r=s[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?jp(r):Vr(r,r.length)}D.prototype.listeners=function(i){return Ci(this,i,!0)},D.prototype.rawListeners=function(i){return Ci(this,i,!1)},D.listenerCount=function(i,e){return typeof i.listenerCount=="function"?i.listenerCount(e):Si.call(i,e)},D.prototype.listenerCount=Si;function Si(i){var e=this._events;if(e!==void 0){var t=e[i];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}D.prototype.eventNames=function(){return this._eventsCount>0?gt(this._events):[]};function Vr(i,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=i[s];return t}function Rp(i,e){for(;e+1<i.length;e++)i[e]=i[e+1];i.pop()}function jp(i){for(var e=new Array(i.length),t=0;t<e.length;++t)e[t]=i[t].listener||i[t];return e}function Op(i,e){return new Promise(function(t,s){function r(a){i.removeListener(e,n),s(a)}function n(){typeof i.removeListener=="function"&&i.removeListener("error",r),t([].slice.call(arguments))}zr(i,e,n,{once:!0}),e!=="error"&&Tp(i,r,{once:!0})})}function Tp(i,e,t){typeof i.on=="function"&&zr(i,"error",e,t)}function zr(i,e,t,s){if(typeof i.on=="function")s.once?i.once(e,t):i.on(e,t);else if(typeof i.addEventListener=="function")i.addEventListener(e,function r(n){s.once&&i.removeEventListener(e,r),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof i)}const Pp="Web3Wallet";class kp{constructor(e){this.opts=e}}class Dp{constructor(e){this.client=e}}class Lp extends Dp{constructor(e){super(e),this.init=async()=>{this.signClient=await _p.init({core:this.client.core,metadata:this.client.metadata}),this.authClient=await wl.init({core:this.client.core,projectId:"",metadata:this.client.metadata}),this.initializeEventListeners()},this.pair=async t=>{await this.client.core.pairing.pair(t)},this.approveSession=async t=>{const{topic:s,acknowledged:r}=await this.signClient.approve({id:t.id,namespaces:t.namespaces});return await r(),this.signClient.session.get(s)},this.rejectSession=async t=>await this.signClient.reject(t),this.updateSession=async t=>await(await this.signClient.update(t)).acknowledged(),this.extendSession=async t=>await(await this.signClient.extend(t)).acknowledged(),this.respondSessionRequest=async t=>await this.signClient.respond(t),this.disconnectSession=async t=>await this.signClient.disconnect(t),this.emitSessionEvent=async t=>await this.signClient.emit(t),this.getActiveSessions=()=>this.signClient.session.getAll().reduce((t,s)=>(t[s.topic]=s,t),{}),this.getPendingSessionProposals=()=>this.signClient.proposal.getAll(),this.getPendingSessionRequests=()=>this.signClient.getPendingSessionRequests(),this.respondAuthRequest=async(t,s)=>await this.authClient.respond(t,s),this.getPendingAuthRequests=()=>this.authClient.requests.getAll().filter(t=>"requester"in t),this.formatMessage=(t,s)=>this.authClient.formatMessage(t,s),this.onSessionRequest=t=>{this.client.events.emit("session_request",t)},this.onSessionProposal=t=>{this.client.events.emit("session_proposal",t)},this.onSessionDelete=t=>{this.client.events.emit("session_delete",t)},this.onAuthRequest=t=>{this.client.events.emit("auth_request",t)},this.initializeEventListeners=()=>{this.signClient.events.on("session_proposal",this.onSessionProposal),this.signClient.events.on("session_request",this.onSessionRequest),this.signClient.events.on("session_delete",this.onSessionDelete),this.authClient.on("auth_request",this.onAuthRequest)},this.signClient={},this.authClient={}}}class ys extends kp{constructor(e){super(e),this.events=new ss.exports,this.on=(t,s)=>this.events.on(t,s),this.once=(t,s)=>this.events.once(t,s),this.off=(t,s)=>this.events.off(t,s),this.removeListener=(t,s)=>this.events.removeListener(t,s),this.pair=async t=>{try{return await this.engine.pair(t)}catch(s){throw this.logger.error(s.message),s}},this.approveSession=async t=>{try{return await this.engine.approveSession(t)}catch(s){throw this.logger.error(s.message),s}},this.rejectSession=async t=>{try{return await this.engine.rejectSession(t)}catch(s){throw this.logger.error(s.message),s}},this.updateSession=async t=>{try{return await this.engine.updateSession(t)}catch(s){throw this.logger.error(s.message),s}},this.extendSession=async t=>{try{return await this.engine.extendSession(t)}catch(s){throw this.logger.error(s.message),s}},this.respondSessionRequest=async t=>{try{return await this.engine.respondSessionRequest(t)}catch(s){throw this.logger.error(s.message),s}},this.disconnectSession=async t=>{try{return await this.engine.disconnectSession(t)}catch(s){throw this.logger.error(s.message),s}},this.emitSessionEvent=async t=>{try{return await this.engine.emitSessionEvent(t)}catch(s){throw this.logger.error(s.message),s}},this.getActiveSessions=()=>{try{return this.engine.getActiveSessions()}catch(t){throw this.logger.error(t.message),t}},this.getPendingSessionProposals=()=>{try{return this.engine.getPendingSessionProposals()}catch(t){throw this.logger.error(t.message),t}},this.getPendingSessionRequests=()=>{try{return this.engine.getPendingSessionRequests()}catch(t){throw this.logger.error(t.message),t}},this.respondAuthRequest=async(t,s)=>{try{return await this.engine.respondAuthRequest(t,s)}catch(r){throw this.logger.error(r.message),r}},this.getPendingAuthRequests=()=>{try{return this.engine.getPendingAuthRequests()}catch(t){throw this.logger.error(t.message),t}},this.formatMessage=(t,s)=>{try{return this.engine.formatMessage(t,s)}catch(r){throw this.logger.error(r.message),r}},this.metadata=e.metadata,this.name=e.name||Pp,this.core=e.core,this.logger=this.core.logger,this.engine=new Lp(this)}static async init(e){const t=new ys(e);return await t.initialize(),t}async initialize(){this.logger.trace("Initialized");try{await this.engine.init(),this.logger.info("Web3Wallet Initialization Success")}catch(e){throw this.logger.info("Web3Wallet Initialization Failure"),this.logger.error(e.message),e}}}const Mp=ys,Up=new RegExp(Rn);class qp{constructor(){this.clientMetadata={name:"Aragon DAO",description:"Aragon DAO",url:"https://aragon.org",icons:["https://assets.website-files.com/5e997428d0f2eb13a90aec8c/635283b535e03c60d5aafe64_logo_aragon_isotype.png"]},this.getActiveSessions=e=>{const t=this.client?.getActiveSessions()??{};return Object.values(t).filter(({self:r,namespaces:n})=>{const a=r.metadata.name===this.clientMetadata.name,o=e==null||n.eip155?.accounts.some(l=>l.includes(e));return a&&o})},this.initClient=async()=>{const e=await Mp.init({core:new qi({projectId:"a312303bfee4d9c1cdbc5e638e8aa438"}),metadata:this.clientMetadata});this.client=e},this.initClient()}validateURI(e){return Up.test(e)?void 0:dt.t("modal.dappConnect.validation.alertInvalid")}subscribeConnectProposal(e){this.client?.on("session_proposal",e)}unsubscribeConnectProposal(e){this.client?.off("session_proposal",e)}subscribeRequest(e){this.client?.on("session_request",e)}unsubscribeRequest(e){this.client?.off("session_request",e)}subscribeDisconnect(e){this.client?.on("session_delete",e)}unsubscribeDisconnect(e){this.client?.off("session_delete",e)}connect(e){return this.client?.core.pairing.pair({uri:e})}pingTopic(e){return this.client?.core.pairing.ping({topic:e})}async verifyConnection(e){const t=this.getActiveSessions().find(({pairingTopic:s})=>s===e.topic);if(t)return t;if(Date.now()/1e3>e.expiry)throw new Error("walletConnectInterceptor: connection is expired");try{await this.pingTopic(e.topic)}catch{throw new Error("walletConnectInterceptor: topic not valid")}}approveSession(e,t,s=[]){const r=$n({proposal:e.params,supportedNamespaces:{eip155:{chains:s.map(n=>`eip155:${n}`),methods:e.params.requiredNamespaces.eip155.methods,events:["accountsChanged","chainChanged"],accounts:s.map(n=>`eip155:${n}:${t}`)}}});return this.client?.approveSession({id:e.id,namespaces:r})}rejectSession(e){return this.client?.rejectSession({id:e.id,reason:Es("USER_REJECTED_METHODS")})}disconnect(e){return this.client?.disconnectSession({topic:e,reason:Es("USER_DISCONNECTED")})}}const ce=new qp,Vp=6e4,Br=new Error("walletConnectInterceptor: peer name does not match");function zp(){const{network:i}=me(),{data:e}=St(),[t,s]=A.useState(ce.getActiveSessions(e?.address)),[r,n]=A.useState([]),a=ce.validateURI,o=A.useCallback(()=>{const b=ce.getActiveSessions(e?.address);s(b)},[e?.address]),l=A.useCallback(async({connection:b,metadataName:y})=>{const x=await ce.verifyConnection(b),C=y==null||x?.peer.metadata.name.toLowerCase().includes(y);if(x&&!C)throw Br;return x},[]),d=A.useCallback(async({uri:b,metadataName:y})=>{const x=await ce.connect(b);if(x==null)throw new Error("walletConnectInterceptor: connection not defined");const C=Date.now();let _;return new Promise((h,g)=>{const m=setInterval(async()=>{Date.now()>C+Vp&&(clearInterval(m),g(new Error("walletConnectInterceptor: connection timeout")));try{_=await l({connection:x,metadataName:y})}catch(f){clearInterval(m),g(f)}_!=null&&(clearInterval(m),h(_))},1e3)})},[l]),p=A.useCallback(async b=>{try{await ce.disconnect(b),o()}catch(y){console.error("Error disconnecting the dApp: ",y)}},[o]),u=A.useCallback(async b=>{await ce.approveSession(b,e?.address,jn),o()},[e?.address,o]),v=A.useCallback(b=>{b.params.chainId===`eip155:${H[i].id}`&&n(y=>y.concat(b.params.request))},[i]);return A.useEffect(()=>(ce.subscribeConnectProposal(u),ce.subscribeDisconnect(o),()=>{ce.unsubscribeConnectProposal(u),ce.unsubscribeDisconnect(o)}),[u,o]),A.useEffect(()=>(ce.subscribeRequest(v),()=>{ce.unsubscribeRequest(v)}),[v]),{wcConnect:d,wcDisconnect:p,sessions:t,actions:r,validateURI:a}}const Kr=A.createContext(null),Bp=Kr.Provider,bs=()=>{const i=A.useContext(Kr);if(i==null)throw new Error("useWalletConnectContext: hook must be used inside a WalletConnectContextProvider to work properly");return i},bt=[{name:"CoW Swap | The smartest way to trade cryptocurrencies",shortName:"CoW Swap",description:"CoW Swap finds the lowest prices from all decentralized exchanges and DEX aggregators & saves you more with p2p trading and protection from MEV",url:"https://swap.cow.fi",icons:["https://swap.cow.fi/favicon.png?v=2","https://swap.cow.fi/favicon.png?v=2","https://swap.cow.fi/favicon.png?v=2"]}],ws=Pi.getValue("VITE_FEATURE_FLAG_CONNECT_ANY_DAPP")==="true";ws&&bt.push({name:"Connect any app",shortName:"Connect any app",description:"Connect any app",url:"",icons:[]});const Kp=i=>{const{t:e}=V(),{isDesktop:t}=xt(),{onConnectNewdApp:s,onSelectExistingdApp:r,onClose:n,isOpen:a}=i,{sessions:o}=bs(),l=A.useMemo(()=>ws?[...bt,...o.map(d=>d.peer.metadata)]:bt,[o]);return c.jsxs($e,{isOpen:a,onClose:n,children:[c.jsx(st,{title:e("modal.dappConnect.headerTitle"),subTitle:Ii(e)("modal.dappConnect.desc"),showBackButton:!0,onBackButtonClicked:()=>{n()},...t?{showCloseButton:!0,onClose:n}:{}}),c.jsxs(Wp,{children:[c.jsx("div",{className:"space-y-2",children:l.map(d=>{const p=d.shortName||d.name,u=o.filter(v=>v.peer.metadata.name.toLowerCase().includes(d.name.toLowerCase()));return c.jsx(tt,{title:p,iconLeft:ki(d.url,d.icons[0]),bgWhite:!0,iconRight:c.jsxs("div",{className:"flex space-x-4",children:[u[0]&&c.jsxs("div",{className:"flex items-center space-x-2 text-sm font-semibold leading-normal text-success-700",children:[c.jsx("div",{className:"h-2 w-2 rounded-full bg-success-700"}),c.jsx("p",{children:e("modal.dappConnect.dAppConnectedLabel")})]}),c.jsx(oe,{icon:O.CHEVRON_RIGHT})]}),truncateText:!0,onClick:()=>{u[0]?r(u[0],d):s(d)}},p)})}),c.jsx("div",{className:"mt-4 flex justify-center",children:c.jsx(le,{message:e("modal.dappConnect.alertInfo"),variant:"info"})})]})]})},Wp=$.div.attrs({className:"py-6 px-4 xl:px-6"})``,ze="wcID",Gp=i=>{const{onBackButtonClicked:e,onConnectionSuccess:t,onClose:s,isOpen:r,selecteddApp:n}=i,{t:a}=V(),{alert:o}=Fe(),{isDesktop:l}=xt(),[d,p]=A.useState(),[u,v]=A.useState(N.WAITING),{wcConnect:b,validateURI:y,sessions:x}=bs(),{control:C}=re(),{errors:_}=as({control:C}),[h]=xe({name:[ze],control:C}),g=A.useMemo(()=>{switch(u){case N.LOADING:return a("modal.dappConnect.validation.ctaLabelVerifying");case N.ERROR:return a("modal.dappConnect.validation.ctaLabelCritical");case N.INCORRECT_URI:return a("modal.dappConnect.validation.ctaLabelCritical");case N.SUCCESS:return a("modal.dappConnect.validation.ctaLabelSuccess");case N.WAITING:default:return a("modal.dappConnect.validation.ctaLabelDefault")}},[a,u]),m=A.useMemo(()=>u===N.SUCCESS||u===N.LOADING?a("labels.copy"):a(h?"labels.clear":"labels.paste"),[u,a,h]),f=x.find(({pairingTopic:L})=>L===d),w=A.useCallback((L,j)=>{L&&u!==N.SUCCESS&&u!==N.LOADING?(j(""),o(a("alert.chip.inputCleared"))):wt(L,j,o)},[o,u,a]),I=A.useCallback(()=>{v(N.WAITING),p(void 0)},[]),E=A.useCallback(()=>{e(),I()},[e,I]),R=A.useCallback(()=>{t(f),I()},[t,f,I]),B=A.useCallback(async()=>{v(N.LOADING);const L=bt.filter(j=>j.name===n?.name&&n.name!=="Connect any app");try{const j=await b({uri:h,metadataName:ws&&L.length===0?void 0:n?.name.toLowerCase()});p(j.pairingTopic),v(N.SUCCESS)}catch(j){v(j===Br?N.INCORRECT_URI:N.ERROR)}},[h,b,n?.name]);A.useEffect(()=>{u===N.SUCCESS&&f==null&&I()},[u,f,I,n]);const Ae=h==null||!!_[ze],Ie=u===N.SUCCESS?R:B;if(!n)return null;const ne=n.shortName||n.name;return c.jsxs($e,{isOpen:r,onClose:s,children:[c.jsx(st,{title:ne,showBackButton:!0,onBackButtonClicked:E,...l?{showCloseButton:!0,onClose:s}:{}}),c.jsxs(Hp,{children:[c.jsxs(Jp,{children:[c.jsx(Ue,{label:a("modal.dappConnect.validation.codeInputLabel"),helpText:a("modal.dappConnect.validation.codeInputHelp",{dappName:ne})}),c.jsx(Oe,{name:ze,control:C,rules:{validate:y},defaultValue:"",render:({field:{name:L,onBlur:j,onChange:P,value:M},fieldState:{error:z}})=>c.jsxs(c.Fragment,{children:[c.jsx(Ai,{mode:z?"critical":"default",name:L,disabled:u===N.LOADING||u===N.SUCCESS,onBlur:j,onChange:P,value:M??"",placeholder:a("modal.dappConnect.validation.codeInputPlaceholder"),adornmentText:m,onAdornmentClick:()=>w(M,P)}),c.jsx("div",{className:"mt-2",children:z?.message&&c.jsx(le,{variant:"critical",message:z.message})})]})})]}),c.jsx(J,{size:"lg",variant:"primary",className:"w-full",disabled:Ae,isLoading:u===N.LOADING,...(u===N.ERROR||u===N.INCORRECT_URI)&&{iconLeft:O.RELOAD},onClick:Ie,children:g}),u===N.SUCCESS&&c.jsx(zt,{children:c.jsx(le,{message:a("modal.dappConnect.validation.alertSuccess",{dappName:ne}),variant:"success"})}),u===N.INCORRECT_URI&&c.jsx(zt,{children:c.jsx(le,{message:a("modal.dappConnect.validation.alertCriticalQRcode",{dappName:ne}),variant:"critical"})}),u===N.ERROR&&c.jsx(zt,{children:c.jsx(le,{message:a("modal.dappConnect.validation.alertCriticalGeneral",{dappName:ne}),variant:"critical"})})]})]})},Hp=$.div.attrs({className:"py-6 px-4 xl:px-6 space-y-6"})``,Jp=$.div.attrs({className:"space-y-3"})``,zt=$.div.attrs({className:"mt-3 flex justify-center"})``,Yp=({onBackButtonClicked:i,onClose:e,actionIndex:t,selectedSession:s,selecteddApp:r,isOpen:n})=>{const{t:a}=V(),{network:o}=me(),{isDesktop:l}=xt(),{setValue:d}=re(),{addAction:p,removeAction:u}=Ee(),{actions:v,wcDisconnect:b}=bs(),y=A.useCallback(async()=>{d(`actions.${t}.name`,"wallet_connect_modal");for(const{action:h,index:g}of v.map((m,f)=>({action:m,index:f}))){const m=await On(h.params[0].to,o),f=t+(g+1);if(p({name:"wallet_connect_action"}),d(`actions.${f}.name`,"wallet_connect_action"),d(`actions.${f}.raw`,h.params[0]),d(`actions.${f}.contractAddress`,h.params[0].to),m.status==="1"&&m.result[0].ABI!=="Contract source code not verified"){d(`actions.${f}.verified`,!0),Tn(JSON.parse(m.result[0].ABI));const w=Pn(h.params[0].data);if(w){d(`actions.${f}.decoded`,!0),d(`actions.${f}.contractName`,m.result[0].ContractName),d(`actions.${f}.functionName`,w.name);const I=Bt(m.result[0].SourceCode,m.result[0].ContractName,JSON.parse(m.result[0].ABI)).find(R=>R.name===w.name),E=w.params.map(R=>({...R,notice:I?.inputs.find(B=>B.name===R.name&&B.type===R.type)?.notice}));h.params[0].value&&E.push(kn(a,h.params[0].value,o)),d(`actions.${f}.inputs`,[...E]),d(`actions.${t}.notice`,I?.notice)}else d(`actions.${f}.decoded`,!1),d(`actions.${f}.contractName`,m.result[0].ContractName),d(`actions.${f}.functionName`,Cs(h.method)),d(`actions.${f}.inputs`,Ss(h.params[0],o,a))}else d(`actions.${f}.decoded`,!1),d(`actions.${f}.verified`,!1),d(`actions.${f}.contractName`,h.params[0].to),d(`actions.${f}.functionName`,Cs(h.method)),d(`actions.${f}.inputs`,Ss(h.params[0],o,a))}u(t)},[t,v,p,o,u,d,a]);if(!n)return null;const x=r?.shortName||s.peer.metadata.name,C=s.peer.metadata.url,_=ki(C,s.peer.metadata.icons[0]);return c.jsxs($e,{isOpen:n,onClose:e,children:[c.jsx(st,{title:x,showBackButton:!0,onBackButtonClicked:i,...l?{showCloseButton:!0,onClose:e}:{}}),c.jsxs(Qp,{children:[c.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[c.jsx(Dn,{daoName:x,src:_,size:"medium"}),c.jsxs("div",{className:"flex items-center justify-center text-center font-semibold text-neutral-800",children:[c.jsx(Kt,{size:"sm",variant:"primary"}),c.jsx("p",{className:"ml-4",children:a("modal.dappConnect.detaildApp.spinnerLabel")})]}),c.jsx("p",{className:"text-center text-sm leading-normal text-neutral-500 xl:px-10",children:a("modal.dappConnect.detaildApp.desc",{dappName:x})}),v.length>0?c.jsx(As,{label:a("modal.dappConnect.detaildApp.amountActionsTag",{amountActions:v.length})}):c.jsx(As,{label:a("modal.dappConnect.detaildApp.noActionsTag")})]}),c.jsxs("div",{className:"space-y-3",children:[v.length>0?c.jsx(J,{onClick:y,variant:"primary",size:"md",className:"w-full",children:a("modal.dappConnect.detaildApp.ctaLabel",{amountActions:v.length})}):null,C&&c.jsx(J,{onClick:()=>window.open(C,"_blank"),variant:"tertiary",size:"md",className:"w-full",children:a("modal.dappConnect.ctaOpenDapp",{dappName:x})}),c.jsx(J,{onClick:async()=>{await b(s.topic),i()},variant:"tertiary",size:"md",className:"w-full",children:a("modal.dappConnect.ctaDisconnectDapp",{dappName:x})})]})]})]})},Qp=$.div.attrs({className:"py-6 px-4 xl:px-6 space-y-6"})``,Xp=({actionIndex:i})=>{const{removeAction:e}=Ee(),{resetField:t}=re(),s=zp(),[r,n]=A.useState(!1),[a,o]=A.useState(!1),[l,d]=A.useState(),[p,u]=A.useState(),v=!a&&!r,b=A.useCallback(()=>{e(i)},[i,e]),y=A.useCallback(g=>{u(g),n(!0)},[]),x=A.useCallback((g,m)=>{d(g),u(m),o(!0)},[]),C=A.useCallback(()=>{e(i),t(ze),n(!1)},[i,e,t]),_=A.useCallback(()=>{t(ze),n(!1),o(!1)},[t]),h=A.useCallback(g=>{t(ze),d(g),n(!1),o(!0)},[t]);return A.useEffect(()=>{if(!l)return;s.sessions.find(({topic:m})=>m===l.topic)!=null||(d(void 0),o(!1))},[s.sessions,l]),!v&&!r&&!a?c.jsx($e,{isOpen:!0,children:c.jsx("div",{className:"pb-36",children:c.jsx(Ln,{})})}):c.jsxs(Bp,{value:s,children:[c.jsx(Kp,{isOpen:v,onConnectNewdApp:y,onSelectExistingdApp:x,onClose:b}),c.jsx(Gp,{isOpen:r,onConnectionSuccess:h,onBackButtonClicked:_,onClose:C,selecteddApp:p}),l&&c.jsx(Yp,{onBackButtonClicked:_,onClose:C,isOpen:a,selecteddApp:p,selectedSession:l,actionIndex:i})]})},Zp=({actionIndex:i,allowRemove:e=!0})=>{const{t}=V(),{removeAction:s}=Ee(),r=xe({name:`actions.${i}`}),{alert:n}=Fe(),{network:a}=me(),[o,l]=A.useState(!0);A.useEffect(()=>{(async()=>{const u=await Mn(r,a);l(u)})()},[r,a]);const d=(()=>{const p=[];return e&&p.push(c.jsx(ke.Item,{onClick:()=>{s(i),n(t("alert.chip.removedAction"))},children:t("labels.removeEntireAction")},0)),p})();if(r){const p=r.inputs&&r.inputs.length>0;return c.jsx(Bi,{type:"action-builder",methodName:r.functionName,dropdownItems:d,smartContractName:r.contractName,verified:!0,methodDescription:r.notice,emptyItem:!p,children:p&&c.jsx(zi,{className:"space-y-6 rounded-b-xl",children:c.jsxs("div",{className:"space-y-4 pb-3",children:[r.inputs.filter(u=>u.type).map((u,v)=>c.jsxs("div",{children:[c.jsxs("div",{className:"text-base font-semibold capitalize leading-normal text-neutral-800",children:[u.name,c.jsxs("span",{className:"ml-1 text-sm normal-case leading-normal",children:["(",u.type,")"]})]}),c.jsx("div",{className:"mb-3 mt-1",children:c.jsx("span",{className:"text-neutral-600 ft-text-sm",children:u.notice})}),c.jsx(sa,{input:u,functionName:r.name,formHandleName:`actions.${i}.inputs.${v}.value`,isValid:o},u.name)]},u.name)),!o&&c.jsx(le,{message:t("newProposal.configureActions.alertCritical"),variant:"critical"})]})})})}return null},eg=({actionIndex:i,allowRemove:e=!0})=>{const{t}=V(),{alert:s}=Fe(),{watch:r}=re(),n=r(`actions.${i}`),{removeAction:a}=Ee(),o=(()=>{const l=[];return e&&l.push(c.jsx(ke.Item,{onClick:()=>{a(i),s(t("alert.chip.removedAction"))},children:t("labels.removeEntireAction")},0)),l})();return n?c.jsx(ia,{status:"default",type:"action-builder",action:n,methodActions:o}):null},tg=({actionIndex:i})=>{const{t:e}=V(),{open:t}=Et(),{network:s}=me(),{address:r}=is(),{api:n}=rs(),{setSelectedActionIndex:a}=Ee(),{alert:o}=Fe(),{data:l}=St(),d=ns(),{control:p,getValues:u,trigger:v,resetField:b,setFocus:y,setValue:x}=re(),{errors:C,dirtyFields:_}=as({control:p}),[h,g,m,f,w,I]=xe({name:[`actions.${i}.name`,`actions.${i}.from`,`actions.${i}.tokenAddress`,`actions.${i}.isCustomToken`,`actions.${i}.tokenBalance`,`actions.${i}.tokenSymbol`]}),E=H[s].nativeCurrency;A.useEffect(()=>{f&&y(`actions.${i}.tokenAddress`),g===""&&l?.address&&x(`actions.${i}.from`,l?.address)},[r,l?.address,g,i,f,y,x,E]),A.useEffect(()=>{h||x(`actions.${i}.name`,"withdraw_assets")},[i,h,x]),A.useEffect(()=>{if(!r||!f||!m)return;const j=async()=>{if(C.tokenAddress!==void 0){_.amount&&v([`actions.${i}.amount`,`actions.${i}.tokenSymbol`]);return}try{const P=Promise.all([Is(m)?n.getBalance(l?.address):Gn(m,l?.address,n,E),d({address:m,network:s,symbol:I}),Gt(m,n,E)]),[M,z,Y]=await P;z&&(x(`actions.${i}.tokenName`,z.name),x(`actions.${i}.tokenSymbol`,z.symbol),x(`actions.${i}.tokenImgUrl`,z.imgUrl),x(`actions.${i}.tokenPrice`,z.price)),!z&&Y&&(x(`actions.${i}.tokenName`,Y.name),x(`actions.${i}.tokenSymbol`,Y.symbol)),x(`actions.${i}.tokenDecimals`,Number(Y.decimals)),x(`actions.${i}.tokenBalance`,M)}catch(P){console.error(P)}_.amount&&v([`actions.${i}.amount`,`actions.${i}.tokenSymbol`])};l?.address&&j()},[r,_.amount,C.tokenAddress,i,f,n,x,d,m,v,s,l?.address,E,I]);const R=A.useCallback(j=>{if(!w||j==="")return null;if(Number(j)>Number(w))return c.jsx(le,{message:e("warnings.amountGtDaoToken"),variant:"warning"})},[w,e]),B=A.useCallback(j=>{w&&(j(w),o(e("alert.chip.max")))},[o,e,w]),Ae=A.useCallback((j,P)=>{j?(P(""),o(e("alert.chip.inputCleared"))):wt(j,P,o)},[o,e]),Ie=A.useCallback(async j=>{if(Is(j))return!0;const P=await Un(j,n);return P!==!0&&(b(`actions.${i}.tokenName`),b(`actions.${i}.tokenImgUrl`),b(`actions.${i}.tokenSymbol`),b(`actions.${i}.tokenBalance`)),P},[i,n,b]),ne=A.useCallback(async j=>{const P=u(`actions.${i}.tokenAddress`);if(P==="")return e("errors.noTokenSelected");if(C.tokenAddress)return e("errors.amountWithInvalidToken");try{const{decimals:M}=await Gt(P,n,E);return qn(j,M)}catch(M){return console.error("Error validating amount",M),e("errors.defaultAmountValidationError")}},[C.tokenAddress,u,i,n,e,E]),L=A.useCallback(async j=>{const P=new Vn(n,j.address,j.ensName);return P.address===l?.address||P.ensName===zn(l?.ensDomain)?"Cant withdraw to your own address":Bn(P,e("errors.required.recipient"),e)},[l?.address,l?.ensDomain,n,e]);return c.jsxs(c.Fragment,{children:[c.jsxs(lt,{children:[c.jsx(Ue,{label:e("labels.recipient"),helpText:e("newWithdraw.configureWithdraw.toSubtitle")}),c.jsx(Oe,{name:`actions.${i}.to`,control:p,defaultValue:{address:"",ensName:""},rules:{validate:L},render:({field:{name:j,onBlur:P,onChange:M,value:z},fieldState:{error:Y}})=>c.jsx(Kn,{name:j,state:Y&&"critical",value:z,onBlur:P,onChange:M,error:Y?.message,resolveLabels:"enabled"})})]}),c.jsxs(lt,{children:[c.jsx(Ue,{label:e("labels.token"),helpText:e("newWithdraw.configureWithdraw.tokenSubtitle")}),c.jsx(Oe,{name:`actions.${i}.tokenSymbol`,control:p,defaultValue:"",rules:{required:e("errors.required.token")},render:({field:{name:j,value:P},fieldState:{error:M}})=>c.jsxs(c.Fragment,{children:[c.jsx(Wn,{name:j,mode:M?"critical":"default",value:P,onClick:()=>{a(i),t("token")},placeholder:e("placeHolders.selectToken")}),M?.message&&c.jsx(le,{message:M.message,variant:"critical"})]})})]}),f&&c.jsxs(lt,{children:[c.jsx(Ue,{label:e("labels.address"),helpText:e("newDeposit.contractAddressSubtitle")}),c.jsx(Oe,{name:`actions.${i}.tokenAddress`,control:p,defaultValue:"",rules:{required:e("errors.required.tokenAddress"),validate:Ie},render:({field:{name:j,onBlur:P,onChange:M,value:z,ref:Y},fieldState:{error:Ge}})=>c.jsxs(c.Fragment,{children:[c.jsx(Di,{mode:Ge?"critical":"default",ref:Y,name:j,value:z,onBlur:P,onChange:M,adornmentText:e(z?"labels.clear":"labels.paste"),onAdornmentClick:()=>Ae(z,M)}),Ge?.message&&c.jsx(le,{message:Ge.message,variant:"critical"})]})})]}),c.jsxs(lt,{children:[c.jsx(Ue,{label:e("labels.amount"),helpText:e("newWithdraw.configureWithdraw.amountSubtitle")}),c.jsx(Oe,{name:`actions.${i}.amount`,control:p,defaultValue:"",rules:{required:e("errors.required.amount"),validate:ne},render:({field:{name:j,onBlur:P,onChange:M,value:z},fieldState:{error:Y}})=>c.jsxs(c.Fragment,{children:[c.jsx(ig,{mode:Y?"critical":"default",name:j,type:"number",value:z,placeholder:"0",onBlur:P,onChange:M,adornmentText:e("labels.max"),onAdornmentClick:()=>B(M)}),c.jsxs("div",{className:"flex items-start justify-between",children:[c.jsxs("div",{className:"space-y-2",children:[Y?.message&&c.jsx(le,{message:Y.message,variant:"critical"}),R(z)]}),w&&c.jsx(sg,{children:`${e("labels.maxBalance")}: ${w} ${I}`})]})]})})]})]})},lt=$.div.attrs({className:"space-y-3"})``,sg=$.p.attrs({className:"flex-1 px-2 text-xs leading-normal text-right text-neutral-600"})``,ig=$(Di)`
  ::-webkit-inner-spin-button,
  ::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  -moz-appearance: textfield;
`,rg=({actionIndex:i,allowRemove:e=!0})=>{const{t}=V(),{removeAction:s,duplicateAction:r}=Ee(),{setValue:n,clearErrors:a,resetField:o,control:l}=re(),{alert:d}=Fe(),{network:p}=me(),[u,v]=xe({name:[`actions.${i}.tokenAddress`,`actions.${i}.tokenSymbol`],control:l}),b=()=>{a(`actions.${i}`),o(`actions.${i}`),n(`actions.${i}`,{to:{address:"",ensName:""},amount:"",tokenAddress:"",tokenSymbol:""}),d(t("alert.chip.resetAction"))},y=C=>{s(C)},x=(()=>{const C=[c.jsx(ke.Item,{onClick:()=>{r(i),d(t("alert.chip.duplicateAction"))},children:t("labels.duplicateAction")},0),c.jsx(ke.Item,{onClick:b,children:t("labels.resetAction")},1)];return e&&C.push(c.jsx(ke.Item,{onClick:()=>{y(i),d(t("alert.chip.removedAction"))},children:t("labels.removeEntireAction")},C.length)),C})();return c.jsx(Bi,{verified:!0,type:"action-builder",methodName:t("TransferModal.item2Title"),dropdownItems:x,smartContractName:v||void 0,smartContractAddress:u,blockExplorerLink:u?`${H[p].explorer}token/${u}`:void 0,methodDescription:t("AddActionModal.withdrawAssetsActionSubtitle"),children:c.jsx(zi,{className:"space-y-6 rounded-b-xl py-6",children:c.jsx(tg,{actionIndex:i})})})},ng=({name:i,actionIndex:e,allowRemove:t=!0})=>{const{data:s}=St(),r=s?.plugins?.[0]?.instanceAddress,n=s?.plugins?.[0]?.id,{data:a}=Li({pluginAddress:r,pluginType:n}),{data:o}=Hn(r,n,{enabled:["add_address","remove_address"].includes(i),page:0}),l=a;switch(i){case"withdraw_assets":return c.jsx(rg,{actionIndex:e,allowRemove:t});case"mint_tokens":return c.jsx(fa,{actionIndex:e,allowRemove:t});case"external_contract_modal":return c.jsx(oo,{actionIndex:e});case"external_contract_action":return c.jsx(Zp,{actionIndex:e,allowRemove:t});case"modify_token_voting_settings":return c.jsx(wa,{purpose:"It serves as a placeholder for not yet implemented external contract interaction component"});case"add_address":return c.jsx(ma,{actionIndex:e,currentDaoMembers:o?.members,allowRemove:t});case"remove_address":return c.jsx(ba,{actionIndex:e,currentDaoMembers:o?.members,allowRemove:t});case"modify_multisig_voting_settings":return c.jsx(ya,{actionIndex:e,currentDaoMembers:o?.members,currentMinimumApproval:l?.minApprovals});case"wallet_connect_modal":return c.jsx(Xp,{actionIndex:e});case"wallet_connect_action":return c.jsx(eg,{actionIndex:e,allowRemove:t});default:throw Error("Action not found")}},ag=({allowEmpty:i=!0})=>{const{data:e}=St(),{network:t}=me(),{selectedActionIndex:s,actions:r}=Ee(),{data:n}=na(e?.address??""),{setValue:a,resetField:o,clearErrors:l}=re(),d=ns(),p=u=>{if(a(`actions.${s}.tokenSymbol`,u.symbol),u.address===""){a(`actions.${s}.isCustomToken`,!0),o(`actions.${s}.tokenName`),o(`actions.${s}.tokenImgUrl`),o(`actions.${s}.tokenAddress`),o(`actions.${s}.tokenBalance`),l(`actions.${s}.amount`);return}l([`actions.${s}.tokenAddress`,`actions.${s}.tokenSymbol`]),a(`actions.${s}.isCustomToken`,!1),a(`actions.${s}.tokenName`,u.name),a(`actions.${s}.tokenImgUrl`,u.imgUrl),a(`actions.${s}.tokenAddress`,u.address),a(`actions.${s}.tokenDecimals`,u.decimals),a(`actions.${s}.tokenBalance`,_i(u.count,u.decimals)),d({address:u.address,network:t,symbol:u.symbol}).then(v=>{a(`actions.${s}.tokenPrice`,v?.price)})};return c.jsxs(c.Fragment,{children:[r?.map((u,v)=>c.jsx(ng,{name:u?.name,actionIndex:v,allowRemove:r.length<=1?i:!0},v)),c.jsx(fo,{isWallet:!1,onTokenSelect:p,tokenBalances:n||[]})]})},og=({actions:i})=>{const{dao:e}=Be(),{isOpen:t,close:s}=Et("addAction"),{actions:r,addAction:n}=Ee(),{t:a}=V();return c.jsx($e,{isOpen:t,onClose:s,title:a("AddActionModal.title"),children:c.jsx(cg,{children:i.map(o=>c.jsx(tt,{title:o.title,subtitle:o.subtitle,mode:!o.isReuseable&&r.some(l=>l.name===o.type)?"disabled":"default",iconRight:c.jsx(oe,{icon:O.CHEVRON_RIGHT}),onClick:()=>{ve("newProposal_action_selected",{dao_address:e,action:o.type}),n({name:o.type}),s()}},o.type))})})},cg=$.div.attrs({className:"space-y-3 p-6"})``;function lg(i){const{data:e,error:t,isLoading:s}=Jn(i),{id:r}=e?.plugins[0]||{},n=r==="multisig.plugin.dao.eth",{data:a,isLoading:o}=Li({pluginAddress:e?.plugins[0].instanceAddress,pluginType:e?.plugins[0].id}),l=s||o,[d,p]=A.useState(!1),{api:u}=rs(),{data:v}=Yn(e?.plugins[0].instanceAddress||"");A.useEffect(()=>{async function h(){const g=await Xn(v?.address||"",u);p(g?.toLocaleLowerCase()===e?.address)}if(!l){if(a&&Qn(a)){p(a.hasGovernanceEnabled);return}h()}},[i,e,e?.address,v?.address,l,u,d,a]);const{t:b}=V(),y=[{type:"withdraw_assets",title:b("TransferModal.item2Title"),subtitle:b("AddActionModal.withdrawAssetsSubtitle"),isReuseable:!0},{type:"wallet_connect_modal",title:b("AddActionModal.connectdAppsTitle"),subtitle:b("AddActionModal.connectdAppsSubtitle"),isReuseable:!0,isDisabled:Pi.getValue("VITE_FEATURE_FLAG_DAO_WALLET_CONNECT")==="false"},{type:"external_contract_modal",title:b("AddActionModal.externalContract"),subtitle:b("AddActionModal.externalContractSubtitle"),isReuseable:!0}],x=[{type:"add_address",title:b("AddActionModal.addAddresses"),subtitle:b("AddActionModal.addAddressesSubtitle")},{type:"remove_address",title:b("AddActionModal.removeAddresses"),subtitle:b("AddActionModal.removeAddressesSubtitle")}].concat(y),C=d?[{type:"mint_tokens",title:b("AddActionModal.mintTokens"),subtitle:b("AddActionModal.mintTokensSubtitle")}].concat(y):y;return{data:(n?x:C).filter(({isDisabled:h})=>h!==!0),isLoading:l,error:t}}const Mg=({label:i=dt.t("newProposal.configureActions.yesOption")||"",initialActions:e=[],whitelistedActions:t,hideAlert:s=!1,addNewActionLabel:r=dt.t("newProposal.configureActions.addAction")||"",onAddNewActionClick:n,addExtraActionLabel:a=dt.t("newProposal.configureActions.addAction")||"",onAddExtraActionClick:o,allowEmpty:l=!0})=>{const{dao:d}=Be(),{t:p}=V(),{open:u}=Et(),{actions:v,addAction:b}=Ee(),{data:y}=lg(d??""),x=A.useMemo(()=>t?y.filter(h=>t.includes(h.type)):y,[y,t]);A.useEffect(()=>{const h=v.map(g=>g.name);e.forEach(g=>{h.includes(g)||b({name:g},!1)})},[v,b,e]);const C=()=>{n?n():u("addAction")},_=()=>{ve("newProposal_addAction_clicked",{dao_address:d}),o?o():u("addAction")};return c.jsxs(dg,{children:[i&&c.jsx(Ue,{label:i,isOptional:!0}),v.length?c.jsxs(hg,{children:[c.jsx(ag,{allowEmpty:l}),c.jsx(J,{variant:"tertiary",size:"lg",iconLeft:O.PLUS,onClick:_,className:"mt-4 w-full md:w-max",children:a})]}):c.jsxs(c.Fragment,{children:[c.jsx(Zn,{objectIllustration:{object:"SMART_CONTRACT"},heading:p("newProposal.configureActions.addFirstAction"),description:p("newProposal.configureActions.addFirstActionSubtitle"),secondaryButton:{label:r,onClick:C,iconLeft:O.PLUS}}),!s&&c.jsx(le,{message:p("newProposal.configureActions.actionsInfo"),variant:"info"})]}),c.jsx(og,{actions:x})]})},dg=$.div.attrs({className:"space-y-3"})``,hg=$.div.attrs({className:"space-y-4"})``;export{Mg as C};
